//
// File generated by HDevelop for HALCON/.NET (C#) Version 13.0.1.1
//

using HalconDotNet;
using System;
using System.Runtime.InteropServices;

public partial class HDevelopExportV2_0_16
{

  // Procedures 
  // Chapter: Develop
  // Short Description: Open a new graphics window that preserves the aspect ratio of the given image. 
  public void dev_open_window_fit_image (HObject ho_Image, HTuple hv_Row, HTuple hv_Column, 
      HTuple hv_WidthLimit, HTuple hv_HeightLimit, out HTuple hv_WindowHandle)
  {
    // Local iconic variables 

    // Local control variables 

    HTuple hv_MinWidth = new HTuple(), hv_MaxWidth = new HTuple();
    HTuple hv_MinHeight = new HTuple(), hv_MaxHeight = new HTuple();
    HTuple hv_ResizeFactor = null, hv_ImageWidth = null, hv_ImageHeight = null;
    HTuple hv_TempWidth = null, hv_TempHeight = null, hv_WindowWidth = null;
    HTuple hv_WindowHeight = null;
    // Initialize local and output iconic variables 
    //This procedure opens a new graphics window and adjusts the size
    //such that it fits into the limits specified by WidthLimit
    //and HeightLimit, but also maintains the correct image aspect ratio.
    //
    //If it is impossible to match the minimum and maximum extent requirements
    //at the same time (f.e. if the image is very long but narrow),
    //the maximum value gets a higher priority,
    //
    //Parse input tuple WidthLimit
    if ((int)((new HTuple((new HTuple(hv_WidthLimit.TupleLength())).TupleEqual(0))).TupleOr(
        new HTuple(hv_WidthLimit.TupleLess(0)))) != 0)
    {
      hv_MinWidth = 500;
      hv_MaxWidth = 800;
    }
    else if ((int)(new HTuple((new HTuple(hv_WidthLimit.TupleLength())).TupleEqual(
        1))) != 0)
    {
      hv_MinWidth = 0;
      hv_MaxWidth = hv_WidthLimit.Clone();
    }
    else
    {
      hv_MinWidth = hv_WidthLimit.TupleSelect(0);
      hv_MaxWidth = hv_WidthLimit.TupleSelect(1);
    }
    //Parse input tuple HeightLimit
    if ((int)((new HTuple((new HTuple(hv_HeightLimit.TupleLength())).TupleEqual(0))).TupleOr(
        new HTuple(hv_HeightLimit.TupleLess(0)))) != 0)
    {
      hv_MinHeight = 400;
      hv_MaxHeight = 600;
    }
    else if ((int)(new HTuple((new HTuple(hv_HeightLimit.TupleLength())).TupleEqual(
        1))) != 0)
    {
      hv_MinHeight = 0;
      hv_MaxHeight = hv_HeightLimit.Clone();
    }
    else
    {
      hv_MinHeight = hv_HeightLimit.TupleSelect(0);
      hv_MaxHeight = hv_HeightLimit.TupleSelect(1);
    }
    //
    //Test, if window size has to be changed.
    hv_ResizeFactor = 1;
    HOperatorSet.GetImageSize(ho_Image, out hv_ImageWidth, out hv_ImageHeight);
    //First, expand window to the minimum extents (if necessary).
    if ((int)((new HTuple(hv_MinWidth.TupleGreater(hv_ImageWidth))).TupleOr(new HTuple(hv_MinHeight.TupleGreater(
        hv_ImageHeight)))) != 0)
    {
      hv_ResizeFactor = (((((hv_MinWidth.TupleReal())/hv_ImageWidth)).TupleConcat(
          (hv_MinHeight.TupleReal())/hv_ImageHeight))).TupleMax();
    }
    hv_TempWidth = hv_ImageWidth*hv_ResizeFactor;
    hv_TempHeight = hv_ImageHeight*hv_ResizeFactor;
    //Then, shrink window to maximum extents (if necessary).
    if ((int)((new HTuple(hv_MaxWidth.TupleLess(hv_TempWidth))).TupleOr(new HTuple(hv_MaxHeight.TupleLess(
        hv_TempHeight)))) != 0)
    {
      hv_ResizeFactor = hv_ResizeFactor*((((((hv_MaxWidth.TupleReal())/hv_TempWidth)).TupleConcat(
          (hv_MaxHeight.TupleReal())/hv_TempHeight))).TupleMin());
    }
    hv_WindowWidth = hv_ImageWidth*hv_ResizeFactor;
    hv_WindowHeight = hv_ImageHeight*hv_ResizeFactor;
    //Resize window
    HOperatorSet.SetWindowAttr("background_color","black");
    HOperatorSet.OpenWindow(hv_Row,hv_Column,hv_WindowWidth,hv_WindowHeight,0,"buffer","",out hv_WindowHandle);//visible
        HDevWindowStack.Push(hv_WindowHandle);
    if (HDevWindowStack.IsOpen())
    {
      HOperatorSet.SetPart(HDevWindowStack.GetActive(), 0, 0, hv_ImageHeight-1, hv_ImageWidth-1);
    }

    return;
  }

  // Chapter: Graphics / Text
  // Short Description: This procedure writes a text message. 
  public void disp_message (HTuple hv_WindowHandle, HTuple hv_String, HTuple hv_CoordSystem, 
      HTuple hv_Row, HTuple hv_Column, HTuple hv_Color, HTuple hv_Box)
  {



    // Local iconic variables 

    // Local control variables 

    HTuple hv_GenParamName = null, hv_GenParamValue = null;
    HTuple   hv_Color_COPY_INP_TMP = hv_Color.Clone();
    HTuple   hv_Column_COPY_INP_TMP = hv_Column.Clone();
    HTuple   hv_CoordSystem_COPY_INP_TMP = hv_CoordSystem.Clone();
    HTuple   hv_Row_COPY_INP_TMP = hv_Row.Clone();

    // Initialize local and output iconic variables 
    //This procedure displays text in a graphics window.
    //
    //Input parameters:
    //WindowHandle: The WindowHandle of the graphics window, where
    //   the message should be displayed
    //String: A tuple of strings containing the text message to be displayed
    //CoordSystem: If set to 'window', the text position is given
    //   with respect to the window coordinate system.
    //   If set to 'image', image coordinates are used.
    //   (This may be useful in zoomed images.)
    //Row: The row coordinate of the desired text position
    //   A tuple of values is allowed to display text at different
    //   positions.
    //Column: The column coordinate of the desired text position
    //   A tuple of values is allowed to display text at different
    //   positions.
    //Color: defines the color of the text as string.
    //   If set to [], '' or 'auto' the currently set color is used.
    //   If a tuple of strings is passed, the colors are used cyclically...
    //   - if |Row| == |Column| == 1: for each new textline
    //   = else for each text position.
    //Box: If Box[0] is set to 'true', the text is written within an orange box.
    //     If set to' false', no box is displayed.
    //     If set to a color string (e.g. 'white', '#FF00CC', etc.),
    //       the text is written in a box of that color.
    //     An optional second value for Box (Box[1]) controls if a shadow is displayed:
    //       'true' -> display a shadow in a default color
    //       'false' -> display no shadow
    //       otherwise -> use given string as color string for the shadow color
    //
    //It is possible to display multiple text strings in a single call.
    //In this case, some restrictions apply:
    //- Multiple text positions can be defined by specifying a tuple
    //  with multiple Row and/or Column coordinates, i.e.:
    //  - |Row| == n, |Column| == n
    //  - |Row| == n, |Column| == 1
    //  - |Row| == 1, |Column| == n
    //- If |Row| == |Column| == 1,
    //  each element of String is display in a new textline.
    //- If multiple positions or specified, the number of Strings
    //  must match the number of positions, i.e.:
    //  - Either |String| == n (each string is displayed at the
    //                          corresponding position),
    //  - or     |String| == 1 (The string is displayed n times).
    //
    //
    //Convert the parameters for disp_text.
    if ((int)((new HTuple(hv_Row_COPY_INP_TMP.TupleEqual(new HTuple()))).TupleOr(
        new HTuple(hv_Column_COPY_INP_TMP.TupleEqual(new HTuple())))) != 0)
    {

      return;
    }
    if ((int)(new HTuple(hv_Row_COPY_INP_TMP.TupleEqual(-1))) != 0)
    {
      hv_Row_COPY_INP_TMP = 12;
    }
    if ((int)(new HTuple(hv_Column_COPY_INP_TMP.TupleEqual(-1))) != 0)
    {
      hv_Column_COPY_INP_TMP = 12;
    }
    //
    //Convert the parameter Box to generic parameters.
    hv_GenParamName = new HTuple();
    hv_GenParamValue = new HTuple();
    if ((int)(new HTuple((new HTuple(hv_Box.TupleLength())).TupleGreater(0))) != 0)
    {
      if ((int)(new HTuple(((hv_Box.TupleSelect(0))).TupleEqual("false"))) != 0)
      {
        //Display no box
        hv_GenParamName = hv_GenParamName.TupleConcat("box");
        hv_GenParamValue = hv_GenParamValue.TupleConcat("false");
      }
      else if ((int)(new HTuple(((hv_Box.TupleSelect(0))).TupleNotEqual("true"))) != 0)
      {
        //Set a color other than the default.
        hv_GenParamName = hv_GenParamName.TupleConcat("box_color");
        hv_GenParamValue = hv_GenParamValue.TupleConcat(hv_Box.TupleSelect(0));
      }
    }
    if ((int)(new HTuple((new HTuple(hv_Box.TupleLength())).TupleGreater(1))) != 0)
    {
      if ((int)(new HTuple(((hv_Box.TupleSelect(1))).TupleEqual("false"))) != 0)
      {
        //Display no shadow.
        hv_GenParamName = hv_GenParamName.TupleConcat("shadow");
        hv_GenParamValue = hv_GenParamValue.TupleConcat("false");
      }
      else if ((int)(new HTuple(((hv_Box.TupleSelect(1))).TupleNotEqual("true"))) != 0)
      {
        //Set a shadow color other than the default.
        hv_GenParamName = hv_GenParamName.TupleConcat("shadow_color");
        hv_GenParamValue = hv_GenParamValue.TupleConcat(hv_Box.TupleSelect(1));
      }
    }
    //Restore default CoordSystem behavior.
    if ((int)(new HTuple(hv_CoordSystem_COPY_INP_TMP.TupleNotEqual("window"))) != 0)
    {
      hv_CoordSystem_COPY_INP_TMP = "image";
    }
    //
    if ((int)(new HTuple(hv_Color_COPY_INP_TMP.TupleEqual(""))) != 0)
    {
      //disp_text does not accept an empty string for Color.
      hv_Color_COPY_INP_TMP = new HTuple();
    }
    //
    /*
    HOperatorSet.DispText(hv_WindowHandle, hv_String, hv_CoordSystem_COPY_INP_TMP, 
        hv_Row_COPY_INP_TMP, hv_Column_COPY_INP_TMP, hv_Color_COPY_INP_TMP, hv_GenParamName, 
        hv_GenParamValue);
        */

    return;
  }

  // Chapter: File / Misc
  // Short Description: Parse a filename into directory, base filename, and extension 
  public void parse_filename (HTuple hv_FileName, out HTuple hv_BaseName, out HTuple hv_Extension, 
      out HTuple hv_Directory)
  {



    // Local control variables 

    HTuple hv_DirectoryTmp = null, hv_Substring = null;
    // Initialize local and output iconic variables 
    //This procedure gets a filename (with full path) as input
    //and returns the directory path, the base filename and the extension
    //in three different strings.
    //
    //In the output path the path separators will be replaced
    //by '/' in all cases.
    //
    //The procedure shows the possibilities of regular expressions in HALCON.
    //
    //Input parameters:
    //FileName: The input filename
    //
    //Output parameters:
    //BaseName: The filename without directory description and file extension
    //Extension: The file extension
    //Directory: The directory path
    //
    //Example:
    //basename('C:/images/part_01.png',...) returns
    //BaseName = 'part_01'
    //Extension = 'png'
    //Directory = 'C:\\images\\' (on Windows systems)
    //
    //Explanation of the regular expressions:
    //
    //'([^\\\\/]*?)(?:\\.[^.]*)?$':
    //To start at the end, the '$' matches the end of the string,
    //so it is best to read the expression from right to left.
    //The part in brackets (?:\\.[^.}*) denotes a non-capturing group.
    //That means, that this part is matched, but not captured
    //in contrast to the first bracketed group ([^\\\\/], see below.)
    //\\.[^.]* matches a dot '.' followed by as many non-dots as possible.
    //So (?:\\.[^.]*)? matches the file extension, if any.
    //The '?' at the end assures, that even if no extension exists,
    //a correct match is returned.
    //The first part in brackets ([^\\\\/]*?) is a capture group,
    //which means, that if a match is found, only the part in
    //brackets is returned as a result.
    //Because both HDevelop strings and regular expressions need a '\\'
    //to describe a backslash, inside regular expressions within HDevelop
    //a backslash has to be written as '\\\\'.
    //[^\\\\/] matches any character but a slash or backslash ('\\' in HDevelop)
    //[^\\\\/]*? matches a string od 0..n characters (except '/' or '\\')
    //where the '?' after the '*' switches the greediness off,
    //that means, that the shortest possible match is returned.
    //This option is necessary to cut off the extension
    //but only if (?:\\.[^.]*)? is able to match one.
    //To summarize, the regular expression matches that part of
    //the input string, that follows after the last '/' or '\\' and
    //cuts off the extension (if any) after the last '.'.
    //
    //'\\.([^.]*)$':
    //This matches everything after the last '.' of the input string.
    //Because ([^.]) is a capturing group,
    //only the part after the dot is returned.
    //
    //'.*[\\\\/]':
    //This matches the longest substring with a '/' or a '\\' at the end.
    //
    HOperatorSet.TupleRegexpMatch(hv_FileName, ".*[\\\\/]", out hv_DirectoryTmp);
        /*
    HOperatorSet.TupleSubstr(hv_FileName, hv_DirectoryTmp.TupleStrlen(), (hv_FileName.TupleStrlen()
        )-1, out hv_Substring);
        */
    HOperatorSet.TupleRegexpMatch(hv_Substring, "([^\\\\/]*?)(?:\\.[^.]*)?$", out hv_BaseName);
    HOperatorSet.TupleRegexpMatch(hv_Substring, "\\.([^.]*)$", out hv_Extension);
    //
    //
    //Finally all found backslashes ('\\') are converted
    //to a slash to get consistent paths
    HOperatorSet.TupleRegexpReplace(hv_DirectoryTmp, (new HTuple("\\\\")).TupleConcat(
        "replace_all"), "/", out hv_Directory);

    return;
  }

  // Local procedures 
  public void Cartridge_Edge_Insp_UD (HObject ho_Image, HTuple hv_WindowHandle, HTuple hv_t, 
      HTuple hv_Row, HTuple hv_Column, HTuple hv_Transition, HTuple hv_Select, HTuple hv_RoiWidthLen2, 
      out HTuple hv_Row_Result, out HTuple hv_Column_Result)
  {




    // Local iconic variables 

    // Local control variables 

    HTuple hv_tuple = null, hv_i = null, hv_LineRowStart = new HTuple();
    HTuple hv_LineColumnStart = new HTuple(), hv_LineRowEnd = new HTuple();
    HTuple hv_LineColumnEnd = new HTuple(), hv_AmpThreshold = new HTuple();
    HTuple hv_Sigma = new HTuple(), hv_Distance_Measure_01_0 = new HTuple();
    // Initialize local and output iconic variables 
    hv_Row_Result = new HTuple();
    hv_Column_Result = new HTuple();
    hv_tuple = new HTuple();
    for (hv_i=30; (int)hv_i>=30; hv_i = (int)hv_i + -5)
    {


      //**************************注意这个地方的修改***************************************
      hv_LineRowStart = hv_Row-hv_t;
      hv_LineColumnStart = hv_Column.Clone();
      hv_LineRowEnd = hv_Row+hv_t;
      hv_LineColumnEnd = hv_Column.Clone();
      //**********************************************************************************

      if (HDevWindowStack.IsOpen())
      {
        HOperatorSet.DispObj(ho_Image, HDevWindowStack.GetActive());
      }
      HOperatorSet.DispLine(hv_WindowHandle, hv_LineRowStart, hv_LineColumnStart, 
          hv_LineRowEnd, hv_LineColumnEnd);


      //参数
      //measure pos threshold
      hv_AmpThreshold = hv_i.Clone();
      //measure pos ROiLen2
      //RoiWidthLen2 := 25
      //measure pos sigma
      hv_Sigma = 1;
      //**********Transition有三种模式： 'all', 'negative', 'positive'  ***************
      //Transition := 'all'
      //**********Select有三种模式： 'all', 'first', 'last'  ****************
      //Select := 'all'
      LineFindPoints(ho_Image, hv_LineRowStart, hv_LineRowEnd, hv_LineColumnStart, 
          hv_LineColumnEnd, hv_RoiWidthLen2, hv_Sigma, hv_AmpThreshold, hv_Select, 
          hv_Transition, hv_WindowHandle, out hv_Row_Result, out hv_Column_Result, 
          out hv_Distance_Measure_01_0);

      if ((int)(new HTuple((new HTuple(hv_Row_Result.TupleLength())).TupleGreater(
          0))) != 0)
      {

        hv_tuple = hv_tuple.TupleConcat(hv_Row_Result);
        if ((int)(new HTuple(hv_Select.TupleEqual("first"))) != 0)
        {
          HOperatorSet.TupleMin(hv_tuple, out hv_Row_Result);
        }
        else
        {
          HOperatorSet.TupleMax(hv_tuple, out hv_Row_Result);
        }


      }



    }


    return;


  }

  public void Empty_Tray_Segmentation_for_All (HObject ho_Image, HTuple hv_WindowHandle, 
      HTuple hv_InterFace, out HTuple hv_Empty_Main_InterFace)
  {




    // Stack for temporary objects 
    HObject[] OTemp = new HObject[20];

    // Local iconic variables 

    HObject ho_Rectangle, ho_ImageReduced, ho_Region;
    HObject ho_ConnectedRegions, ho_SelectedRegions, ho_RegionUnion;
    HObject ho_Rectangle2, ho_Rectangle_V, ho_Rectangle_H, ho_Rectangle1;

    // Local copy input parameter variables 
    HObject ho_Image_COPY_INP_TMP;
    ho_Image_COPY_INP_TMP = ho_Image.CopyObj(1,-1);



    // Local control variables 

    HTuple hv_Row1 = null, hv_Column1 = null, hv_Row2 = null;
    HTuple hv_Column2 = null, hv_Row0 = null, hv_Column0 = null;
    HTuple hv_Phi = null, hv_Length1 = null, hv_Length2 = null;
    HTuple hv_PI = null, hv_Phi1 = new HTuple(), hv_Row11 = null;
    HTuple hv_Column11 = null, hv_Row21 = null, hv_Column21 = null;
    HTuple hv_Transition = null, hv_Select = null, hv_t = null;
    HTuple hv_Row = null, hv_Column = null, hv_Row_Result = null;
    HTuple hv_Column_Result = null, hv_Dis_Col_R3 = null, hv_Dis_Col_L3 = null;
    HTuple hv_Dis_Col_R2 = null, hv_Dis_Row_D1 = null, hv_Dis_Row_Protrusion1 = null;
    HTuple hv_Dis_Row_Connected_area_U1 = null, hv_Dis_Row_Connected_area_D1 = null;
    HTuple hv_Dis_Row_Connected_area_U2 = null;
    HTuple   hv_InterFace_COPY_INP_TMP = hv_InterFace.Clone();

    // Initialize local and output iconic variables 
    HOperatorSet.GenEmptyObj(out ho_Rectangle);
    HOperatorSet.GenEmptyObj(out ho_ImageReduced);
    HOperatorSet.GenEmptyObj(out ho_Region);
    HOperatorSet.GenEmptyObj(out ho_ConnectedRegions);
    HOperatorSet.GenEmptyObj(out ho_SelectedRegions);
    HOperatorSet.GenEmptyObj(out ho_RegionUnion);
    HOperatorSet.GenEmptyObj(out ho_Rectangle2);
    HOperatorSet.GenEmptyObj(out ho_Rectangle_V);
    HOperatorSet.GenEmptyObj(out ho_Rectangle_H);
    HOperatorSet.GenEmptyObj(out ho_Rectangle1);
    try
    {


      ho_Rectangle.Dispose();
      HOperatorSet.GenRectangle1(out ho_Rectangle, (hv_InterFace_COPY_INP_TMP.TupleSelect(
          10))+150, (hv_InterFace_COPY_INP_TMP.TupleSelect(11))-50, (hv_InterFace_COPY_INP_TMP.TupleSelect(
          10))+350, (hv_InterFace_COPY_INP_TMP.TupleSelect(11))+30);
      ho_ImageReduced.Dispose();
      HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle, out ho_ImageReduced
          );
      ho_Region.Dispose();
      HOperatorSet.Threshold(ho_ImageReduced, out ho_Region, 100, 255);
      ho_ConnectedRegions.Dispose();
      HOperatorSet.Connection(ho_Region, out ho_ConnectedRegions);

      ho_SelectedRegions.Dispose();
      HOperatorSet.SelectShape(ho_ConnectedRegions, out ho_SelectedRegions, (new HTuple("area")).TupleConcat(
          "inner_radius"), "and", (new HTuple(800)).TupleConcat(2), (new HTuple(2500)).TupleConcat(
          8));
      ho_RegionUnion.Dispose();
      HOperatorSet.Union1(ho_SelectedRegions, out ho_RegionUnion);
      HOperatorSet.SmallestRectangle1(ho_RegionUnion, out hv_Row1, out hv_Column1, 
          out hv_Row2, out hv_Column2);
      ho_Rectangle2.Dispose();
      HOperatorSet.GenRectangle1(out ho_Rectangle2, hv_Row1, hv_Column1, hv_Row2, 
          hv_Column2);
      HOperatorSet.SmallestRectangle2(ho_RegionUnion, out hv_Row0, out hv_Column0, 
          out hv_Phi, out hv_Length1, out hv_Length2);
      //*由于料盒的旋转角度很小，默认长宽分别用Row2-Row1和Column2-Column1
      hv_PI = 1.5708*2;
      if ((int)(new HTuple(((hv_Row2-hv_Row1)).TupleLess(hv_Column2-hv_Column1))) != 0)
      {
        hv_Phi1 = hv_Phi.Clone();
      }
      else
      {
        if ((int)(new HTuple(hv_Phi.TupleGreater(1))) != 0)
        {
          hv_Phi1 = hv_Phi-(hv_PI/2);
        }
        else if ((int)(new HTuple(hv_Phi.TupleLess(-1))) != 0)
        {
          hv_Phi1 = hv_Phi+(hv_PI/2);
        }
        else
        {
          hv_Phi1 = hv_Phi.Clone();
        }
      }

      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.RotateImage(ho_Image_COPY_INP_TMP, out ExpTmpOutVar_0, (-hv_Phi1)*57.3, 
          "constant");
      ho_Image_COPY_INP_TMP.Dispose();
      ho_Image_COPY_INP_TMP = ExpTmpOutVar_0;
      }

      //*****************获取料盘边界参数********************
      ho_Rectangle_V.Dispose();
      HOperatorSet.GenRectangle1(out ho_Rectangle_V, (hv_InterFace_COPY_INP_TMP.TupleSelect(
          10))+150, (hv_InterFace_COPY_INP_TMP.TupleSelect(11))-50, (hv_InterFace_COPY_INP_TMP.TupleSelect(
          10))+350, (hv_InterFace_COPY_INP_TMP.TupleSelect(11))+30);
      ho_ImageReduced.Dispose();
      HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle_V, out ho_ImageReduced
          );
      ho_Region.Dispose();
      HOperatorSet.Threshold(ho_ImageReduced, out ho_Region, 220, 255);
      ho_ConnectedRegions.Dispose();
      HOperatorSet.Connection(ho_Region, out ho_ConnectedRegions);

      ho_SelectedRegions.Dispose();
      HOperatorSet.SelectShape(ho_ConnectedRegions, out ho_SelectedRegions, ((new HTuple("area")).TupleConcat(
          "inner_radius")).TupleConcat("height"), "and", ((new HTuple(800)).TupleConcat(
          2)).TupleConcat(180), ((new HTuple(2500)).TupleConcat(8)).TupleConcat(220));


      ho_RegionUnion.Dispose();
      HOperatorSet.Union1(ho_SelectedRegions, out ho_RegionUnion);
      HOperatorSet.SmallestRectangle1(ho_RegionUnion, out hv_Row1, out hv_Column1, 
          out hv_Row2, out hv_Column2);
      ho_Rectangle2.Dispose();
      HOperatorSet.GenRectangle1(out ho_Rectangle2, hv_Row1, hv_Column1, hv_Row2, 
          hv_Column2);

      if (hv_InterFace_COPY_INP_TMP == null)
        hv_InterFace_COPY_INP_TMP = new HTuple();
      hv_InterFace_COPY_INP_TMP[11] = hv_Column2;


      ho_Rectangle_H.Dispose();
      HOperatorSet.GenRectangle1(out ho_Rectangle_H, (hv_InterFace_COPY_INP_TMP.TupleSelect(
          10))-50, (hv_InterFace_COPY_INP_TMP.TupleSelect(11))-400, (hv_InterFace_COPY_INP_TMP.TupleSelect(
          10))+50, (hv_InterFace_COPY_INP_TMP.TupleSelect(11))-200);
      ho_ImageReduced.Dispose();
      HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle_H, out ho_ImageReduced
          );
      ho_Region.Dispose();
      HOperatorSet.Threshold(ho_ImageReduced, out ho_Region, 220, 255);
      ho_ConnectedRegions.Dispose();
      HOperatorSet.Connection(ho_Region, out ho_ConnectedRegions);

      ho_SelectedRegions.Dispose();
      HOperatorSet.SelectShape(ho_ConnectedRegions, out ho_SelectedRegions, ((new HTuple("area")).TupleConcat(
          "inner_radius")).TupleConcat("width"), "and", ((new HTuple(800)).TupleConcat(
          2)).TupleConcat(180), ((new HTuple(2500)).TupleConcat(8)).TupleConcat(220));
      HOperatorSet.SmallestRectangle1(ho_SelectedRegions, out hv_Row11, out hv_Column11, 
          out hv_Row21, out hv_Column21);
      ho_Rectangle1.Dispose();
      HOperatorSet.GenRectangle1(out ho_Rectangle1, hv_Row11, hv_Column11, hv_Row21, 
          hv_Column21);
      if (hv_InterFace_COPY_INP_TMP == null)
        hv_InterFace_COPY_INP_TMP = new HTuple();
      hv_InterFace_COPY_INP_TMP[10] = hv_Row11.TupleSelect(0);

      //**********Transition有三种模式： 'all', 'negative'(从亮到暗), 'positive'(从暗到亮)  ***************
      hv_Transition = "negative";
      //**********Select有三种模式： 'all', 'first', 'last'  ****************
      hv_Select = "all";


      //*****************获取水平方向边界参数********************


      hv_t = 50;
      hv_Row = (hv_InterFace_COPY_INP_TMP.TupleSelect(10))+((((hv_InterFace_COPY_INP_TMP.TupleSelect(
          2))-(((hv_InterFace_COPY_INP_TMP.TupleSelect(2))-(hv_InterFace_COPY_INP_TMP.TupleSelect(
          13)))/2))+((((hv_InterFace_COPY_INP_TMP.TupleSelect(1))-(2*(hv_InterFace_COPY_INP_TMP.TupleSelect(
          2))))-(hv_InterFace_COPY_INP_TMP.TupleSelect(7)))/2))/(hv_InterFace_COPY_INP_TMP.TupleSelect(
          14)));
      hv_Column = (hv_InterFace_COPY_INP_TMP.TupleSelect(11))-(((hv_InterFace_COPY_INP_TMP.TupleSelect(
          5))+(hv_InterFace_COPY_INP_TMP.TupleSelect(4)))/(hv_InterFace_COPY_INP_TMP.TupleSelect(
          14)));
      Cartridge_Edge_Insp_LR(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, hv_Row, 
          hv_Column, "negative", "last", out hv_Row_Result, out hv_Column_Result);
      hv_Dis_Col_R3 = hv_Column_Result.Clone();

      //S := (InterFace[11]-Dis_Col_R3)*InterFace[14]

      hv_Column = (hv_InterFace_COPY_INP_TMP.TupleSelect(11))-(((((hv_InterFace_COPY_INP_TMP.TupleSelect(
          12))+2)+(hv_InterFace_COPY_INP_TMP.TupleSelect(5)))-(hv_InterFace_COPY_INP_TMP.TupleSelect(
          3)))/(hv_InterFace_COPY_INP_TMP.TupleSelect(14)));
      Cartridge_Edge_Insp_LR(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, hv_Row, 
          hv_Column, "positive", "first", out hv_Row_Result, out hv_Column_Result);
      hv_Dis_Col_L3 = hv_Column_Result.Clone();

      hv_Column = hv_Dis_Col_R3-((((hv_InterFace_COPY_INP_TMP.TupleSelect(12))+2)+(hv_InterFace_COPY_INP_TMP.TupleSelect(
          6)))/(hv_InterFace_COPY_INP_TMP.TupleSelect(14)));
      Cartridge_Edge_Insp_LR(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, hv_Row, 
          hv_Column, "negative", "last", out hv_Row_Result, out hv_Column_Result);
      hv_Dis_Col_R2 = hv_Column_Result.Clone();

      //Column := Dis_Col_L3-(Dis_Col_R3-Dis_Col_R2)
      //Cartridge_Edge_Insp_LR (Image, WindowHandle, t, Row, Column, 'positive', 'first', Row_Result, Column_Result)
      //Dis_Col_L2 := Column_Result

      //*****************获取竖直方向边界参数********************
      hv_t = 50;
      hv_Row = (hv_InterFace_COPY_INP_TMP.TupleSelect(10))+((((hv_InterFace_COPY_INP_TMP.TupleSelect(
          1))-(hv_InterFace_COPY_INP_TMP.TupleSelect(7)))/2)/(hv_InterFace_COPY_INP_TMP.TupleSelect(
          14)));
      hv_Column = hv_Dis_Col_R3-((((((hv_InterFace_COPY_INP_TMP.TupleSelect(12))+2)-(hv_InterFace_COPY_INP_TMP.TupleSelect(
          3)))-(hv_InterFace_COPY_INP_TMP.TupleSelect(4)))/(hv_InterFace_COPY_INP_TMP.TupleSelect(
          14)))/2);

      Cartridge_Edge_Insp_UD(ho_Image_COPY_INP_TMP, hv_WindowHandle, 30, hv_Row, 
          hv_Column, "negative", "last", 20, out hv_Row_Result, out hv_Column_Result);
      hv_Dis_Row_D1 = hv_Row_Result.Clone();


      hv_Row = hv_Dis_Row_D1-((((hv_InterFace_COPY_INP_TMP.TupleSelect(2))-2)-(hv_InterFace_COPY_INP_TMP.TupleSelect(
          13)))/(hv_InterFace_COPY_INP_TMP.TupleSelect(14)));
      hv_Column = hv_Dis_Col_R3+15;
      Cartridge_Edge_Insp_UD(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, hv_Row, 
          hv_Column, "negative", "last", 10, out hv_Row_Result, out hv_Column_Result);
      hv_Dis_Row_Protrusion1 = hv_Row_Result.Clone();

      hv_Row = hv_Dis_Row_Protrusion1-((((hv_InterFace_COPY_INP_TMP.TupleSelect(13))/2)+((hv_InterFace_COPY_INP_TMP.TupleSelect(
          8))/2))/(hv_InterFace_COPY_INP_TMP.TupleSelect(14)));
      hv_Column = hv_Dis_Col_L3-(((hv_InterFace_COPY_INP_TMP.TupleSelect(3))+((hv_InterFace_COPY_INP_TMP.TupleSelect(
          6))/2))/(hv_InterFace_COPY_INP_TMP.TupleSelect(14)));
      Cartridge_Edge_Insp_UD(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, hv_Row, 
          hv_Column, "positive", "first", 15, out hv_Row_Result, out hv_Column_Result);
      hv_Dis_Row_Connected_area_U1 = hv_Row_Result.Clone();


      hv_Row = hv_Dis_Row_Connected_area_U1+((hv_InterFace_COPY_INP_TMP.TupleSelect(
          8))/(hv_InterFace_COPY_INP_TMP.TupleSelect(14)));
      hv_Column = hv_Dis_Col_L3-(((hv_InterFace_COPY_INP_TMP.TupleSelect(3))+((hv_InterFace_COPY_INP_TMP.TupleSelect(
          6))/2))/(hv_InterFace_COPY_INP_TMP.TupleSelect(14)));
      Cartridge_Edge_Insp_UD(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, hv_Row, 
          hv_Column, "negative", "last", 15, out hv_Row_Result, out hv_Column_Result);
      hv_Dis_Row_Connected_area_D1 = hv_Row_Result.Clone();

      hv_Row = hv_Dis_Row_Connected_area_U1+(((hv_InterFace_COPY_INP_TMP.TupleSelect(
          2))+(hv_InterFace_COPY_INP_TMP.TupleSelect(7)))/(hv_InterFace_COPY_INP_TMP.TupleSelect(
          14)));
      hv_Column = hv_Dis_Col_L3-(((hv_InterFace_COPY_INP_TMP.TupleSelect(3))+((hv_InterFace_COPY_INP_TMP.TupleSelect(
          6))/2))/(hv_InterFace_COPY_INP_TMP.TupleSelect(14)));
      Cartridge_Edge_Insp_UD(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, hv_Row, 
          hv_Column, "positive", "first", 15, out hv_Row_Result, out hv_Column_Result);
      hv_Dis_Row_Connected_area_U2 = hv_Row_Result.Clone();

      hv_Empty_Main_InterFace = new HTuple();
      hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Col_R3);
      hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Col_L3);
      hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Col_R2);
      hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Row_D1);
      hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Row_Protrusion1);
      hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Row_Connected_area_U1);
      hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Row_Connected_area_D1);
      hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_InterFace_COPY_INP_TMP.TupleSelect(
          10));
      hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_InterFace_COPY_INP_TMP.TupleSelect(
          11));
      hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Row_Connected_area_U2);
      ho_Image_COPY_INP_TMP.Dispose();
      ho_Rectangle.Dispose();
      ho_ImageReduced.Dispose();
      ho_Region.Dispose();
      ho_ConnectedRegions.Dispose();
      ho_SelectedRegions.Dispose();
      ho_RegionUnion.Dispose();
      ho_Rectangle2.Dispose();
      ho_Rectangle_V.Dispose();
      ho_Rectangle_H.Dispose();
      ho_Rectangle1.Dispose();

      return;
    }
    catch (HalconException HDevExpDefaultException)
    {
      ho_Image_COPY_INP_TMP.Dispose();
      ho_Rectangle.Dispose();
      ho_ImageReduced.Dispose();
      ho_Region.Dispose();
      ho_ConnectedRegions.Dispose();
      ho_SelectedRegions.Dispose();
      ho_RegionUnion.Dispose();
      ho_Rectangle2.Dispose();
      ho_Rectangle_V.Dispose();
      ho_Rectangle_H.Dispose();
      ho_Rectangle1.Dispose();

      throw HDevExpDefaultException;
    }
  }

  public void LineFindPoints (HObject ho_Image, HTuple hv_LineRowStart, HTuple hv_LineRowEnd, 
      HTuple hv_LineColumnStart, HTuple hv_LineColumnEnd, HTuple hv_RoiWidthLen2, 
      HTuple hv_Sigma, HTuple hv_AmpThreshold, HTuple hv_Select, HTuple hv_Transition, 
      HTuple hv_WindowHandle, out HTuple hv_Row_Result, out HTuple hv_Column_Result, 
      out HTuple hv_Distance_Measure_01_0)
  {




    // Local iconic variables 

    HObject ho_Rectangle2, ho_ImageReduced, ho_Image5;

    // Local copy input parameter variables 
    HObject ho_Image_COPY_INP_TMP;
    ho_Image_COPY_INP_TMP = ho_Image.CopyObj(1,-1);



    // Local control variables 

    HTuple hv_TmpCtrl_Row = null, hv_TmpCtrl_Column = null;
    HTuple hv_TmpCtrl_Dr = null, hv_TmpCtrl_Dc = null, hv_TmpCtrl_Phi = null;
    HTuple hv_TmpCtrl_Len1 = null, hv_TmpCtrl_Len2 = null;
    HTuple hv_Width = null, hv_Height = null, hv_MsrHandle_Measure_01_0 = null;
    HTuple hv_Amplitude_Measure_01_0 = null;
    // Initialize local and output iconic variables 
    HOperatorSet.GenEmptyObj(out ho_Rectangle2);
    HOperatorSet.GenEmptyObj(out ho_ImageReduced);
    HOperatorSet.GenEmptyObj(out ho_Image5);
    try
    {
      hv_TmpCtrl_Row = 0.5*(hv_LineRowStart+hv_LineRowEnd);
      hv_TmpCtrl_Column = 0.5*(hv_LineColumnStart+hv_LineColumnEnd);
      hv_TmpCtrl_Dr = hv_LineRowStart-hv_LineRowEnd;
      hv_TmpCtrl_Dc = hv_LineColumnEnd-hv_LineColumnStart;
      hv_TmpCtrl_Phi = hv_TmpCtrl_Dr.TupleAtan2(hv_TmpCtrl_Dc);
      hv_TmpCtrl_Len1 = 0.5*((((hv_TmpCtrl_Dr*hv_TmpCtrl_Dr)+(hv_TmpCtrl_Dc*hv_TmpCtrl_Dc))).TupleSqrt()
          );
      hv_TmpCtrl_Len2 = hv_RoiWidthLen2.Clone();
      ho_Rectangle2.Dispose();
      HOperatorSet.GenRectangle2(out ho_Rectangle2, hv_TmpCtrl_Row, hv_TmpCtrl_Column, 
          hv_TmpCtrl_Phi, hv_TmpCtrl_Len1, hv_TmpCtrl_Len2);
      ho_ImageReduced.Dispose();
      HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle2, out ho_ImageReduced
          );
      ho_Image_COPY_INP_TMP.Dispose();
      HOperatorSet.Emphasize(ho_ImageReduced, out ho_Image_COPY_INP_TMP, 15, 15, 
          1);
      HOperatorSet.GetImageSize(ho_Image_COPY_INP_TMP, out hv_Width, out hv_Height);
      HOperatorSet.GenMeasureRectangle2(hv_TmpCtrl_Row, hv_TmpCtrl_Column, hv_TmpCtrl_Phi, 
          hv_TmpCtrl_Len1, hv_TmpCtrl_Len2, hv_Width, hv_Height, "nearest_neighbor", 
          out hv_MsrHandle_Measure_01_0);
      ho_Image5.Dispose();
      HOperatorSet.CopyObj(ho_Image_COPY_INP_TMP, out ho_Image5, 1, 1);
      //1, 8, 'all', 'all',
      HOperatorSet.MeasurePos(ho_Image5, hv_MsrHandle_Measure_01_0, hv_Sigma, hv_AmpThreshold, 
          hv_Transition, hv_Select, out hv_Row_Result, out hv_Column_Result, out hv_Amplitude_Measure_01_0, 
          out hv_Distance_Measure_01_0);
      HOperatorSet.DispCross(hv_WindowHandle, hv_Row_Result, hv_Column_Result, 30, 
          hv_TmpCtrl_Phi);
      HOperatorSet.CloseMeasure(hv_MsrHandle_Measure_01_0);
      ho_Image_COPY_INP_TMP.Dispose();
      ho_Rectangle2.Dispose();
      ho_ImageReduced.Dispose();
      ho_Image5.Dispose();

      return;
    }
    catch (HalconException HDevExpDefaultException)
    {
      ho_Image_COPY_INP_TMP.Dispose();
      ho_Rectangle2.Dispose();
      ho_ImageReduced.Dispose();
      ho_Image5.Dispose();

      throw HDevExpDefaultException;
    }
  }

  public void Cartridge_Edge_Insp_LR (HObject ho_Image, HTuple hv_WindowHandle, HTuple hv_t, 
      HTuple hv_Row, HTuple hv_Column, HTuple hv_Transition, HTuple hv_Select, out HTuple hv_Row_Result, 
      out HTuple hv_Column_Result)
  {




    // Local iconic variables 

    // Local control variables 

    HTuple hv_tuple = null, hv_i = null, hv_LineRowStart = new HTuple();
    HTuple hv_LineColumnStart = new HTuple(), hv_LineRowEnd = new HTuple();
    HTuple hv_LineColumnEnd = new HTuple(), hv_AmpThreshold = new HTuple();
    HTuple hv_RoiWidthLen2 = new HTuple(), hv_Sigma = new HTuple();
    HTuple hv_Distance_Measure_01_0 = new HTuple();
    // Initialize local and output iconic variables 
    hv_Row_Result = new HTuple();
    hv_Column_Result = new HTuple();
    hv_tuple = new HTuple();
    for (hv_i=30; (int)hv_i>=30; hv_i = (int)hv_i + -5)
    {


      //**************************注意这个地方的修改***************************************
      hv_LineRowStart = hv_Row.Clone();
      hv_LineColumnStart = hv_Column-hv_t;
      hv_LineRowEnd = hv_Row.Clone();
      hv_LineColumnEnd = hv_Column+hv_t;
      //**********************************************************************************

      if (HDevWindowStack.IsOpen())
      {
        HOperatorSet.DispObj(ho_Image, HDevWindowStack.GetActive());
      }
      HOperatorSet.DispLine(hv_WindowHandle, hv_LineRowStart, hv_LineColumnStart, 
          hv_LineRowEnd, hv_LineColumnEnd);


      //参数
      //measure pos threshold
      hv_AmpThreshold = hv_i.Clone();
      //measure pos ROiLen2
      hv_RoiWidthLen2 = 25;
      //measure pos sigma
      hv_Sigma = 1;
      //**********Transition有三种模式： 'all', 'negative'(从亮到暗), 'positive'(从暗到亮) ***************
      //Transition := 'negative'
      //**********Select有三种模式： 'all', 'first', 'last'  ********************************************
      //Select := 'all'
      LineFindPoints(ho_Image, hv_LineRowStart, hv_LineRowEnd, hv_LineColumnStart, 
          hv_LineColumnEnd, hv_RoiWidthLen2, hv_Sigma, hv_AmpThreshold, hv_Select, 
          hv_Transition, hv_WindowHandle, out hv_Row_Result, out hv_Column_Result, 
          out hv_Distance_Measure_01_0);

      if ((int)(new HTuple((new HTuple(hv_Row_Result.TupleLength())).TupleGreater(
          0))) != 0)
      {

        hv_tuple = hv_tuple.TupleConcat(hv_Row_Result);
        if ((int)(new HTuple(hv_Select.TupleEqual("first"))) != 0)
        {
          HOperatorSet.TupleMin(hv_tuple, out hv_Row_Result);
        }
        else
        {
          HOperatorSet.TupleMax(hv_tuple, out hv_Row_Result);
        }


      }

    }


    return;
  }

  public void Empty_Tray_Segmentation_White_for_All (HObject ho_Image, HTuple hv_WindowHandle, 
      HTuple hv_InterFace, HTuple hv_InterFace_Tray, HTuple hv_InterFace_Offset, HTuple hv_InterFace_Threshold, 
      out HTuple hv_Empty_Main_InterFace, out HTuple hv_bMasterFinalResultRet)
  {




    // Stack for temporary objects 
    HObject[] OTemp = new HObject[20];

    // Local iconic variables 

    HObject ho_Rectangle=null, ho_ImageReduced=null;
    HObject ho_Region=null, ho_ConnectedRegions=null, ho_SelectedRegions=null;
    HObject ho_RegionUnion=null, ho_RegionLinesFitTopCol=null;
    HObject ho_Rectangle_V=null, ho_Rectangle_H=null;

    // Local copy input parameter variables 
    HObject ho_Image_COPY_INP_TMP;
    ho_Image_COPY_INP_TMP = ho_Image.CopyObj(1,-1);



    // Local control variables 

    HTuple hv_Row11 = new HTuple(), hv_Column11 = new HTuple();
    HTuple hv_Row21 = new HTuple(), hv_Column21 = new HTuple();
    HTuple hv_Phi = new HTuple(), hv_Row1 = new HTuple(), hv_Column1 = new HTuple();
    HTuple hv_Row2 = new HTuple(), hv_Column2 = new HTuple();
    HTuple hv_PI = new HTuple(), hv_Phi1 = new HTuple(), hv_Transition = new HTuple();
    HTuple hv_Select = new HTuple(), hv_t = new HTuple(), hv_Row = new HTuple();
    HTuple hv_Column = new HTuple(), hv_Row_Result = new HTuple();
    HTuple hv_Column_Result = new HTuple(), hv_Dis_Col_R3 = new HTuple();
    HTuple hv_Dis_Col_L3 = new HTuple(), hv_Dis_Col_R2 = new HTuple();
    HTuple hv_Dis_Row_D1 = new HTuple(), hv_Dis_Row_Protrusion1 = new HTuple();
    HTuple hv_Dis_Row_Connected_area_D1 = new HTuple(), hv_Dis_Row_Connected_area_U1 = new HTuple();
    HTuple hv_Dis_Row_Connected_area_U2 = new HTuple(), hv_Dis_Col_Cartridge_Edge_L = new HTuple();
    HTuple hv_Exception = null;
    HTuple   hv_InterFace_COPY_INP_TMP = hv_InterFace.Clone();

    // Initialize local and output iconic variables 
    HOperatorSet.GenEmptyObj(out ho_Rectangle);
    HOperatorSet.GenEmptyObj(out ho_ImageReduced);
    HOperatorSet.GenEmptyObj(out ho_Region);
    HOperatorSet.GenEmptyObj(out ho_ConnectedRegions);
    HOperatorSet.GenEmptyObj(out ho_SelectedRegions);
    HOperatorSet.GenEmptyObj(out ho_RegionUnion);
    HOperatorSet.GenEmptyObj(out ho_RegionLinesFitTopCol);
    HOperatorSet.GenEmptyObj(out ho_Rectangle_V);
    HOperatorSet.GenEmptyObj(out ho_Rectangle_H);
    hv_Empty_Main_InterFace = new HTuple();
    hv_bMasterFinalResultRet = new HTuple();
    try
    {
      try
      {
        //******初始化输出参数***********
        hv_bMasterFinalResultRet = 0;
        ho_Rectangle.Dispose();
        HOperatorSet.GenRectangle1(out ho_Rectangle, hv_InterFace_Tray.TupleSelect(
            0), hv_InterFace_Tray.TupleSelect(1), hv_InterFace_Tray.TupleSelect(2), 
            hv_InterFace_Tray.TupleSelect(3));
        ho_ImageReduced.Dispose();
        HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle, out ho_ImageReduced
            );
        ho_Region.Dispose();
        HOperatorSet.Threshold(ho_ImageReduced, out ho_Region, hv_InterFace_Threshold.TupleSelect(
            0), 255);
        ho_ConnectedRegions.Dispose();
        HOperatorSet.Connection(ho_Region, out ho_ConnectedRegions);

        ho_SelectedRegions.Dispose();
        HOperatorSet.SelectShape(ho_ConnectedRegions, out ho_SelectedRegions, (new HTuple("area")).TupleConcat(
            "width"), "and", ((((hv_InterFace_Tray.TupleSelect(3))-(hv_InterFace_Tray.TupleSelect(
            1)))*4)).TupleConcat(((hv_InterFace_Tray.TupleSelect(3))-(hv_InterFace_Tray.TupleSelect(
            1)))-20), (new HTuple(999999)).TupleConcat(((hv_InterFace_Tray.TupleSelect(
            3))-(hv_InterFace_Tray.TupleSelect(1)))+20));
        ho_RegionUnion.Dispose();
        HOperatorSet.Union1(ho_SelectedRegions, out ho_RegionUnion);
        HOperatorSet.SmallestRectangle1(ho_RegionUnion, out hv_Row11, out hv_Column11, 
            out hv_Row21, out hv_Column21);
        ho_RegionLinesFitTopCol.Dispose();
        fitTopSideLine(ho_Image_COPY_INP_TMP, ho_SelectedRegions, out ho_RegionLinesFitTopCol, 
            out hv_Phi);
        //gen_rectangle1 (Rectangle, InterFace_Tray[4], InterFace_Tray[5], InterFace_Tray[6], InterFace_Tray[7])
        //reduce_domain (Image, Rectangle, ImageReduced)
        //threshold (ImageReduced, Region, 100, 255)
        //connection (Region, ConnectedRegions)

        //select_shape (ConnectedRegions, SelectedRegions, ['area','height'], 'and', [(InterFace_Tray[6]-InterFace_Tray[4])*5,InterFace_Tray[6]-InterFace_Tray[4]-20], [999999,InterFace_Tray[6]-InterFace_Tray[4]+20])
        //union1 (SelectedRegions, RegionUnion)
        //smallest_rectangle1 (RegionUnion, Row1, Column1, Row2, Column2)
        //fitRightSideLine (Image, SelectedRegions, RegionLinesFitRightCol, Phi)



        //*由于料盒的旋转角度很小，默认长宽分别用Row2-Row1和Column2-Column1
        hv_PI = 1.5708*2;
        if ((int)(new HTuple(hv_Phi.TupleGreater(1))) != 0)
        {
          hv_Phi1 = hv_Phi-(hv_PI/2);
        }
        else if ((int)(new HTuple(hv_Phi.TupleLess(-1))) != 0)
        {
          hv_Phi1 = hv_Phi+(hv_PI/2);
        }
        else
        {
          hv_Phi1 = hv_Phi.Clone();
        }
        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.RotateImage(ho_Image_COPY_INP_TMP, out ExpTmpOutVar_0, hv_Phi1*57.3, 
            "constant");
        ho_Image_COPY_INP_TMP.Dispose();
        ho_Image_COPY_INP_TMP = ExpTmpOutVar_0;
        }



        //*****************获取料盘边界参数********************
        ho_Rectangle_V.Dispose();
        HOperatorSet.GenRectangle1(out ho_Rectangle_V, hv_InterFace_Tray.TupleSelect(
            4), hv_InterFace_Tray.TupleSelect(5), hv_InterFace_Tray.TupleSelect(6), 
            hv_InterFace_Tray.TupleSelect(7));
        ho_ImageReduced.Dispose();
        HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle_V, out ho_ImageReduced
            );
        ho_Region.Dispose();
        HOperatorSet.Threshold(ho_ImageReduced, out ho_Region, (hv_InterFace_Threshold.TupleSelect(
            0))-20, 255);
        ho_ConnectedRegions.Dispose();
        HOperatorSet.Connection(ho_Region, out ho_ConnectedRegions);

        ho_SelectedRegions.Dispose();
        HOperatorSet.SelectShape(ho_ConnectedRegions, out ho_SelectedRegions, (new HTuple("area")).TupleConcat(
            "height"), "and", ((((hv_InterFace_Tray.TupleSelect(6))-(hv_InterFace_Tray.TupleSelect(
            4)))*5)).TupleConcat(((hv_InterFace_Tray.TupleSelect(6))-(hv_InterFace_Tray.TupleSelect(
            4)))-20), (new HTuple(999999)).TupleConcat(((hv_InterFace_Tray.TupleSelect(
            6))-(hv_InterFace_Tray.TupleSelect(4)))+20));
        ho_RegionUnion.Dispose();
        HOperatorSet.Union1(ho_SelectedRegions, out ho_RegionUnion);
        HOperatorSet.SmallestRectangle1(ho_RegionUnion, out hv_Row1, out hv_Column1, 
            out hv_Row2, out hv_Column2);
        if (hv_InterFace_COPY_INP_TMP == null)
          hv_InterFace_COPY_INP_TMP = new HTuple();
        hv_InterFace_COPY_INP_TMP[11] = hv_Column2;


        ho_Rectangle_H.Dispose();
        HOperatorSet.GenRectangle1(out ho_Rectangle_H, hv_InterFace_Tray.TupleSelect(
            0), hv_InterFace_Tray.TupleSelect(1), hv_InterFace_Tray.TupleSelect(2), 
            hv_InterFace_Tray.TupleSelect(3));
        ho_ImageReduced.Dispose();
        HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle_H, out ho_ImageReduced
            );
        ho_Region.Dispose();
        HOperatorSet.Threshold(ho_ImageReduced, out ho_Region, hv_InterFace_Threshold.TupleSelect(
            0), 255);
        ho_ConnectedRegions.Dispose();
        HOperatorSet.Connection(ho_Region, out ho_ConnectedRegions);

        ho_SelectedRegions.Dispose();
        HOperatorSet.SelectShape(ho_ConnectedRegions, out ho_SelectedRegions, (new HTuple("area")).TupleConcat(
            "width"), "and", ((((hv_InterFace_Tray.TupleSelect(3))-(hv_InterFace_Tray.TupleSelect(
            1)))*4)).TupleConcat(((hv_InterFace_Tray.TupleSelect(3))-(hv_InterFace_Tray.TupleSelect(
            1)))-20), (new HTuple(999999)).TupleConcat(((hv_InterFace_Tray.TupleSelect(
            3))-(hv_InterFace_Tray.TupleSelect(1)))+20));
        ho_RegionUnion.Dispose();
        HOperatorSet.Union1(ho_SelectedRegions, out ho_RegionUnion);
        HOperatorSet.SmallestRectangle1(ho_RegionUnion, out hv_Row11, out hv_Column11, 
            out hv_Row21, out hv_Column21);

        if (hv_InterFace_COPY_INP_TMP == null)
          hv_InterFace_COPY_INP_TMP = new HTuple();
        hv_InterFace_COPY_INP_TMP[10] = hv_Row11.TupleSelect(0);

        //**********Transition有三种模式： 'all', 'negative'(从亮到暗), 'positive'(从暗到亮)  ***************
        hv_Transition = "negative";
        //**********Select有三种模式： 'all', 'first', 'last'  ****************
        hv_Select = "all";


        //*****************获取水平方向边界参数********************


        hv_t = 50;
        hv_Row = (hv_InterFace_COPY_INP_TMP.TupleSelect(10))+((((hv_InterFace_COPY_INP_TMP.TupleSelect(
            2))-(((hv_InterFace_COPY_INP_TMP.TupleSelect(2))-(hv_InterFace_COPY_INP_TMP.TupleSelect(
            13)))/2))+((((hv_InterFace_COPY_INP_TMP.TupleSelect(1))-(2*(hv_InterFace_COPY_INP_TMP.TupleSelect(
            2))))-(hv_InterFace_COPY_INP_TMP.TupleSelect(7)))/2))/(hv_InterFace_COPY_INP_TMP.TupleSelect(
            14)));
        hv_Column = (hv_InterFace_COPY_INP_TMP.TupleSelect(11))-(((hv_InterFace_COPY_INP_TMP.TupleSelect(
            5))+(hv_InterFace_COPY_INP_TMP.TupleSelect(4)))/(hv_InterFace_COPY_INP_TMP.TupleSelect(
            14)));
        Cartridge_Edge_Insp_LR(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, hv_Row, 
            hv_Column, "negative", "last", out hv_Row_Result, out hv_Column_Result);
        hv_Dis_Col_R3 = hv_Column_Result.Clone();

        //S := (InterFace[11]-Dis_Col_R3)*InterFace[14]

        hv_Column = (hv_InterFace_COPY_INP_TMP.TupleSelect(11))-(((((hv_InterFace_COPY_INP_TMP.TupleSelect(
            12))+2)+(hv_InterFace_COPY_INP_TMP.TupleSelect(5)))-(hv_InterFace_COPY_INP_TMP.TupleSelect(
            3)))/(hv_InterFace_COPY_INP_TMP.TupleSelect(14)));
        Cartridge_Edge_Insp_LR(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, hv_Row, 
            hv_Column, "positive", "first", out hv_Row_Result, out hv_Column_Result);
        hv_Dis_Col_L3 = hv_Column_Result.Clone();

        hv_Column = hv_Dis_Col_R3-((((hv_InterFace_COPY_INP_TMP.TupleSelect(12))+2)+(hv_InterFace_COPY_INP_TMP.TupleSelect(
            6)))/(hv_InterFace_COPY_INP_TMP.TupleSelect(14)));
        Cartridge_Edge_Insp_LR(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, hv_Row, 
            hv_Column, "negative", "last", out hv_Row_Result, out hv_Column_Result);
        hv_Dis_Col_R2 = hv_Column_Result.Clone();

        //Column := Dis_Col_L3-(Dis_Col_R3-Dis_Col_R2)
        //Cartridge_Edge_Insp_LR (Image, WindowHandle, t, Row, Column, 'positive', 'first', Row_Result, Column_Result)
        //Dis_Col_L2 := Column_Result

        //*****************获取竖直方向边界参数********************
        hv_t = 50;
        hv_Row = (hv_InterFace_COPY_INP_TMP.TupleSelect(10))+((((hv_InterFace_COPY_INP_TMP.TupleSelect(
            1))-(hv_InterFace_COPY_INP_TMP.TupleSelect(7)))/2)/(hv_InterFace_COPY_INP_TMP.TupleSelect(
            14)));
        hv_Column = ((hv_Dis_Col_R3+hv_Dis_Col_L3)/2)+(hv_InterFace_Offset.TupleSelect(
            0));
        //Column := Dis_Col_R3-(InterFace[12]+2-InterFace[3]-InterFace[4])/InterFace[14]/2
        Cartridge_Edge_Insp_UD(ho_Image_COPY_INP_TMP, hv_WindowHandle, 20, hv_Row, 
            hv_Column, "negative", "last", 20, out hv_Row_Result, out hv_Column_Result);
        hv_Dis_Row_D1 = hv_Row_Result.Clone();


        hv_Row = hv_Dis_Row_D1-((((hv_InterFace_COPY_INP_TMP.TupleSelect(2))-2)-(hv_InterFace_COPY_INP_TMP.TupleSelect(
            13)))/(hv_InterFace_COPY_INP_TMP.TupleSelect(14)));
        hv_Column = hv_Dis_Col_R3+(hv_InterFace_Offset.TupleSelect(2));
        Cartridge_Edge_Insp_UD(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, hv_Row, 
            hv_Column, "negative", "last", 10, out hv_Row_Result, out hv_Column_Result);
        hv_Dis_Row_Protrusion1 = hv_Row_Result.Clone();


        hv_Row = hv_Dis_Row_Protrusion1-((hv_InterFace_COPY_INP_TMP.TupleSelect(15))/(hv_InterFace_COPY_INP_TMP.TupleSelect(
            14)));
        hv_Column = hv_Dis_Col_L3-(((hv_InterFace_COPY_INP_TMP.TupleSelect(3))+((hv_InterFace_COPY_INP_TMP.TupleSelect(
            6))/2))/(hv_InterFace_COPY_INP_TMP.TupleSelect(14)));
        Cartridge_Edge_Insp_UD(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, hv_Row, 
            hv_Column, "negative", "last", 15, out hv_Row_Result, out hv_Column_Result);
        hv_Dis_Row_Connected_area_D1 = hv_Row_Result.Clone();


        hv_Row = hv_Dis_Row_Connected_area_D1-((hv_InterFace_COPY_INP_TMP.TupleSelect(
            8))/(hv_InterFace_COPY_INP_TMP.TupleSelect(14)));
        hv_Column = hv_Dis_Col_L3-(((hv_InterFace_COPY_INP_TMP.TupleSelect(3))+((hv_InterFace_COPY_INP_TMP.TupleSelect(
            6))/2))/(hv_InterFace_COPY_INP_TMP.TupleSelect(14)));
        Cartridge_Edge_Insp_UD(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, hv_Row, 
            hv_Column, "positive", "first", 15, out hv_Row_Result, out hv_Column_Result);
        hv_Dis_Row_Connected_area_U1 = hv_Row_Result.Clone();


        hv_Row = hv_Dis_Row_Connected_area_U1+(((hv_InterFace_COPY_INP_TMP.TupleSelect(
            2))+(hv_InterFace_COPY_INP_TMP.TupleSelect(7)))/(hv_InterFace_COPY_INP_TMP.TupleSelect(
            14)));
        hv_Column = hv_Dis_Col_L3-(((hv_InterFace_COPY_INP_TMP.TupleSelect(3))+((hv_InterFace_COPY_INP_TMP.TupleSelect(
            6))/2))/(hv_InterFace_COPY_INP_TMP.TupleSelect(14)));
        Cartridge_Edge_Insp_UD(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, hv_Row, 
            hv_Column, "positive", "first", 15, out hv_Row_Result, out hv_Column_Result);
        hv_Dis_Row_Connected_area_U2 = hv_Row_Result.Clone();

        hv_Row = hv_Dis_Row_Connected_area_U1-(hv_InterFace_Offset.TupleSelect(1));
        hv_Column = hv_Dis_Col_L3-((hv_InterFace_COPY_INP_TMP.TupleSelect(3))/(hv_InterFace_COPY_INP_TMP.TupleSelect(
            14)));
        Cartridge_Edge_Insp_LR(ho_Image_COPY_INP_TMP, hv_WindowHandle, 30, hv_Row, 
            hv_Column, "positive", "first", out hv_Row_Result, out hv_Column_Result);
        hv_Dis_Col_Cartridge_Edge_L = hv_Column_Result.Clone();


        hv_Empty_Main_InterFace = new HTuple();
        hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Col_R3);
        hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Col_L3);
        hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Col_R2);
        hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Row_D1);
        hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Row_Protrusion1);
        hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Row_Connected_area_U1);
        hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Row_Connected_area_D1);
        hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_InterFace_COPY_INP_TMP.TupleSelect(
            10));
        hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_InterFace_COPY_INP_TMP.TupleSelect(
            11));
        hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Row_Connected_area_U2);
        hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_Dis_Col_Cartridge_Edge_L);
        hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_InterFace_COPY_INP_TMP.TupleSelect(
            10));
        hv_Empty_Main_InterFace = hv_Empty_Main_InterFace.TupleConcat(hv_InterFace_COPY_INP_TMP.TupleSelect(
            11));

        if ((int)(new HTuple((new HTuple(hv_Empty_Main_InterFace.TupleLength())).TupleNotEqual(
            13))) != 0)
        {
          hv_bMasterFinalResultRet = 1;
          ho_Image_COPY_INP_TMP.Dispose();
          ho_Rectangle.Dispose();
          ho_ImageReduced.Dispose();
          ho_Region.Dispose();
          ho_ConnectedRegions.Dispose();
          ho_SelectedRegions.Dispose();
          ho_RegionUnion.Dispose();
          ho_RegionLinesFitTopCol.Dispose();
          ho_Rectangle_V.Dispose();
          ho_Rectangle_H.Dispose();

          return;
        }
        else
        {
        }
      }
      // catch (Exception) 
      catch (HalconException HDevExpDefaultException1)
      {
        HDevExpDefaultException1.ToHTuple(out hv_Exception);
        hv_bMasterFinalResultRet = 1;

      }
      ho_Image_COPY_INP_TMP.Dispose();
      ho_Rectangle.Dispose();
      ho_ImageReduced.Dispose();
      ho_Region.Dispose();
      ho_ConnectedRegions.Dispose();
      ho_SelectedRegions.Dispose();
      ho_RegionUnion.Dispose();
      ho_RegionLinesFitTopCol.Dispose();
      ho_Rectangle_V.Dispose();
      ho_Rectangle_H.Dispose();

      return;
    }
    catch (HalconException HDevExpDefaultException)
    {
      ho_Image_COPY_INP_TMP.Dispose();
      ho_Rectangle.Dispose();
      ho_ImageReduced.Dispose();
      ho_Region.Dispose();
      ho_ConnectedRegions.Dispose();
      ho_SelectedRegions.Dispose();
      ho_RegionUnion.Dispose();
      ho_RegionLinesFitTopCol.Dispose();
      ho_Rectangle_V.Dispose();
      ho_Rectangle_H.Dispose();

      throw HDevExpDefaultException;
    }
  }

  public void fitRightSideLine (HObject ho_ImageRotateS, HObject ho_BatteryNoTabRegions, 
      out HObject ho_RegionLinesFitSide, out HTuple hv_Phi)
  {



    // Stack for temporary objects 
    HObject[] OTemp = new HObject[20];

    // Local iconic variables 

    HObject ho_SelectedRegionsS, ho_BatteryNoTabRegionsOut;
    HObject ho_BatteryNoTabRegionsRect, ho_sliceRectRegions;
    HObject ho_sliceRectRegionsROI, ho_sliceRectRegionsROIRaw;
    HObject ho_sliceobjRectsssssssRemoved, ho_objNoTabRegionRect=null;
    HObject ho_sliceRectobjNoTabRegions=null, ho_sliceobjRectRemoved=null;
    HObject ho_RegionLinesFit, ho_sliceRectRegionsROISide, ho_ContoursliceRectRegionsROI;

    // Local control variables 

    HTuple hv_Row1RectOut = null, hv_Col1RectOut = null;
    HTuple hv_Row2RectOut = null, hv_Col2RectOut = null, hv_Row1BatteryNoTab = null;
    HTuple hv_Col1BatteryNoTab = null, hv_Row2BatteryNoTab = null;
    HTuple hv_Col2BatteryNoTab = null, hv_lengthOfNoTabRegion = null;
    HTuple hv_numberOfNoTabRegion = null, hv_subindex = null;
    HTuple hv_totalLen = null, hv_stepOflen = null, hv_sliceRectRow1 = null;
    HTuple hv_sliceRectRow2 = null, hv_sliceRectCol1 = null;
    HTuple hv_sliceRectCol2 = null, hv_sliceIndexGap = null;
    HTuple hv_countOfleftTop = new HTuple(), hv_sliceIndex = new HTuple();
    HTuple hv_Row1sliceRect = null, hv_Col1sliceRect = null;
    HTuple hv_Row2sliceRect = null, hv_Col2sliceRect = null;
    HTuple hv_Row1SLobjNoTab = new HTuple(), hv_Col1SLobjNoTab = new HTuple();
    HTuple hv_Row2SLobjNoTab = new HTuple(), hv_Col2SLobjNoTab = new HTuple();
    HTuple hv_lenofRow1SLobjNoTab = new HTuple(), hv_Row1SLobjNoTabPLine = new HTuple();
    HTuple hv_Row1SLobjNoTabPLIndex = new HTuple(), hv_Values = null;
    HTuple hv_isideTab = null, hv_len = null, hv_y = null;
    HTuple hv_x = null, hv_xxxx = null, hv_idxxxx = null, hv_xtx = null;
    HTuple hv_xty = null, hv_invxtx = null, hv_beta = null;
    HTuple hv_Valueside = null, hv_towPointsRow = null, hv_Newy = null;
    HTuple hv_RowBegin = null, hv_ColBegin = null, hv_RowEnd = null;
    HTuple hv_ColEnd = null, hv_Nr = null, hv_Nc = null, hv_Dist = null;
    // Initialize local and output iconic variables 
    HOperatorSet.GenEmptyObj(out ho_RegionLinesFitSide);
    HOperatorSet.GenEmptyObj(out ho_SelectedRegionsS);
    HOperatorSet.GenEmptyObj(out ho_BatteryNoTabRegionsOut);
    HOperatorSet.GenEmptyObj(out ho_BatteryNoTabRegionsRect);
    HOperatorSet.GenEmptyObj(out ho_sliceRectRegions);
    HOperatorSet.GenEmptyObj(out ho_sliceRectRegionsROI);
    HOperatorSet.GenEmptyObj(out ho_sliceRectRegionsROIRaw);
    HOperatorSet.GenEmptyObj(out ho_sliceobjRectsssssssRemoved);
    HOperatorSet.GenEmptyObj(out ho_objNoTabRegionRect);
    HOperatorSet.GenEmptyObj(out ho_sliceRectobjNoTabRegions);
    HOperatorSet.GenEmptyObj(out ho_sliceobjRectRemoved);
    HOperatorSet.GenEmptyObj(out ho_RegionLinesFit);
    HOperatorSet.GenEmptyObj(out ho_sliceRectRegionsROISide);
    HOperatorSet.GenEmptyObj(out ho_ContoursliceRectRegionsROI);
    try
    {
      ho_SelectedRegionsS.Dispose();
      HOperatorSet.CopyObj(ho_BatteryNoTabRegions, out ho_SelectedRegionsS, 1, -1);
      //10.拟合底部直线进行拟合直线前的准备
      //剔除左边侧封区域
      //剔除每个区域的边缘
      //剔除区域内的最高点14%（当采样数量大于15时）
      ho_RegionLinesFitSide.Dispose();
      HOperatorSet.GenEmptyObj(out ho_RegionLinesFitSide);
      //shape_trans (BatteryNoTabRegionsOut, BatteryNoTabRegionsOut, 'convex')
      HOperatorSet.SmallestRectangle1(ho_SelectedRegionsS, out hv_Row1RectOut, out hv_Col1RectOut, 
          out hv_Row2RectOut, out hv_Col2RectOut);
      ho_BatteryNoTabRegionsOut.Dispose();
      HOperatorSet.SortRegion(ho_SelectedRegionsS, out ho_BatteryNoTabRegionsOut, 
          "upper_left", "true", "column");
      HOperatorSet.SmallestRectangle1(ho_BatteryNoTabRegionsOut, out hv_Row1BatteryNoTab, 
          out hv_Col1BatteryNoTab, out hv_Row2BatteryNoTab, out hv_Col2BatteryNoTab);
      ho_BatteryNoTabRegionsRect.Dispose();
      HOperatorSet.GenRectangle1(out ho_BatteryNoTabRegionsRect, hv_Row1BatteryNoTab, 
          hv_Col1BatteryNoTab, hv_Row2BatteryNoTab, hv_Col2BatteryNoTab);
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.Connection(ho_BatteryNoTabRegionsRect, out ExpTmpOutVar_0);
      ho_BatteryNoTabRegionsRect.Dispose();
      ho_BatteryNoTabRegionsRect = ExpTmpOutVar_0;
      }
      hv_lengthOfNoTabRegion = hv_Row2BatteryNoTab-hv_Row1BatteryNoTab;
      hv_numberOfNoTabRegion = new HTuple(hv_Row1BatteryNoTab.TupleLength());
      //剔除最上边的区域侧边封印区域
      if ((int)(new HTuple(((hv_lengthOfNoTabRegion.TupleSelect(0))).TupleGreater(
          160))) != 0)
      {
        if (hv_Row1BatteryNoTab == null)
          hv_Row1BatteryNoTab = new HTuple();
        hv_Row1BatteryNoTab[0] = (hv_Row1BatteryNoTab.TupleSelect(0))+10;
        if (hv_Row2BatteryNoTab == null)
          hv_Row2BatteryNoTab = new HTuple();
        hv_Row2BatteryNoTab[0] = (hv_Row2BatteryNoTab.TupleSelect(0))-10;
      }
      HTuple end_val19 = hv_numberOfNoTabRegion-1;
      HTuple step_val19 = 1;
      for (hv_subindex=1; hv_subindex.Continue(end_val19, step_val19); hv_subindex = hv_subindex.TupleAdd(step_val19))
      {
        if ((int)(new HTuple(((hv_lengthOfNoTabRegion.TupleSelect(hv_subindex))).TupleGreater(
            10))) != 0)
        {
          if (hv_Row1BatteryNoTab == null)
            hv_Row1BatteryNoTab = new HTuple();
          hv_Row1BatteryNoTab[hv_subindex] = (hv_Row1BatteryNoTab.TupleSelect(hv_subindex))+5;
          if (hv_Row2BatteryNoTab == null)
            hv_Row2BatteryNoTab = new HTuple();
          hv_Row2BatteryNoTab[hv_subindex] = (hv_Row2BatteryNoTab.TupleSelect(hv_subindex))-5;
        }
      }
      hv_lengthOfNoTabRegion = hv_Row2BatteryNoTab-hv_Row1BatteryNoTab;
      HOperatorSet.TupleSum(hv_lengthOfNoTabRegion, out hv_totalLen);
      hv_stepOflen = (hv_totalLen-200)/50;
      if ((int)(new HTuple(hv_stepOflen.TupleLess(2))) != 0)
      {
        hv_stepOflen = 2;
      }
      hv_sliceRectRow1 = new HTuple();
      hv_sliceRectRow2 = new HTuple();
      hv_sliceRectCol1 = new HTuple();
      hv_sliceRectCol2 = new HTuple();
      hv_sliceIndexGap = 0;
      HTuple end_val36 = hv_numberOfNoTabRegion-1;
      HTuple step_val36 = 1;
      for (hv_subindex=0; hv_subindex.Continue(end_val36, step_val36); hv_subindex = hv_subindex.TupleAdd(step_val36))
      {
        hv_countOfleftTop = (hv_lengthOfNoTabRegion.TupleSelect(hv_subindex))/hv_stepOflen;

        HTuple end_val39 = hv_sliceIndexGap+hv_countOfleftTop;
        HTuple step_val39 = 1;
        for (hv_sliceIndex=hv_sliceIndexGap; hv_sliceIndex.Continue(end_val39, step_val39); hv_sliceIndex = hv_sliceIndex.TupleAdd(step_val39))
        {
          if (hv_sliceRectRow1 == null)
            hv_sliceRectRow1 = new HTuple();
          hv_sliceRectRow1[hv_sliceIndex] = (hv_Row1BatteryNoTab.TupleSelect(hv_subindex))+((hv_sliceIndex-hv_sliceIndexGap)*hv_stepOflen);
          if (hv_sliceRectRow2 == null)
            hv_sliceRectRow2 = new HTuple();
          hv_sliceRectRow2[hv_sliceIndex] = (hv_Row1BatteryNoTab.TupleSelect(hv_subindex))+((hv_sliceIndex-hv_sliceIndexGap)*hv_stepOflen);
          if (hv_sliceRectCol1 == null)
            hv_sliceRectCol1 = new HTuple();
          hv_sliceRectCol1[hv_sliceIndex] = (hv_Col2BatteryNoTab.TupleSelect(hv_subindex))-30;
          if (hv_sliceRectCol2 == null)
            hv_sliceRectCol2 = new HTuple();
          hv_sliceRectCol2[hv_sliceIndex] = (hv_Col2BatteryNoTab.TupleSelect(hv_subindex))+30;
        }

        hv_sliceIndexGap = hv_sliceIndexGap+hv_countOfleftTop;

      }


      ho_sliceRectRegions.Dispose();
      HOperatorSet.GenRectangle1(out ho_sliceRectRegions, hv_sliceRectRow1, hv_sliceRectCol1, 
          hv_sliceRectRow2, hv_sliceRectCol2);
      ho_sliceRectRegionsROI.Dispose();
      HOperatorSet.Intersection(ho_sliceRectRegions, ho_BatteryNoTabRegionsOut, out ho_sliceRectRegionsROI
          );
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.ClosingRectangle1(ho_sliceRectRegionsROI, out ExpTmpOutVar_0, 
          1, 60);
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.Union1(ho_sliceRectRegionsROI, out ExpTmpOutVar_0);
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.FillUp(ho_sliceRectRegionsROI, out ExpTmpOutVar_0);
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.Connection(ho_sliceRectRegionsROI, out ExpTmpOutVar_0);
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.SortRegion(ho_sliceRectRegionsROI, out ExpTmpOutVar_0, "upper_left", 
          "true", "row");
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }
      HOperatorSet.SmallestRectangle1(ho_sliceRectRegionsROI, out hv_Row1sliceRect, 
          out hv_Col1sliceRect, out hv_Row2sliceRect, out hv_Col2sliceRect);
      ho_sliceRectRegionsROI.Dispose();
      HOperatorSet.GenRectangle1(out ho_sliceRectRegionsROI, hv_Row2sliceRect, hv_Col1sliceRect, 
          hv_Row2sliceRect, hv_Col2sliceRect);
      ho_sliceRectRegionsROIRaw.Dispose();
      HOperatorSet.Connection(ho_sliceRectRegionsROI, out ho_sliceRectRegionsROIRaw
          );


      //如果同一区域超出15个点,剔除最靠近上方的5个点
      ho_sliceobjRectsssssssRemoved.Dispose();
      HOperatorSet.GenEmptyObj(out ho_sliceobjRectsssssssRemoved);
      HTuple end_val65 = hv_numberOfNoTabRegion;
      HTuple step_val65 = 1;
      for (hv_subindex=1; hv_subindex.Continue(end_val65, step_val65); hv_subindex = hv_subindex.TupleAdd(step_val65))
      {
        ho_objNoTabRegionRect.Dispose();
        HOperatorSet.SelectObj(ho_BatteryNoTabRegionsRect, out ho_objNoTabRegionRect, 
            hv_subindex);
        ho_sliceRectobjNoTabRegions.Dispose();
        HOperatorSet.Intersection(ho_objNoTabRegionRect, ho_sliceRectRegionsROIRaw, 
            out ho_sliceRectobjNoTabRegions);
        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.Connection(ho_sliceRectobjNoTabRegions, out ExpTmpOutVar_0);
        ho_sliceRectobjNoTabRegions.Dispose();
        ho_sliceRectobjNoTabRegions = ExpTmpOutVar_0;
        }
        HOperatorSet.SmallestRectangle1(ho_sliceRectobjNoTabRegions, out hv_Row1SLobjNoTab, 
            out hv_Col1SLobjNoTab, out hv_Row2SLobjNoTab, out hv_Col2SLobjNoTab);
        hv_lenofRow1SLobjNoTab = new HTuple(hv_Row1SLobjNoTab.TupleLength());
        if ((int)(new HTuple(hv_lenofRow1SLobjNoTab.TupleGreater(15))) != 0)
        {
          HOperatorSet.TupleSortIndex(hv_Row1SLobjNoTab, out hv_Row1SLobjNoTabPLine);
          HOperatorSet.TupleSelectRange(hv_Row1SLobjNoTabPLine, 0, (hv_lenofRow1SLobjNoTab/7)-1, 
              out hv_Row1SLobjNoTabPLine);
          hv_Row1SLobjNoTabPLIndex = hv_Row1SLobjNoTabPLine+1;
          ho_sliceobjRectRemoved.Dispose();
          HOperatorSet.SelectObj(ho_sliceRectobjNoTabRegions, out ho_sliceobjRectRemoved, 
              hv_Row1SLobjNoTabPLIndex);
          {
          HObject ExpTmpOutVar_0;
          HOperatorSet.ConcatObj(ho_sliceobjRectsssssssRemoved, ho_sliceobjRectRemoved, 
              out ExpTmpOutVar_0);
          ho_sliceobjRectsssssssRemoved.Dispose();
          ho_sliceobjRectsssssssRemoved = ExpTmpOutVar_0;
          }
        }
      }
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.Difference(ho_sliceRectRegionsROI, ho_sliceobjRectsssssssRemoved, 
          out ExpTmpOutVar_0);
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }



      //11.以tab为界限,分别拟合直线?不行，如果相差比较远会得到很奇怪的拟合线
      ho_RegionLinesFit.Dispose();
      HOperatorSet.GenEmptyObj(out ho_RegionLinesFit);
      hv_Values = new HTuple();
      hv_Values[0] = 0;
      hv_Values[1] = 0;
      hv_Values[2] = 0;
      hv_Values[3] = 0;
      hv_isideTab = 2;
      //* for isideTab := 0 to 1 by 1
      //gen_empty_obj (sliceRectRegionsROISide)
      //if (isideTab=0)
        //concat_obj (sliceRectRegionsROISide, defineInnerRectsLeft, sliceRectRegionsROISide)
      //elseif (isideTab=1)
        //concat_obj (sliceRectRegionsROISide, defineInnerRectsRight, sliceRectRegionsROISide)
      //else
        //concat_obj (sliceRectRegionsROISide, defineInnerRects, sliceRectRegionsROISide)
      //endif
      //intersection (sliceRectRegionsROI, sliceRectRegionsROISide, sliceRectRegionsROISide)
      ho_sliceRectRegionsROISide.Dispose();
      HOperatorSet.SortRegion(ho_sliceRectRegionsROI, out ho_sliceRectRegionsROISide, 
          "upper_left", "true", "row");
      HOperatorSet.SmallestRectangle1(ho_sliceRectRegionsROISide, out hv_Row1sliceRect, 
          out hv_Col1sliceRect, out hv_Row2sliceRect, out hv_Col2sliceRect);

      hv_len = new HTuple(hv_Col2sliceRect.TupleLength());
      HOperatorSet.CreateMatrix(hv_len, 1, hv_Col2sliceRect, out hv_y);
      HOperatorSet.CreateMatrix(hv_len, 2, 1, out hv_x);
      hv_xxxx = new HTuple();
      HTuple end_val104 = hv_len-1;
      HTuple step_val104 = 1;
      for (hv_idxxxx=0; hv_idxxxx.Continue(end_val104, step_val104); hv_idxxxx = hv_idxxxx.TupleAdd(step_val104))
      {
        if (hv_xxxx == null)
          hv_xxxx = new HTuple();
        hv_xxxx[hv_idxxxx] = hv_idxxxx;
      }
      HOperatorSet.SetValueMatrix(hv_x, hv_xxxx, HTuple.TupleGenConst(hv_len,0), 
          hv_Row2sliceRect);

      HOperatorSet.MultMatrix(hv_x, hv_x, "ATB", out hv_xtx);
      HOperatorSet.MultMatrix(hv_x, hv_y, "ATB", out hv_xty);

      HOperatorSet.InvertMatrix(hv_xtx, "general", 0, out hv_invxtx);
      HOperatorSet.MultMatrix(hv_invxtx, hv_xty, "AB", out hv_beta);
      HOperatorSet.GetFullMatrix(hv_beta, out hv_Valueside);

      if (hv_Values == null)
        hv_Values = new HTuple();
      hv_Values[(hv_isideTab*2)+0] = hv_Valueside.TupleSelect(0);
      if (hv_Values == null)
        hv_Values = new HTuple();
      hv_Values[(hv_isideTab*2)+1] = hv_Valueside.TupleSelect(1);
      hv_towPointsRow = new HTuple();
      hv_towPointsRow = hv_towPointsRow.TupleConcat(hv_Row2RectOut-((hv_Row2RectOut-hv_Row1RectOut)*0.6));
      hv_towPointsRow = hv_towPointsRow.TupleConcat(hv_Row2RectOut);
      //if (isideTab=0)
        //towPointsCol := [300,Col1Tab[1]]
      //elseif (isideTab=1)
        //towPointsCol := [Col2Tab[0],Col2Tab[1]+700]
      //else
        //isideTab := 0
        //Values[isideTab*2+0] := Valueside[0]
        //Values[isideTab*2+1] := Valueside[1]
        //towPointsCol := [300,Col2Tab[1]+700]
      //endif

      hv_Newy = ((hv_Values.TupleSelect((hv_isideTab*2)+0))*hv_towPointsRow)+(hv_Values.TupleSelect(
          (hv_isideTab*2)+1));

      ho_ContoursliceRectRegionsROI.Dispose();
      HOperatorSet.GenContourPolygonXld(out ho_ContoursliceRectRegionsROI, hv_towPointsRow, 
          hv_Newy);
      HOperatorSet.FitLineContourXld(ho_ContoursliceRectRegionsROI, "tukey", -1, 
          0, 5, 1, out hv_RowBegin, out hv_ColBegin, out hv_RowEnd, out hv_ColEnd, 
          out hv_Nr, out hv_Nc, out hv_Dist);
      ho_RegionLinesFitSide.Dispose();
      HOperatorSet.GenRegionLine(out ho_RegionLinesFitSide, hv_RowBegin, hv_ColBegin, 
          hv_RowEnd, hv_ColEnd);
      hv_Phi = (((hv_ColEnd-hv_ColBegin)/(hv_RowEnd-hv_RowBegin))).TupleAtan();
      ho_SelectedRegionsS.Dispose();
      ho_BatteryNoTabRegionsOut.Dispose();
      ho_BatteryNoTabRegionsRect.Dispose();
      ho_sliceRectRegions.Dispose();
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROIRaw.Dispose();
      ho_sliceobjRectsssssssRemoved.Dispose();
      ho_objNoTabRegionRect.Dispose();
      ho_sliceRectobjNoTabRegions.Dispose();
      ho_sliceobjRectRemoved.Dispose();
      ho_RegionLinesFit.Dispose();
      ho_sliceRectRegionsROISide.Dispose();
      ho_ContoursliceRectRegionsROI.Dispose();

      return;
    }
    catch (HalconException HDevExpDefaultException)
    {
      ho_SelectedRegionsS.Dispose();
      ho_BatteryNoTabRegionsOut.Dispose();
      ho_BatteryNoTabRegionsRect.Dispose();
      ho_sliceRectRegions.Dispose();
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROIRaw.Dispose();
      ho_sliceobjRectsssssssRemoved.Dispose();
      ho_objNoTabRegionRect.Dispose();
      ho_sliceRectobjNoTabRegions.Dispose();
      ho_sliceobjRectRemoved.Dispose();
      ho_RegionLinesFit.Dispose();
      ho_sliceRectRegionsROISide.Dispose();
      ho_ContoursliceRectRegionsROI.Dispose();

      throw HDevExpDefaultException;
    }
  }

  public void rotateaxis_rectangle2 (HObject ho_rect2Ori, out HObject ho_rect2Rotated, 
      HTuple hv_row_center, HTuple hv_col_center, HTuple hv_axis_phi, HTuple hv_axisdegreeOffset)
  {




    // Local iconic variables 

    HObject ho_Circle_BR;

    // Local control variables 

    HTuple hv_Row11LinesFit = null, hv_Column11LinesFit = null;
    HTuple hv_Row21LinesFit = null, hv_Column21LinesFit = null;
    HTuple hv_RowLinesFit = null, hv_ColLinesFit = null, hv_PhiLinesFit = null;
    HTuple hv_len1LinesFit = null, hv_len2LinesFit = null;
    HTuple hv_dBRx = null, hv_dBRy = null, hv_dBRs = null;
    HTuple hv_rBR = null, hv_ThetaBR = null, hv_AlphaBR = null;
    HTuple hv_dBRx2 = null, hv_dBRy2 = null, hv_Sgn_xBR = null;
    HTuple hv_Sgn_yBR = null, hv_x_BR = null, hv_y_BR = null;
    // Initialize local and output iconic variables 
    HOperatorSet.GenEmptyObj(out ho_rect2Rotated);
    HOperatorSet.GenEmptyObj(out ho_Circle_BR);
    try
    {

      ho_rect2Rotated.Dispose();
      HOperatorSet.GenEmptyObj(out ho_rect2Rotated);



      HOperatorSet.SmallestRectangle1(ho_rect2Ori, out hv_Row11LinesFit, out hv_Column11LinesFit, 
          out hv_Row21LinesFit, out hv_Column21LinesFit);
      HOperatorSet.SmallestRectangle2(ho_rect2Ori, out hv_RowLinesFit, out hv_ColLinesFit, 
          out hv_PhiLinesFit, out hv_len1LinesFit, out hv_len2LinesFit);


      hv_dBRx = hv_RowLinesFit-hv_row_center;
      hv_dBRy = hv_ColLinesFit-hv_col_center;
      hv_dBRs = (hv_dBRx*hv_dBRx)+(hv_dBRy*hv_dBRy);
      //distance to center
      HOperatorSet.TupleSqrt(hv_dBRs, out hv_rBR);
      HOperatorSet.TupleAtan2(hv_dBRy.TupleAbs(), hv_dBRx.TupleAbs(), out hv_ThetaBR);
      //recover center before rotation
      hv_AlphaBR = hv_axis_phi.Clone();
      if ((int)(new HTuple(((hv_dBRy*hv_dBRx)).TupleLess(0))) != 0)
      {
        hv_AlphaBR = -hv_axis_phi;
      }

      hv_dBRx2 = hv_rBR*((((hv_ThetaBR+hv_AlphaBR)+hv_axisdegreeOffset)).TupleCos()
          );
      hv_dBRy2 = hv_rBR*((((hv_ThetaBR+hv_AlphaBR)+hv_axisdegreeOffset)).TupleSin()
          );

      HOperatorSet.TupleSgn((hv_dBRx*1.0)/hv_rBR, out hv_Sgn_xBR);
      HOperatorSet.TupleSgn((hv_dBRy*1.0)/hv_rBR, out hv_Sgn_yBR);

      hv_x_BR = hv_row_center+(hv_dBRx2*hv_Sgn_xBR);
      hv_y_BR = hv_col_center+(hv_dBRy2*hv_Sgn_yBR);

      ho_Circle_BR.Dispose();
      HOperatorSet.GenCircle(out ho_Circle_BR, hv_x_BR, hv_y_BR, 10);
      ho_rect2Rotated.Dispose();
      HOperatorSet.GenRectangle2(out ho_rect2Rotated, hv_x_BR, hv_y_BR, hv_PhiLinesFit+hv_axis_phi, 
          hv_len1LinesFit, hv_len2LinesFit);





      ho_Circle_BR.Dispose();

      return;
    }
    catch (HalconException HDevExpDefaultException)
    {
      ho_Circle_BR.Dispose();

      throw HDevExpDefaultException;
    }
  }

  public void fitBottomRowLine (HObject ho_ImageRotateS, HObject ho_BatteryNoTabRegions, 
      out HObject ho_RegionLinesFitSide)
  {



    // Stack for temporary objects 
    HObject[] OTemp = new HObject[20];

    // Local iconic variables 

    HObject ho_SelectedRegionsS, ho_BatteryNoTabRegionsOut;
    HObject ho_BatteryNoTabRegionsRect, ho_sliceRectRegions;
    HObject ho_sliceRectRegionsROI, ho_sliceRectRegionsROIRaw;
    HObject ho_sliceobjRectsssssssRemoved, ho_objNoTabRegionRect=null;
    HObject ho_sliceRectobjNoTabRegions=null, ho_sliceobjRectRemoved=null;
    HObject ho_RegionLinesFit, ho_sliceRectRegionsROISide, ho_ContoursliceRectRegionsROI;

    // Local control variables 

    HTuple hv_Row1RectOut = null, hv_Col1RectOut = null;
    HTuple hv_Row2RectOut = null, hv_Col2RectOut = null, hv_Row1BatteryNoTab = null;
    HTuple hv_Col1BatteryNoTab = null, hv_Row2BatteryNoTab = null;
    HTuple hv_Col2BatteryNoTab = null, hv_lengthOfNoTabRegion = null;
    HTuple hv_numberOfNoTabRegion = null, hv_subindex = null;
    HTuple hv_totalLen = null, hv_stepOflen = null, hv_sliceRectRow1 = null;
    HTuple hv_sliceRectRow2 = null, hv_sliceRectCol1 = null;
    HTuple hv_sliceRectCol2 = null, hv_sliceIndexGap = null;
    HTuple hv_countOfleftTop = new HTuple(), hv_sliceIndex = new HTuple();
    HTuple hv_Row1sliceRect = null, hv_Col1sliceRect = null;
    HTuple hv_Row2sliceRect = null, hv_Col2sliceRect = null;
    HTuple hv_Row1SLobjNoTab = new HTuple(), hv_Col1SLobjNoTab = new HTuple();
    HTuple hv_Row2SLobjNoTab = new HTuple(), hv_Col2SLobjNoTab = new HTuple();
    HTuple hv_lenofRow1SLobjNoTab = new HTuple(), hv_Row1SLobjNoTabPLine = new HTuple();
    HTuple hv_Row1SLobjNoTabPLIndex = new HTuple(), hv_Values = null;
    HTuple hv_isideTab = null, hv_len = null, hv_y = null;
    HTuple hv_x = null, hv_xxxx = null, hv_idxxxx = null, hv_xtx = null;
    HTuple hv_xty = null, hv_invxtx = null, hv_beta = null;
    HTuple hv_Valueside = null, hv_towPointsCol = null, hv_Newy = null;
    HTuple hv_RowBegin = null, hv_ColBegin = null, hv_RowEnd = null;
    HTuple hv_ColEnd = null, hv_Nr = null, hv_Nc = null, hv_Dist = null;
    // Initialize local and output iconic variables 
    HOperatorSet.GenEmptyObj(out ho_RegionLinesFitSide);
    HOperatorSet.GenEmptyObj(out ho_SelectedRegionsS);
    HOperatorSet.GenEmptyObj(out ho_BatteryNoTabRegionsOut);
    HOperatorSet.GenEmptyObj(out ho_BatteryNoTabRegionsRect);
    HOperatorSet.GenEmptyObj(out ho_sliceRectRegions);
    HOperatorSet.GenEmptyObj(out ho_sliceRectRegionsROI);
    HOperatorSet.GenEmptyObj(out ho_sliceRectRegionsROIRaw);
    HOperatorSet.GenEmptyObj(out ho_sliceobjRectsssssssRemoved);
    HOperatorSet.GenEmptyObj(out ho_objNoTabRegionRect);
    HOperatorSet.GenEmptyObj(out ho_sliceRectobjNoTabRegions);
    HOperatorSet.GenEmptyObj(out ho_sliceobjRectRemoved);
    HOperatorSet.GenEmptyObj(out ho_RegionLinesFit);
    HOperatorSet.GenEmptyObj(out ho_sliceRectRegionsROISide);
    HOperatorSet.GenEmptyObj(out ho_ContoursliceRectRegionsROI);
    try
    {
      ho_SelectedRegionsS.Dispose();
      HOperatorSet.CopyObj(ho_BatteryNoTabRegions, out ho_SelectedRegionsS, 1, -1);
      //10.拟合底部直线进行拟合直线前的准备
      //剔除左边侧封区域
      //剔除每个区域的边缘
      //剔除区域内的最高点14%（当采样数量大于15时）
      ho_RegionLinesFitSide.Dispose();
      HOperatorSet.GenEmptyObj(out ho_RegionLinesFitSide);
      //shape_trans (BatteryNoTabRegionsOut, BatteryNoTabRegionsOut, 'convex')
      HOperatorSet.SmallestRectangle1(ho_SelectedRegionsS, out hv_Row1RectOut, out hv_Col1RectOut, 
          out hv_Row2RectOut, out hv_Col2RectOut);
      ho_BatteryNoTabRegionsOut.Dispose();
      HOperatorSet.SortRegion(ho_SelectedRegionsS, out ho_BatteryNoTabRegionsOut, 
          "upper_left", "true", "column");
      HOperatorSet.SmallestRectangle1(ho_BatteryNoTabRegionsOut, out hv_Row1BatteryNoTab, 
          out hv_Col1BatteryNoTab, out hv_Row2BatteryNoTab, out hv_Col2BatteryNoTab);
      ho_BatteryNoTabRegionsRect.Dispose();
      HOperatorSet.GenRectangle1(out ho_BatteryNoTabRegionsRect, hv_Row1BatteryNoTab, 
          hv_Col1BatteryNoTab, hv_Row2BatteryNoTab, hv_Col2BatteryNoTab);
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.Connection(ho_BatteryNoTabRegionsRect, out ExpTmpOutVar_0);
      ho_BatteryNoTabRegionsRect.Dispose();
      ho_BatteryNoTabRegionsRect = ExpTmpOutVar_0;
      }
      hv_lengthOfNoTabRegion = hv_Col2BatteryNoTab-hv_Col1BatteryNoTab;
      hv_numberOfNoTabRegion = new HTuple(hv_Row1BatteryNoTab.TupleLength());
      //剔除最左边的区域侧边封印区域
      if ((int)(new HTuple(((hv_lengthOfNoTabRegion.TupleSelect(0))).TupleGreater(
          160))) != 0)
      {
        if (hv_Col1BatteryNoTab == null)
          hv_Col1BatteryNoTab = new HTuple();
        hv_Col1BatteryNoTab[0] = (hv_Col1BatteryNoTab.TupleSelect(0))+10;
        if (hv_Col2BatteryNoTab == null)
          hv_Col2BatteryNoTab = new HTuple();
        hv_Col2BatteryNoTab[0] = (hv_Col2BatteryNoTab.TupleSelect(0))-10;
      }
      HTuple end_val19 = hv_numberOfNoTabRegion-1;
      HTuple step_val19 = 1;
      for (hv_subindex=1; hv_subindex.Continue(end_val19, step_val19); hv_subindex = hv_subindex.TupleAdd(step_val19))
      {
        if ((int)(new HTuple(((hv_lengthOfNoTabRegion.TupleSelect(hv_subindex))).TupleGreater(
            10))) != 0)
        {
          if (hv_Col1BatteryNoTab == null)
            hv_Col1BatteryNoTab = new HTuple();
          hv_Col1BatteryNoTab[hv_subindex] = (hv_Col1BatteryNoTab.TupleSelect(hv_subindex))+5;
          if (hv_Col2BatteryNoTab == null)
            hv_Col2BatteryNoTab = new HTuple();
          hv_Col2BatteryNoTab[hv_subindex] = (hv_Col2BatteryNoTab.TupleSelect(hv_subindex))-5;
        }
      }
      hv_lengthOfNoTabRegion = hv_Col2BatteryNoTab-hv_Col1BatteryNoTab;
      HOperatorSet.TupleSum(hv_lengthOfNoTabRegion, out hv_totalLen);
      hv_stepOflen = (hv_totalLen-200)/50;
      if ((int)(new HTuple(hv_stepOflen.TupleLess(2))) != 0)
      {
        hv_stepOflen = 2;
      }
      hv_sliceRectRow1 = new HTuple();
      hv_sliceRectRow2 = new HTuple();
      hv_sliceRectCol1 = new HTuple();
      hv_sliceRectCol2 = new HTuple();
      hv_sliceIndexGap = 0;
      HTuple end_val36 = hv_numberOfNoTabRegion-1;
      HTuple step_val36 = 1;
      for (hv_subindex=0; hv_subindex.Continue(end_val36, step_val36); hv_subindex = hv_subindex.TupleAdd(step_val36))
      {
        hv_countOfleftTop = (hv_lengthOfNoTabRegion.TupleSelect(hv_subindex))/hv_stepOflen;

        HTuple end_val39 = hv_sliceIndexGap+hv_countOfleftTop;
        HTuple step_val39 = 1;
        for (hv_sliceIndex=hv_sliceIndexGap; hv_sliceIndex.Continue(end_val39, step_val39); hv_sliceIndex = hv_sliceIndex.TupleAdd(step_val39))
        {
          if (hv_sliceRectRow1 == null)
            hv_sliceRectRow1 = new HTuple();
          hv_sliceRectRow1[hv_sliceIndex] = (hv_Row2BatteryNoTab.TupleSelect(hv_subindex))-30;
          if (hv_sliceRectRow2 == null)
            hv_sliceRectRow2 = new HTuple();
          hv_sliceRectRow2[hv_sliceIndex] = (hv_Row2BatteryNoTab.TupleSelect(hv_subindex))+30;
          if (hv_sliceRectCol1 == null)
            hv_sliceRectCol1 = new HTuple();
          hv_sliceRectCol1[hv_sliceIndex] = (hv_Col1BatteryNoTab.TupleSelect(hv_subindex))+((hv_sliceIndex-hv_sliceIndexGap)*hv_stepOflen);
          if (hv_sliceRectCol2 == null)
            hv_sliceRectCol2 = new HTuple();
          hv_sliceRectCol2[hv_sliceIndex] = (hv_Col1BatteryNoTab.TupleSelect(hv_subindex))+((hv_sliceIndex-hv_sliceIndexGap)*hv_stepOflen);
        }

        hv_sliceIndexGap = hv_sliceIndexGap+hv_countOfleftTop;

      }


      ho_sliceRectRegions.Dispose();
      HOperatorSet.GenRectangle1(out ho_sliceRectRegions, hv_sliceRectRow1, hv_sliceRectCol1, 
          hv_sliceRectRow2, hv_sliceRectCol2);
      ho_sliceRectRegionsROI.Dispose();
      HOperatorSet.Intersection(ho_sliceRectRegions, ho_BatteryNoTabRegionsOut, out ho_sliceRectRegionsROI
          );
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.ClosingRectangle1(ho_sliceRectRegionsROI, out ExpTmpOutVar_0, 
          1, 60);
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.Union1(ho_sliceRectRegionsROI, out ExpTmpOutVar_0);
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.FillUp(ho_sliceRectRegionsROI, out ExpTmpOutVar_0);
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.Connection(ho_sliceRectRegionsROI, out ExpTmpOutVar_0);
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.SortRegion(ho_sliceRectRegionsROI, out ExpTmpOutVar_0, "upper_left", 
          "true", "column");
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }
      HOperatorSet.SmallestRectangle1(ho_sliceRectRegionsROI, out hv_Row1sliceRect, 
          out hv_Col1sliceRect, out hv_Row2sliceRect, out hv_Col2sliceRect);
      ho_sliceRectRegionsROI.Dispose();
      HOperatorSet.GenRectangle1(out ho_sliceRectRegionsROI, hv_Row2sliceRect, hv_Col1sliceRect, 
          hv_Row2sliceRect, hv_Col2sliceRect);
      ho_sliceRectRegionsROIRaw.Dispose();
      HOperatorSet.Connection(ho_sliceRectRegionsROI, out ho_sliceRectRegionsROIRaw
          );


      //如果同一区域超出15个点,剔除最靠近上方的5个点
      ho_sliceobjRectsssssssRemoved.Dispose();
      HOperatorSet.GenEmptyObj(out ho_sliceobjRectsssssssRemoved);
      HTuple end_val65 = hv_numberOfNoTabRegion;
      HTuple step_val65 = 1;
      for (hv_subindex=1; hv_subindex.Continue(end_val65, step_val65); hv_subindex = hv_subindex.TupleAdd(step_val65))
      {
        ho_objNoTabRegionRect.Dispose();
        HOperatorSet.SelectObj(ho_BatteryNoTabRegionsRect, out ho_objNoTabRegionRect, 
            hv_subindex);
        ho_sliceRectobjNoTabRegions.Dispose();
        HOperatorSet.Intersection(ho_objNoTabRegionRect, ho_sliceRectRegionsROIRaw, 
            out ho_sliceRectobjNoTabRegions);
        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.Connection(ho_sliceRectobjNoTabRegions, out ExpTmpOutVar_0);
        ho_sliceRectobjNoTabRegions.Dispose();
        ho_sliceRectobjNoTabRegions = ExpTmpOutVar_0;
        }
        HOperatorSet.SmallestRectangle1(ho_sliceRectobjNoTabRegions, out hv_Row1SLobjNoTab, 
            out hv_Col1SLobjNoTab, out hv_Row2SLobjNoTab, out hv_Col2SLobjNoTab);
        hv_lenofRow1SLobjNoTab = new HTuple(hv_Row1SLobjNoTab.TupleLength());
        if ((int)(new HTuple(hv_lenofRow1SLobjNoTab.TupleGreater(15))) != 0)
        {
          HOperatorSet.TupleSortIndex(hv_Row1SLobjNoTab, out hv_Row1SLobjNoTabPLine);
          HOperatorSet.TupleSelectRange(hv_Row1SLobjNoTabPLine, 0, (hv_lenofRow1SLobjNoTab/7)-1, 
              out hv_Row1SLobjNoTabPLine);
          hv_Row1SLobjNoTabPLIndex = hv_Row1SLobjNoTabPLine+1;
          ho_sliceobjRectRemoved.Dispose();
          HOperatorSet.SelectObj(ho_sliceRectobjNoTabRegions, out ho_sliceobjRectRemoved, 
              hv_Row1SLobjNoTabPLIndex);
          {
          HObject ExpTmpOutVar_0;
          HOperatorSet.ConcatObj(ho_sliceobjRectsssssssRemoved, ho_sliceobjRectRemoved, 
              out ExpTmpOutVar_0);
          ho_sliceobjRectsssssssRemoved.Dispose();
          ho_sliceobjRectsssssssRemoved = ExpTmpOutVar_0;
          }
        }
      }
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.Difference(ho_sliceRectRegionsROI, ho_sliceobjRectsssssssRemoved, 
          out ExpTmpOutVar_0);
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }



      //11.以tab为界限,分别拟合直线?不行，如果相差比较远会得到很奇怪的拟合线
      ho_RegionLinesFit.Dispose();
      HOperatorSet.GenEmptyObj(out ho_RegionLinesFit);
      hv_Values = new HTuple();
      hv_Values[0] = 0;
      hv_Values[1] = 0;
      hv_Values[2] = 0;
      hv_Values[3] = 0;
      hv_isideTab = 2;
      //* for isideTab := 0 to 1 by 1
      //gen_empty_obj (sliceRectRegionsROISide)
      //if (isideTab=0)
        //concat_obj (sliceRectRegionsROISide, defineInnerRectsLeft, sliceRectRegionsROISide)
      //elseif (isideTab=1)
        //concat_obj (sliceRectRegionsROISide, defineInnerRectsRight, sliceRectRegionsROISide)
      //else
        //concat_obj (sliceRectRegionsROISide, defineInnerRects, sliceRectRegionsROISide)
      //endif
      //intersection (sliceRectRegionsROI, sliceRectRegionsROISide, sliceRectRegionsROISide)
      ho_sliceRectRegionsROISide.Dispose();
      HOperatorSet.SortRegion(ho_sliceRectRegionsROI, out ho_sliceRectRegionsROISide, 
          "upper_left", "true", "column");
      HOperatorSet.SmallestRectangle1(ho_sliceRectRegionsROISide, out hv_Row1sliceRect, 
          out hv_Col1sliceRect, out hv_Row2sliceRect, out hv_Col2sliceRect);

      hv_len = new HTuple(hv_Row2sliceRect.TupleLength());
      HOperatorSet.CreateMatrix(hv_len, 1, hv_Row2sliceRect, out hv_y);
      HOperatorSet.CreateMatrix(hv_len, 2, 1, out hv_x);
      hv_xxxx = new HTuple();
      HTuple end_val104 = hv_len-1;
      HTuple step_val104 = 1;
      for (hv_idxxxx=0; hv_idxxxx.Continue(end_val104, step_val104); hv_idxxxx = hv_idxxxx.TupleAdd(step_val104))
      {
        if (hv_xxxx == null)
          hv_xxxx = new HTuple();
        hv_xxxx[hv_idxxxx] = hv_idxxxx;
      }
      HOperatorSet.SetValueMatrix(hv_x, hv_xxxx, HTuple.TupleGenConst(hv_len,0), 
          hv_Col2sliceRect);

      HOperatorSet.MultMatrix(hv_x, hv_x, "ATB", out hv_xtx);
      HOperatorSet.MultMatrix(hv_x, hv_y, "ATB", out hv_xty);

      HOperatorSet.InvertMatrix(hv_xtx, "general", 0, out hv_invxtx);
      HOperatorSet.MultMatrix(hv_invxtx, hv_xty, "AB", out hv_beta);
      HOperatorSet.GetFullMatrix(hv_beta, out hv_Valueside);

      if (hv_Values == null)
        hv_Values = new HTuple();
      hv_Values[(hv_isideTab*2)+0] = hv_Valueside.TupleSelect(0);
      if (hv_Values == null)
        hv_Values = new HTuple();
      hv_Values[(hv_isideTab*2)+1] = hv_Valueside.TupleSelect(1);
      hv_towPointsCol = new HTuple();
      hv_towPointsCol = hv_towPointsCol.TupleConcat(hv_Col1RectOut);
      hv_towPointsCol = hv_towPointsCol.TupleConcat(hv_Col2RectOut);
      //if (isideTab=0)
        //towPointsCol := [300,Col1Tab[1]]
      //elseif (isideTab=1)
        //towPointsCol := [Col2Tab[0],Col2Tab[1]+700]
      //else
        //isideTab := 0
        //Values[isideTab*2+0] := Valueside[0]
        //Values[isideTab*2+1] := Valueside[1]
        //towPointsCol := [300,Col2Tab[1]+700]
      //endif

      hv_Newy = ((hv_Values.TupleSelect((hv_isideTab*2)+0))*hv_towPointsCol)+(hv_Values.TupleSelect(
          (hv_isideTab*2)+1));

      ho_ContoursliceRectRegionsROI.Dispose();
      HOperatorSet.GenContourPolygonXld(out ho_ContoursliceRectRegionsROI, hv_Newy, 
          hv_towPointsCol);
      HOperatorSet.FitLineContourXld(ho_ContoursliceRectRegionsROI, "gauss", -1, 
          0, 5, 1, out hv_RowBegin, out hv_ColBegin, out hv_RowEnd, out hv_ColEnd, 
          out hv_Nr, out hv_Nc, out hv_Dist);
      ho_RegionLinesFitSide.Dispose();
      HOperatorSet.GenRegionLine(out ho_RegionLinesFitSide, hv_RowBegin, hv_ColBegin, 
          hv_RowEnd, hv_ColEnd);
      ho_SelectedRegionsS.Dispose();
      ho_BatteryNoTabRegionsOut.Dispose();
      ho_BatteryNoTabRegionsRect.Dispose();
      ho_sliceRectRegions.Dispose();
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROIRaw.Dispose();
      ho_sliceobjRectsssssssRemoved.Dispose();
      ho_objNoTabRegionRect.Dispose();
      ho_sliceRectobjNoTabRegions.Dispose();
      ho_sliceobjRectRemoved.Dispose();
      ho_RegionLinesFit.Dispose();
      ho_sliceRectRegionsROISide.Dispose();
      ho_ContoursliceRectRegionsROI.Dispose();

      return;
    }
    catch (HalconException HDevExpDefaultException)
    {
      ho_SelectedRegionsS.Dispose();
      ho_BatteryNoTabRegionsOut.Dispose();
      ho_BatteryNoTabRegionsRect.Dispose();
      ho_sliceRectRegions.Dispose();
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROIRaw.Dispose();
      ho_sliceobjRectsssssssRemoved.Dispose();
      ho_objNoTabRegionRect.Dispose();
      ho_sliceRectobjNoTabRegions.Dispose();
      ho_sliceobjRectRemoved.Dispose();
      ho_RegionLinesFit.Dispose();
      ho_sliceRectRegionsROISide.Dispose();
      ho_ContoursliceRectRegionsROI.Dispose();

      throw HDevExpDefaultException;
    }
  }

  public void Battery_In_or_Out_Tray_White_Insp (HObject ho_Image, HTuple hv_WindowHandle, 
      HTuple hv_Main_InterFace, HTuple hv_Tuple, out HTuple hv_bBatteryFinalResultRet)
  {
    // Stack for temporary objects 
    HObject[] OTemp = new HObject[20];

    // Local iconic variables 

    HObject ho_Rectangle=null, ho_ImageReduced=null;
    HObject ho_ImageReduced1=null, ho_ImageReduced2=null, ho_Region1=null;
    HObject ho_Region2=null, ho_ConnectedRegions1=null, ho_ConnectedRegions2=null;
    HObject ho_SelectedRegions1=null, ho_SelectedRegions2=null;
    HObject ho_SelectedRegions_1=null, ho_ObjectsConcat=null;

    // Local copy input parameter variables 
    HObject ho_Image_COPY_INP_TMP;
    ho_Image_COPY_INP_TMP = ho_Image.CopyObj(1,-1);



    // Local control variables 

    HTuple hv_Mean = new HTuple(), hv_Deviation = new HTuple();
    HTuple hv_Number1 = new HTuple(), hv_Exception = null;
    // Initialize local and output iconic variables 
    HOperatorSet.GenEmptyObj(out ho_Rectangle);
    HOperatorSet.GenEmptyObj(out ho_ImageReduced);
    HOperatorSet.GenEmptyObj(out ho_ImageReduced1);
    HOperatorSet.GenEmptyObj(out ho_ImageReduced2);
    HOperatorSet.GenEmptyObj(out ho_Region1);
    HOperatorSet.GenEmptyObj(out ho_Region2);
    HOperatorSet.GenEmptyObj(out ho_ConnectedRegions1);
    HOperatorSet.GenEmptyObj(out ho_ConnectedRegions2);
    HOperatorSet.GenEmptyObj(out ho_SelectedRegions1);
    HOperatorSet.GenEmptyObj(out ho_SelectedRegions2);
    HOperatorSet.GenEmptyObj(out ho_SelectedRegions_1);
    HOperatorSet.GenEmptyObj(out ho_ObjectsConcat);
    hv_bBatteryFinalResultRet = new HTuple();
    try
    {
      try
      {
        if ((int)(new HTuple(((hv_Tuple.TupleSelect(2))).TupleNotEqual(0))) != 0)
        {
          ho_Image_COPY_INP_TMP.Dispose();
          ho_Rectangle.Dispose();
          ho_ImageReduced.Dispose();
          ho_ImageReduced1.Dispose();
          ho_ImageReduced2.Dispose();
          ho_Region1.Dispose();
          ho_Region2.Dispose();
          ho_ConnectedRegions1.Dispose();
          ho_ConnectedRegions2.Dispose();
          ho_SelectedRegions1.Dispose();
          ho_SelectedRegions2.Dispose();
          ho_SelectedRegions_1.Dispose();
          ho_ObjectsConcat.Dispose();

          return;
        }
        //************输出变量初始化******************
        //***是否有电池（1表示有，否则无）
        hv_bBatteryFinalResultRet = 0;


        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.RotateImage(ho_Image_COPY_INP_TMP, out ExpTmpOutVar_0, (hv_Main_InterFace.TupleSelect(
            6))*57.3, "constant");
        ho_Image_COPY_INP_TMP.Dispose();
        ho_Image_COPY_INP_TMP = ExpTmpOutVar_0;
        }




        //**********************************************（一）检测有无电芯存在*********************************************************
        ho_Rectangle.Dispose();
        HOperatorSet.GenRectangle1(out ho_Rectangle, (hv_Main_InterFace.TupleSelect(
            2))+15, (hv_Main_InterFace.TupleSelect(1))+25, (hv_Main_InterFace.TupleSelect(
            3))-20, (hv_Main_InterFace.TupleSelect(0))-17);
        ho_ImageReduced.Dispose();
        HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle, out ho_ImageReduced
            );
        ho_ImageReduced1.Dispose();
        HOperatorSet.Emphasize(ho_ImageReduced, out ho_ImageReduced1, 10, 10, 10);
        ho_ImageReduced2.Dispose();
        HOperatorSet.Emphasize(ho_ImageReduced, out ho_ImageReduced2, 10, 10, 3);
        HOperatorSet.Intensity(ho_Rectangle, ho_ImageReduced, out hv_Mean, out hv_Deviation);
        ho_Region1.Dispose();
        HOperatorSet.Threshold(ho_ImageReduced1, out ho_Region1, 0, hv_Mean/2);
        ho_Region2.Dispose();
        HOperatorSet.Threshold(ho_ImageReduced2, out ho_Region2, 240, 255);
        ho_ConnectedRegions1.Dispose();
        HOperatorSet.Connection(ho_Region1, out ho_ConnectedRegions1);
        ho_ConnectedRegions2.Dispose();
        HOperatorSet.Connection(ho_Region2, out ho_ConnectedRegions2);
        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.FillUp(ho_ConnectedRegions1, out ExpTmpOutVar_0);
        ho_ConnectedRegions1.Dispose();
        ho_ConnectedRegions1 = ExpTmpOutVar_0;
        }
        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.FillUp(ho_ConnectedRegions2, out ExpTmpOutVar_0);
        ho_ConnectedRegions2.Dispose();
        ho_ConnectedRegions2 = ExpTmpOutVar_0;
        }
        ho_SelectedRegions1.Dispose();
        HOperatorSet.SelectShape(ho_ConnectedRegions1, out ho_SelectedRegions1, (
            (new HTuple("area")).TupleConcat("rectangularity")).TupleConcat("width"), 
            "and", ((new HTuple(700)).TupleConcat(0.85)).TupleConcat(25), ((new HTuple(4000)).TupleConcat(
            1)).TupleConcat(40));
        ho_SelectedRegions2.Dispose();
        HOperatorSet.SelectShape(ho_ConnectedRegions2, out ho_SelectedRegions2, ((
            (new HTuple("column1")).TupleConcat("width")).TupleConcat("column2")).TupleConcat(
            "width"), "and", (((((hv_Main_InterFace.TupleSelect(1))+30)).TupleConcat(
            25))).TupleConcat((((hv_Main_InterFace.TupleSelect(0))-50)).TupleConcat(
            25)), (((((hv_Main_InterFace.TupleSelect(1))+60)).TupleConcat(45))).TupleConcat(
            (((hv_Main_InterFace.TupleSelect(0))-25)).TupleConcat(45)));
        ho_SelectedRegions_1.Dispose();
        HOperatorSet.SelectShapeStd(ho_SelectedRegions1, out ho_SelectedRegions_1, 
            "rectangle1", 80);
        ho_ObjectsConcat.Dispose();
        HOperatorSet.ConcatObj(ho_SelectedRegions_1, ho_SelectedRegions2, out ho_ObjectsConcat
            );
        HOperatorSet.CountObj(ho_ObjectsConcat, out hv_Number1);

        if ((int)(new HTuple(hv_Number1.TupleGreater(0))) != 0)
        {
          hv_bBatteryFinalResultRet = 1;
        }
        else
        {
          hv_bBatteryFinalResultRet = 0;
        }

      }
      // catch (Exception) 
      catch (HalconException HDevExpDefaultException1)
      {
        HDevExpDefaultException1.ToHTuple(out hv_Exception);
        hv_bBatteryFinalResultRet = 0;
      }
      ho_Image_COPY_INP_TMP.Dispose();
      ho_Rectangle.Dispose();
      ho_ImageReduced.Dispose();
      ho_ImageReduced1.Dispose();
      ho_ImageReduced2.Dispose();
      ho_Region1.Dispose();
      ho_Region2.Dispose();
      ho_ConnectedRegions1.Dispose();
      ho_ConnectedRegions2.Dispose();
      ho_SelectedRegions1.Dispose();
      ho_SelectedRegions2.Dispose();
      ho_SelectedRegions_1.Dispose();
      ho_ObjectsConcat.Dispose();

      return;
    }
    catch (HalconException HDevExpDefaultException)
    {
      ho_Image_COPY_INP_TMP.Dispose();
      ho_Rectangle.Dispose();
      ho_ImageReduced.Dispose();
      ho_ImageReduced1.Dispose();
      ho_ImageReduced2.Dispose();
      ho_Region1.Dispose();
      ho_Region2.Dispose();
      ho_ConnectedRegions1.Dispose();
      ho_ConnectedRegions2.Dispose();
      ho_SelectedRegions1.Dispose();
      ho_SelectedRegions2.Dispose();
      ho_SelectedRegions_1.Dispose();
      ho_ObjectsConcat.Dispose();

      throw HDevExpDefaultException;
    }
  }

  public void Tray_Positioning_Wht_and_Wht_Insp (HObject ho_Image, HTuple hv_WindowHandle, 
      HTuple hv_Main_InterFace, HTuple hv_Tuple, HTuple hv_InterFace_Offset, HTuple hv_InterFace_Top, 
      HTuple hv_InterFace, HTuple hv_InterFace_Threshold, HTuple hv_Empty_Main_InterFace, 
      out HTuple hv_bMisalignmentFinalResultRet)
  {




    // Stack for temporary objects 
    HObject[] OTemp = new HObject[20];

    // Local iconic variables 

    HObject ho_Rectangle=null, ho_ImageReduced=null;
    HObject ho_Region1=null, ho_Rectangle3=null, ho_ImageReduced1=null;
    HObject ho_RegionDilation=null, ho_RegionErosion=null, ho_ConnectedRegions=null;
    HObject ho_SelectedRegions1_1=null, ho_RegionUnion=null;
    HObject ho_ImageReduced2=null, ho_Region2=null, ho_ConnectedRegions2=null;
    HObject ho_SelectedRegions2=null;

    // Local copy input parameter variables 
    HObject ho_Image_COPY_INP_TMP;
    ho_Image_COPY_INP_TMP = ho_Image.CopyObj(1,-1);



    // Local control variables 

    HTuple hv_Row3 = new HTuple(), hv_Row4 = new HTuple();
    HTuple hv_Row1 = new HTuple(), hv_col1 = new HTuple();
    HTuple hv_Row2 = new HTuple(), hv_col2 = new HTuple();
    HTuple hv_Number = new HTuple(), hv_Row11 = new HTuple();
    HTuple hv_Column1 = new HTuple(), hv_Row21 = new HTuple();
    HTuple hv_Column2 = new HTuple(), hv_Exception = null;
    // Initialize local and output iconic variables 
    HOperatorSet.GenEmptyObj(out ho_Rectangle);
    HOperatorSet.GenEmptyObj(out ho_ImageReduced);
    HOperatorSet.GenEmptyObj(out ho_Region1);
    HOperatorSet.GenEmptyObj(out ho_Rectangle3);
    HOperatorSet.GenEmptyObj(out ho_ImageReduced1);
    HOperatorSet.GenEmptyObj(out ho_RegionDilation);
    HOperatorSet.GenEmptyObj(out ho_RegionErosion);
    HOperatorSet.GenEmptyObj(out ho_ConnectedRegions);
    HOperatorSet.GenEmptyObj(out ho_SelectedRegions1_1);
    HOperatorSet.GenEmptyObj(out ho_RegionUnion);
    HOperatorSet.GenEmptyObj(out ho_ImageReduced2);
    HOperatorSet.GenEmptyObj(out ho_Region2);
    HOperatorSet.GenEmptyObj(out ho_ConnectedRegions2);
    HOperatorSet.GenEmptyObj(out ho_SelectedRegions2);
    hv_bMisalignmentFinalResultRet = new HTuple();
    try
    {
      try
      {
        if ((int)(new HTuple(((hv_Tuple.TupleSelect(2))).TupleNotEqual(1))) != 0)
        {
          ho_Image_COPY_INP_TMP.Dispose();
          ho_Rectangle.Dispose();
          ho_ImageReduced.Dispose();
          ho_Region1.Dispose();
          ho_Rectangle3.Dispose();
          ho_ImageReduced1.Dispose();
          ho_RegionDilation.Dispose();
          ho_RegionErosion.Dispose();
          ho_ConnectedRegions.Dispose();
          ho_SelectedRegions1_1.Dispose();
          ho_RegionUnion.Dispose();
          ho_ImageReduced2.Dispose();
          ho_Region2.Dispose();
          ho_ConnectedRegions2.Dispose();
          ho_SelectedRegions2.Dispose();

          return;
        }
        //************输出变量初始化******************
        //***是否有电池（1表示有，否则无）
        //bBatteryFinalResultRet := 0
        //***是否电池错位（1表示错位，否则无）
        hv_bMisalignmentFinalResultRet = 0;

        //***********************************找一幅合适的图像，用来校正角度**************************************


        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.RotateImage(ho_Image_COPY_INP_TMP, out ExpTmpOutVar_0, (hv_Main_InterFace.TupleSelect(
            2))*57.3, "constant");
        ho_Image_COPY_INP_TMP.Dispose();
        ho_Image_COPY_INP_TMP = ExpTmpOutVar_0;
        }


        //***********************************************只对黑色料盘盒银色电池需要**************************************************************
        //gen_rectangle1 (Rectangle, Dis_Row_Protrusion_R1-15, Dis_Col_L3-15, Dis_Row_Protrusion_R1+15, Dis_Col_R3+15)
        //reduce_domain (Image, Rectangle, ImageReduced)
        //area_center (Rectangle, Area_Total, Row3, Column3)
        //threshold (ImageReduced, Region1, 180, 255)
        //area_center (Region1, Area_Light, Row4, Column4)
        //Area_ratio := Area_Light*1.0/Area_Total
        //if (Area_ratio >0.3)
          //**如果此处bFinalResult0:=1，一定是电池越界
          //bMisalignmentFinalResultRet := 1
          //return ()
        //else

        //endif
        if ((int)((new HTuple((new HTuple(hv_Main_InterFace.TupleLength())).TupleEqual(
            6))).TupleAnd(new HTuple(((hv_Tuple.TupleSelect(1))).TupleEqual(1)))) != 0)
        {

        }
        else if ((int)((new HTuple((new HTuple(hv_Main_InterFace.TupleLength()
            )).TupleEqual(5))).TupleAnd(new HTuple(((hv_Tuple.TupleSelect(1))).TupleNotEqual(
            1)))) != 0)
        {
        }
        else
        {
          hv_bMisalignmentFinalResultRet = 1;
          ho_Image_COPY_INP_TMP.Dispose();
          ho_Rectangle.Dispose();
          ho_ImageReduced.Dispose();
          ho_Region1.Dispose();
          ho_Rectangle3.Dispose();
          ho_ImageReduced1.Dispose();
          ho_RegionDilation.Dispose();
          ho_RegionErosion.Dispose();
          ho_ConnectedRegions.Dispose();
          ho_SelectedRegions1_1.Dispose();
          ho_RegionUnion.Dispose();
          ho_ImageReduced2.Dispose();
          ho_Region2.Dispose();
          ho_ConnectedRegions2.Dispose();
          ho_SelectedRegions2.Dispose();

          return;
        }

        //******************检测电池的左侧是否越界***********************
        hv_Row1 = ((((hv_Main_InterFace.TupleSelect(0))-(hv_Empty_Main_InterFace.TupleSelect(
            11)))+(hv_Empty_Main_InterFace.TupleSelect(6)))+(hv_Main_InterFace.TupleSelect(
            4)))+(hv_InterFace_Offset.TupleSelect(1));
        hv_col1 = (((hv_Main_InterFace.TupleSelect(1))-(hv_Empty_Main_InterFace.TupleSelect(
            12)))+(hv_Empty_Main_InterFace.TupleSelect(10)))-(hv_Main_InterFace.TupleSelect(
            3));
        hv_Row2 = ((((hv_Main_InterFace.TupleSelect(0))-(hv_Empty_Main_InterFace.TupleSelect(
            11)))+(hv_Empty_Main_InterFace.TupleSelect(4)))+(hv_Main_InterFace.TupleSelect(
            4)))-80;
        hv_col2 = ((((hv_Main_InterFace.TupleSelect(1))-(hv_Empty_Main_InterFace.TupleSelect(
            12)))+(hv_Empty_Main_InterFace.TupleSelect(10)))-(hv_Main_InterFace.TupleSelect(
            3)))+50;
        ho_Rectangle3.Dispose();
        HOperatorSet.GenRectangle1(out ho_Rectangle3, hv_Row1, hv_col1+(hv_InterFace_Offset.TupleSelect(
            3)), hv_Row2-20, hv_col2);
        ho_ImageReduced.Dispose();
        HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle3, out ho_ImageReduced
            );
        ho_ImageReduced1.Dispose();
        HOperatorSet.Emphasize(ho_ImageReduced, out ho_ImageReduced1, 10, 10, 3);
        ho_Region1.Dispose();
        HOperatorSet.Threshold(ho_ImageReduced1, out ho_Region1, hv_InterFace_Threshold.TupleSelect(
            1), hv_InterFace_Threshold.TupleSelect(2));
        ho_RegionDilation.Dispose();
        HOperatorSet.DilationRectangle1(ho_Region1, out ho_RegionDilation, 1, 10);
        ho_RegionErosion.Dispose();
        HOperatorSet.ErosionRectangle1(ho_RegionDilation, out ho_RegionErosion, 1, 
            2);
        //connection (RegionErosion, ConnectedRegions1)
        //select_shape (ConnectedRegions1, SelectedRegions1, ['area','height'], 'and', [(Row2-Row1)*2,Row2-Row1], [99999,Row2-Row1+20])
        //count_obj (SelectedRegions1, Number)
        //if (Number>=2)
        //else
          //bMisalignmentFinalResultRet := 1
          //return ()
        //endif
        ho_ConnectedRegions.Dispose();
        HOperatorSet.Connection(ho_RegionErosion, out ho_ConnectedRegions);
        ho_SelectedRegions1_1.Dispose();
        HOperatorSet.SelectShape(ho_ConnectedRegions, out ho_SelectedRegions1_1, 
            (new HTuple("area")).TupleConcat("height"), "and", (((hv_Row2-hv_Row1)/2)).TupleConcat(
            (hv_Row2-hv_Row1)/3), (new HTuple(99999)).TupleConcat((hv_Row2-hv_Row1)+10));
        ho_RegionUnion.Dispose();
        HOperatorSet.Union1(ho_SelectedRegions1_1, out ho_RegionUnion);
        HOperatorSet.SmallestRectangle1(ho_RegionUnion, out hv_Row11, out hv_Column1, 
            out hv_Row21, out hv_Column2);
        ho_Rectangle.Dispose();
        HOperatorSet.GenRectangle1(out ho_Rectangle, hv_Row1, hv_Column1+3, hv_Row2, 
            hv_Column2-2);
        ho_ImageReduced2.Dispose();
        HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle, out ho_ImageReduced2
            );
        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.Emphasize(ho_ImageReduced2, out ExpTmpOutVar_0, 10, 10, 3);
        ho_ImageReduced2.Dispose();
        ho_ImageReduced2 = ExpTmpOutVar_0;
        }
        ho_Region2.Dispose();
        HOperatorSet.Threshold(ho_ImageReduced2, out ho_Region2, 0, hv_InterFace_Threshold.TupleSelect(
            1));
        ho_ConnectedRegions2.Dispose();
        HOperatorSet.Connection(ho_Region2, out ho_ConnectedRegions2);
        ho_SelectedRegions2.Dispose();
        HOperatorSet.SelectShape(ho_ConnectedRegions2, out ho_SelectedRegions2, (new HTuple("area")).TupleConcat(
            "height"), "and", (((hv_Row2-hv_Row1)*2)).TupleConcat((hv_Row2-hv_Row1)-10), 
            (new HTuple(99999)).TupleConcat((hv_Row2-hv_Row1)+10));
        HOperatorSet.CountObj(ho_SelectedRegions2, out hv_Number);
        if ((int)(new HTuple(hv_Number.TupleGreaterEqual(1))) != 0)
        {
        }
        else
        {
          hv_bMisalignmentFinalResultRet = 1;
          ho_Image_COPY_INP_TMP.Dispose();
          ho_Rectangle.Dispose();
          ho_ImageReduced.Dispose();
          ho_Region1.Dispose();
          ho_Rectangle3.Dispose();
          ho_ImageReduced1.Dispose();
          ho_RegionDilation.Dispose();
          ho_RegionErosion.Dispose();
          ho_ConnectedRegions.Dispose();
          ho_SelectedRegions1_1.Dispose();
          ho_RegionUnion.Dispose();
          ho_ImageReduced2.Dispose();
          ho_Region2.Dispose();
          ho_ConnectedRegions2.Dispose();
          ho_SelectedRegions2.Dispose();

          return;
        }


        hv_Row3 = (((((hv_Main_InterFace.TupleSelect(0))-(hv_Empty_Main_InterFace.TupleSelect(
            11)))+(hv_Empty_Main_InterFace.TupleSelect(4)))-((hv_InterFace.TupleSelect(
            13))/(hv_InterFace.TupleSelect(14))))+(hv_Main_InterFace.TupleSelect(
            4)))+50;
        hv_Row4 = ((((hv_Main_InterFace.TupleSelect(0))-(hv_Empty_Main_InterFace.TupleSelect(
            11)))+(hv_Empty_Main_InterFace.TupleSelect(5)))+(hv_Main_InterFace.TupleSelect(
            4)))-(hv_InterFace_Offset.TupleSelect(1));
        ho_Rectangle3.Dispose();
        HOperatorSet.GenRectangle1(out ho_Rectangle3, hv_Row3, hv_col1+(hv_InterFace_Offset.TupleSelect(
            3)), hv_Row4, hv_col2);
        ho_ImageReduced.Dispose();
        HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle3, out ho_ImageReduced
            );
        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.Emphasize(ho_ImageReduced, out ExpTmpOutVar_0, 10, 10, 3);
        ho_ImageReduced.Dispose();
        ho_ImageReduced = ExpTmpOutVar_0;
        }
        ho_Region1.Dispose();
        HOperatorSet.Threshold(ho_ImageReduced, out ho_Region1, hv_InterFace_Threshold.TupleSelect(
            1), hv_InterFace_Threshold.TupleSelect(2));
        ho_RegionDilation.Dispose();
        HOperatorSet.DilationRectangle1(ho_Region1, out ho_RegionDilation, 1, 10);
        ho_RegionErosion.Dispose();
        HOperatorSet.ErosionRectangle1(ho_RegionDilation, out ho_RegionErosion, 1, 
            2);
        //connection (RegionErosion, ConnectedRegions1)
        //select_shape (ConnectedRegions1, SelectedRegions1, ['area','height'], 'and', [(Row4-Row3)*2,Row4-Row3], [99999,Row4-Row3+20])
        //count_obj (SelectedRegions1, Number)
        //if (Number>=2)
        //else
          //bMisalignmentFinalResultRet := 1
          //return ()
        //endif
        ho_ConnectedRegions.Dispose();
        HOperatorSet.Connection(ho_RegionErosion, out ho_ConnectedRegions);
        ho_SelectedRegions1_1.Dispose();
        HOperatorSet.SelectShape(ho_ConnectedRegions, out ho_SelectedRegions1_1, 
            (new HTuple("area")).TupleConcat("height"), "and", (((hv_Row4-hv_Row3)/2)).TupleConcat(
            (hv_Row4-hv_Row3)/3), (new HTuple(99999)).TupleConcat((hv_Row4-hv_Row3)+10));
        ho_RegionUnion.Dispose();
        HOperatorSet.Union1(ho_SelectedRegions1_1, out ho_RegionUnion);
        HOperatorSet.SmallestRectangle1(ho_RegionUnion, out hv_Row11, out hv_Column1, 
            out hv_Row21, out hv_Column2);
        ho_Rectangle.Dispose();
        HOperatorSet.GenRectangle1(out ho_Rectangle, hv_Row3, hv_Column1+3, hv_Row4, 
            hv_Column2-2);
        ho_ImageReduced2.Dispose();
        HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle, out ho_ImageReduced2
            );
        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.Emphasize(ho_ImageReduced2, out ExpTmpOutVar_0, 10, 10, 3);
        ho_ImageReduced2.Dispose();
        ho_ImageReduced2 = ExpTmpOutVar_0;
        }
        ho_Region2.Dispose();
        HOperatorSet.Threshold(ho_ImageReduced2, out ho_Region2, 0, hv_InterFace_Threshold.TupleSelect(
            1));
        ho_ConnectedRegions2.Dispose();
        HOperatorSet.Connection(ho_Region2, out ho_ConnectedRegions2);
        ho_SelectedRegions2.Dispose();
        HOperatorSet.SelectShape(ho_ConnectedRegions2, out ho_SelectedRegions2, (new HTuple("area")).TupleConcat(
            "height"), "and", (((hv_Row4-hv_Row3)*2)).TupleConcat((hv_Row4-hv_Row3)-10), 
            (new HTuple(99999)).TupleConcat((hv_Row4-hv_Row3)+10));
        HOperatorSet.CountObj(ho_SelectedRegions2, out hv_Number);
        if ((int)(new HTuple(hv_Number.TupleGreaterEqual(1))) != 0)
        {
        }
        else
        {
          hv_bMisalignmentFinalResultRet = 1;
          ho_Image_COPY_INP_TMP.Dispose();
          ho_Rectangle.Dispose();
          ho_ImageReduced.Dispose();
          ho_Region1.Dispose();
          ho_Rectangle3.Dispose();
          ho_ImageReduced1.Dispose();
          ho_RegionDilation.Dispose();
          ho_RegionErosion.Dispose();
          ho_ConnectedRegions.Dispose();
          ho_SelectedRegions1_1.Dispose();
          ho_RegionUnion.Dispose();
          ho_ImageReduced2.Dispose();
          ho_Region2.Dispose();
          ho_ConnectedRegions2.Dispose();
          ho_SelectedRegions2.Dispose();

          return;
        }


        //******************检测电池的右侧是否越界***********************

        ho_Rectangle3.Dispose();
        HOperatorSet.GenRectangle1(out ho_Rectangle3, hv_Row1, (hv_col1+(hv_InterFace_Offset.TupleSelect(
            3)))+((hv_InterFace.TupleSelect(12))/(hv_InterFace.TupleSelect(14))), 
            hv_Row2, hv_col2+((hv_InterFace.TupleSelect(12))/(hv_InterFace.TupleSelect(
            14))));
        ho_ImageReduced.Dispose();
        HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle3, out ho_ImageReduced
            );
        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.Emphasize(ho_ImageReduced, out ExpTmpOutVar_0, 10, 10, 3);
        ho_ImageReduced.Dispose();
        ho_ImageReduced = ExpTmpOutVar_0;
        }
        ho_Region1.Dispose();
        HOperatorSet.Threshold(ho_ImageReduced, out ho_Region1, hv_InterFace_Threshold.TupleSelect(
            1), hv_InterFace_Threshold.TupleSelect(2));
        ho_RegionDilation.Dispose();
        HOperatorSet.DilationRectangle1(ho_Region1, out ho_RegionDilation, 1, 10);
        ho_RegionErosion.Dispose();
        HOperatorSet.ErosionRectangle1(ho_RegionDilation, out ho_RegionErosion, 1, 
            2);
        //connection (RegionErosion, ConnectedRegions1)
        //select_shape (ConnectedRegions1, SelectedRegions1, ['area','height'], 'and', [(Row2-Row1)*1,Row2-Row1], [99999,Row2-Row1+20])
        //count_obj (SelectedRegions1, Number)
        //if (Number>=2)
        //else
          //bMisalignmentFinalResultRet := 1
          //return ()
        //endif
        ho_ConnectedRegions.Dispose();
        HOperatorSet.Connection(ho_RegionErosion, out ho_ConnectedRegions);
        ho_SelectedRegions1_1.Dispose();
        HOperatorSet.SelectShape(ho_ConnectedRegions, out ho_SelectedRegions1_1, 
            (new HTuple("area")).TupleConcat("height"), "and", (((hv_Row2-hv_Row1)/2)).TupleConcat(
            (hv_Row2-hv_Row1)/3), (new HTuple(99999)).TupleConcat((hv_Row2-hv_Row1)+10));
        ho_RegionUnion.Dispose();
        HOperatorSet.Union1(ho_SelectedRegions1_1, out ho_RegionUnion);
        HOperatorSet.SmallestRectangle1(ho_RegionUnion, out hv_Row11, out hv_Column1, 
            out hv_Row21, out hv_Column2);
        ho_Rectangle.Dispose();
        HOperatorSet.GenRectangle1(out ho_Rectangle, hv_Row1, hv_Column1+3, hv_Row2, 
            hv_Column2-2);
        ho_ImageReduced2.Dispose();
        HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle, out ho_ImageReduced2
            );
        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.Emphasize(ho_ImageReduced2, out ExpTmpOutVar_0, 10, 10, 3);
        ho_ImageReduced2.Dispose();
        ho_ImageReduced2 = ExpTmpOutVar_0;
        }
        ho_Region2.Dispose();
        HOperatorSet.Threshold(ho_ImageReduced2, out ho_Region2, 0, hv_InterFace_Threshold.TupleSelect(
            1));
        ho_ConnectedRegions2.Dispose();
        HOperatorSet.Connection(ho_Region2, out ho_ConnectedRegions2);
        ho_SelectedRegions2.Dispose();
        HOperatorSet.SelectShape(ho_ConnectedRegions2, out ho_SelectedRegions2, (new HTuple("area")).TupleConcat(
            "height"), "and", (((hv_Row2-hv_Row1)*2)).TupleConcat((hv_Row2-hv_Row1)-10), 
            (new HTuple(99999)).TupleConcat((hv_Row2-hv_Row1)+10));
        HOperatorSet.CountObj(ho_SelectedRegions2, out hv_Number);
        if ((int)(new HTuple(hv_Number.TupleGreaterEqual(1))) != 0)
        {
        }
        else
        {
          hv_bMisalignmentFinalResultRet = 1;
          ho_Image_COPY_INP_TMP.Dispose();
          ho_Rectangle.Dispose();
          ho_ImageReduced.Dispose();
          ho_Region1.Dispose();
          ho_Rectangle3.Dispose();
          ho_ImageReduced1.Dispose();
          ho_RegionDilation.Dispose();
          ho_RegionErosion.Dispose();
          ho_ConnectedRegions.Dispose();
          ho_SelectedRegions1_1.Dispose();
          ho_RegionUnion.Dispose();
          ho_ImageReduced2.Dispose();
          ho_Region2.Dispose();
          ho_ConnectedRegions2.Dispose();
          ho_SelectedRegions2.Dispose();

          return;
        }


        ho_Rectangle3.Dispose();
        HOperatorSet.GenRectangle1(out ho_Rectangle3, hv_Row3, (hv_col1+((hv_InterFace.TupleSelect(
            12))/(hv_InterFace.TupleSelect(14))))+(hv_InterFace_Offset.TupleSelect(
            3)), hv_Row4, hv_col2+((hv_InterFace.TupleSelect(12))/(hv_InterFace.TupleSelect(
            14))));
        ho_ImageReduced.Dispose();
        HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle3, out ho_ImageReduced
            );
        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.Emphasize(ho_ImageReduced, out ExpTmpOutVar_0, 10, 10, 3);
        ho_ImageReduced.Dispose();
        ho_ImageReduced = ExpTmpOutVar_0;
        }
        ho_Region1.Dispose();
        HOperatorSet.Threshold(ho_ImageReduced, out ho_Region1, hv_InterFace_Threshold.TupleSelect(
            1), hv_InterFace_Threshold.TupleSelect(2));
        ho_RegionDilation.Dispose();
        HOperatorSet.DilationRectangle1(ho_Region1, out ho_RegionDilation, 1, 10);
        ho_RegionErosion.Dispose();
        HOperatorSet.ErosionRectangle1(ho_RegionDilation, out ho_RegionErosion, 1, 
            2);
        //connection (RegionErosion, ConnectedRegions1)
        //select_shape (ConnectedRegions1, SelectedRegions1, ['area','height'], 'and', [(Row4-Row3)*2,Row4-Row3], [99999,Row4-Row3+20])
        //count_obj (SelectedRegions1, Number)
        //if (Number>=2)
        //else
          //bMisalignmentFinalResultRet := 1
          //return ()
        //endif
        ho_ConnectedRegions.Dispose();
        HOperatorSet.Connection(ho_RegionErosion, out ho_ConnectedRegions);
        ho_SelectedRegions1_1.Dispose();
        HOperatorSet.SelectShape(ho_ConnectedRegions, out ho_SelectedRegions1_1, 
            (new HTuple("area")).TupleConcat("height"), "and", (((hv_Row4-hv_Row3)/2)).TupleConcat(
            (hv_Row4-hv_Row3)/3), (new HTuple(99999)).TupleConcat((hv_Row4-hv_Row3)+10));
        ho_RegionUnion.Dispose();
        HOperatorSet.Union1(ho_SelectedRegions1_1, out ho_RegionUnion);
        HOperatorSet.SmallestRectangle1(ho_RegionUnion, out hv_Row11, out hv_Column1, 
            out hv_Row21, out hv_Column2);
        ho_Rectangle.Dispose();
        HOperatorSet.GenRectangle1(out ho_Rectangle, hv_Row3, hv_Column1+3, hv_Row4, 
            hv_Column2-2);
        ho_ImageReduced2.Dispose();
        HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle, out ho_ImageReduced2
            );
        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.Emphasize(ho_ImageReduced2, out ExpTmpOutVar_0, 10, 10, 3);
        ho_ImageReduced2.Dispose();
        ho_ImageReduced2 = ExpTmpOutVar_0;
        }
        ho_Region2.Dispose();
        HOperatorSet.Threshold(ho_ImageReduced2, out ho_Region2, 0, hv_InterFace_Threshold.TupleSelect(
            1));
        ho_ConnectedRegions2.Dispose();
        HOperatorSet.Connection(ho_Region2, out ho_ConnectedRegions2);
        ho_SelectedRegions2.Dispose();
        HOperatorSet.SelectShape(ho_ConnectedRegions2, out ho_SelectedRegions2, (new HTuple("area")).TupleConcat(
            "height"), "and", (((hv_Row4-hv_Row3)*2)).TupleConcat((hv_Row4-hv_Row3)-10), 
            (new HTuple(99999)).TupleConcat((hv_Row4-hv_Row3)+10));
        HOperatorSet.CountObj(ho_SelectedRegions2, out hv_Number);
        if ((int)(new HTuple(hv_Number.TupleGreaterEqual(1))) != 0)
        {
        }
        else
        {
          hv_bMisalignmentFinalResultRet = 1;
          ho_Image_COPY_INP_TMP.Dispose();
          ho_Rectangle.Dispose();
          ho_ImageReduced.Dispose();
          ho_Region1.Dispose();
          ho_Rectangle3.Dispose();
          ho_ImageReduced1.Dispose();
          ho_RegionDilation.Dispose();
          ho_RegionErosion.Dispose();
          ho_ConnectedRegions.Dispose();
          ho_SelectedRegions1_1.Dispose();
          ho_RegionUnion.Dispose();
          ho_ImageReduced2.Dispose();
          ho_Region2.Dispose();
          ho_ConnectedRegions2.Dispose();
          ho_SelectedRegions2.Dispose();

          return;
        }


        //******************检测电池的上侧是否越界***********************
        //**********如果电池宽度比较小，可合并为一个
        //Row5 := (Main_InterFace[0]-Empty_Main_InterFace[11])+Empty_Main_InterFace[4]-InterFace[13]/InterFace[14]+Main_InterFace[4]
        //gen_rectangle1 (Rectangle3, Row5+InterFace_Offset[5], InterFace_Top[0], Row5+20, InterFace_Top[0]+InterFace_Top[2])
        //reduce_domain (Image, Rectangle3, ImageReduced)
        //emphasize (ImageReduced, ImageReduced, 10, 10, 3)
        //threshold (ImageReduced, Region1, InterFace_Threshold[1]-20, InterFace_Threshold[2])
        //dilation_rectangle1 (Region1, RegionDilation, 10, 1)
        //erosion_rectangle1 (RegionDilation, RegionErosion, 2, 1)
        //connection (RegionErosion, ConnectedRegions1)
        //select_shape (ConnectedRegions1, SelectedRegions1, ['area','width'], 'and', [(InterFace_Top[2]-10)*2,InterFace_Top[2]], [99999,InterFace_Top[2]+20])
        //count_obj (SelectedRegions1, Number)
        //if (Number>=2)
        //else
          //bMisalignmentFinalResultRet := 1
          //return ()
        //endif



        //gen_rectangle1 (Rectangle3, Row5+InterFace_Offset[5], InterFace_Top[1]-InterFace_Top[2], Row5+20, InterFace_Top[1])
        //reduce_domain (Image, Rectangle3, ImageReduced)
        //emphasize (ImageReduced, ImageReduced, 10, 10, 3)
        //threshold (ImageReduced, Region1, InterFace_Threshold[1]-20, InterFace_Threshold[2])
        //dilation_rectangle1 (Region1, RegionDilation, 10, 1)
        //erosion_rectangle1 (RegionDilation, RegionErosion, 2, 1)
        //connection (RegionErosion, ConnectedRegions1)
        //select_shape (ConnectedRegions1, SelectedRegions1, ['area','width'], 'and', [(InterFace_Top[2]-10)*2,InterFace_Top[2]], [99999,InterFace_Top[2]+20])
        //count_obj (SelectedRegions1, Number)
        //if (Number>=2)
        //else
          //bMisalignmentFinalResultRet := 1
          //return ()
        //endif



      }
      // catch (Exception) 
      catch (HalconException HDevExpDefaultException1)
      {
        HDevExpDefaultException1.ToHTuple(out hv_Exception);
        hv_bMisalignmentFinalResultRet = 1;
      }
      ho_Image_COPY_INP_TMP.Dispose();
      ho_Rectangle.Dispose();
      ho_ImageReduced.Dispose();
      ho_Region1.Dispose();
      ho_Rectangle3.Dispose();
      ho_ImageReduced1.Dispose();
      ho_RegionDilation.Dispose();
      ho_RegionErosion.Dispose();
      ho_ConnectedRegions.Dispose();
      ho_SelectedRegions1_1.Dispose();
      ho_RegionUnion.Dispose();
      ho_ImageReduced2.Dispose();
      ho_Region2.Dispose();
      ho_ConnectedRegions2.Dispose();
      ho_SelectedRegions2.Dispose();

      return;
    }
    catch (HalconException HDevExpDefaultException)
    {
      ho_Image_COPY_INP_TMP.Dispose();
      ho_Rectangle.Dispose();
      ho_ImageReduced.Dispose();
      ho_Region1.Dispose();
      ho_Rectangle3.Dispose();
      ho_ImageReduced1.Dispose();
      ho_RegionDilation.Dispose();
      ho_RegionErosion.Dispose();
      ho_ConnectedRegions.Dispose();
      ho_SelectedRegions1_1.Dispose();
      ho_RegionUnion.Dispose();
      ho_ImageReduced2.Dispose();
      ho_Region2.Dispose();
      ho_ConnectedRegions2.Dispose();
      ho_SelectedRegions2.Dispose();

      throw HDevExpDefaultException;
    }
  }

  public void Cartridge_Edge_Insp_UD_COPY_1 (HObject ho_Image, HTuple hv_WindowHandle, 
      HTuple hv_t, HTuple hv_Row, HTuple hv_Column, HTuple hv_Transition, HTuple hv_Select, 
      HTuple hv_RoiWidthLen2, out HTuple hv_Row_Result, out HTuple hv_Column_Result)
  {




    // Local iconic variables 

    // Local control variables 

    HTuple hv_tuple = null, hv_i = null, hv_LineRowStart = new HTuple();
    HTuple hv_LineColumnStart = new HTuple(), hv_LineRowEnd = new HTuple();
    HTuple hv_LineColumnEnd = new HTuple(), hv_AmpThreshold = new HTuple();
    HTuple hv_Sigma = new HTuple(), hv_Distance_Measure_01_0 = new HTuple();
    // Initialize local and output iconic variables 
    hv_Row_Result = new HTuple();
    hv_Column_Result = new HTuple();
    hv_tuple = new HTuple();
    for (hv_i=150; (int)hv_i>=50; hv_i = (int)hv_i + -5)
    {


      //**************************注意这个地方的修改***************************************
      hv_LineRowStart = hv_Row-hv_t;
      hv_LineColumnStart = hv_Column.Clone();
      hv_LineRowEnd = hv_Row+hv_t;
      hv_LineColumnEnd = hv_Column.Clone();
      //**********************************************************************************

      if (HDevWindowStack.IsOpen())
      {
        HOperatorSet.DispObj(ho_Image, HDevWindowStack.GetActive());
      }
      HOperatorSet.DispLine(hv_WindowHandle, hv_LineRowStart, hv_LineColumnStart, 
          hv_LineRowEnd, hv_LineColumnEnd);


      //参数
      //measure pos threshold
      hv_AmpThreshold = hv_i.Clone();
      //measure pos ROiLen2
      //RoiWidthLen2 := 25
      //measure pos sigma
      hv_Sigma = 1;
      //**********Transition有三种模式： 'all', 'negative', 'positive'  ***************
      //Transition := 'all'
      //**********Select有三种模式： 'all', 'first', 'last'  ****************
      //Select := 'all'
      LineFindPoints(ho_Image, hv_LineRowStart, hv_LineRowEnd, hv_LineColumnStart, 
          hv_LineColumnEnd, hv_RoiWidthLen2, hv_Sigma, hv_AmpThreshold, hv_Select, 
          hv_Transition, hv_WindowHandle, out hv_Row_Result, out hv_Column_Result, 
          out hv_Distance_Measure_01_0);

      if ((int)(new HTuple((new HTuple(hv_Row_Result.TupleLength())).TupleGreater(
          0))) != 0)
      {

        hv_tuple = hv_tuple.TupleConcat(hv_Row_Result);
        if ((int)(new HTuple(hv_Select.TupleEqual("first"))) != 0)
        {
          HOperatorSet.TupleMin(hv_tuple, out hv_Row_Result);
        }
        else
        {
          HOperatorSet.TupleMax(hv_tuple, out hv_Row_Result);
        }


      }



    }


    return;


  }

  public void Battery_and_Tray_Insp_Preparation (HObject ho_Image, HTuple hv_WindowHandle, 
      HTuple hv_Empty_Main_InterFace, HTuple hv_InterFace_Tray, HTuple hv_InterFace, 
      HTuple hv_Tuple, HTuple hv_InterFace_Offset, HTuple hv_InterFace_Edge_Param, 
      HTuple hv_InterFace_Top, out HTuple hv_Main_InterFace, out HTuple hv_InterFace_Top_New)
  {




    // Stack for temporary objects 
    HObject[] OTemp = new HObject[20];

    // Local iconic variables 

    // Local copy input parameter variables 
    HObject ho_Image_COPY_INP_TMP;
    ho_Image_COPY_INP_TMP = ho_Image.CopyObj(1,-1);



    // Local control variables 

    HTuple hv_t = new HTuple(), hv_M = new HTuple();
    HTuple hv_N = new HTuple(), hv_Col_N = new HTuple(), hv_Row_N = new HTuple();
    HTuple hv_Row = new HTuple(), hv_Column = new HTuple();
    HTuple hv_Row_Result = new HTuple(), hv_Column_Result = new HTuple();
    HTuple hv_Dis_Row_D = new HTuple(), hv_Dis_Col_R = new HTuple();
    HTuple hv_Dis_Col_L = new HTuple(), hv_Dis_Row_Protrusion_R = new HTuple();
    HTuple hv_Exception = null;
    HTuple   hv_InterFace_COPY_INP_TMP = hv_InterFace.Clone();

    // Initialize local and output iconic variables 
    hv_Main_InterFace = new HTuple();
    hv_InterFace_Top_New = new HTuple();
    try
    {
      try
      {

        if (hv_InterFace_COPY_INP_TMP == null)
          hv_InterFace_COPY_INP_TMP = new HTuple();
        hv_InterFace_COPY_INP_TMP[10] = hv_InterFace_Edge_Param.TupleSelect(0);
        if (hv_InterFace_COPY_INP_TMP == null)
          hv_InterFace_COPY_INP_TMP = new HTuple();
        hv_InterFace_COPY_INP_TMP[11] = hv_InterFace_Edge_Param.TupleSelect(1);

        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.RotateImage(ho_Image_COPY_INP_TMP, out ExpTmpOutVar_0, (hv_InterFace_Edge_Param.TupleSelect(
            2))*57.3, "constant");
        ho_Image_COPY_INP_TMP.Dispose();
        ho_Image_COPY_INP_TMP = ExpTmpOutVar_0;
        }


        hv_t = 50;


        hv_M = hv_Tuple.TupleSelect(0);
        hv_N = hv_Tuple.TupleSelect(1);
        hv_Col_N = (((hv_InterFace_COPY_INP_TMP.TupleSelect(9))/2)-hv_M)*((hv_Empty_Main_InterFace.TupleSelect(
            0))-(hv_Empty_Main_InterFace.TupleSelect(2)));
        hv_Row_N = (hv_N-1)*((hv_Empty_Main_InterFace.TupleSelect(9))-(hv_Empty_Main_InterFace.TupleSelect(
            5)));

        //*****************获取水平方向边界参数********************
        //***注意这个地方的补偿InterFace_Offset

        if ((int)(new HTuple(((hv_Tuple.TupleSelect(2))).TupleEqual(0))) != 0)
        {
          hv_Row = (((hv_InterFace_COPY_INP_TMP.TupleSelect(10))-(hv_Empty_Main_InterFace.TupleSelect(
              7)))+(hv_Empty_Main_InterFace.TupleSelect(3)))+hv_Row_N;
          hv_Column = ((((hv_Empty_Main_InterFace.TupleSelect(0))+(hv_Empty_Main_InterFace.TupleSelect(
              1)))/2)-hv_Col_N)+(hv_InterFace_Offset.TupleSelect(0));
          Cartridge_Edge_Insp_UD(ho_Image_COPY_INP_TMP, hv_WindowHandle, 20, hv_Row, 
              hv_Column, "positive", "first", 15, out hv_Row_Result, out hv_Column_Result);
          hv_Dis_Row_D = hv_Row_Result.Clone();

          hv_Row = (((hv_InterFace_COPY_INP_TMP.TupleSelect(10))-(hv_Empty_Main_InterFace.TupleSelect(
              7)))+(((hv_Empty_Main_InterFace.TupleSelect(4))+(hv_Empty_Main_InterFace.TupleSelect(
              3)))/2))+hv_Row_N;
          hv_Column = (((hv_Empty_Main_InterFace.TupleSelect(0))+(hv_InterFace_COPY_INP_TMP.TupleSelect(
              11)))-(hv_Empty_Main_InterFace.TupleSelect(8)))-hv_Col_N;
          Cartridge_Edge_Insp_LR(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, hv_Row, 
              hv_Column, "positive", "last", out hv_Row_Result, out hv_Column_Result);
          hv_Dis_Col_R = hv_Column_Result.Clone();

          hv_Column = ((hv_Empty_Main_InterFace.TupleSelect(1))+((hv_InterFace_COPY_INP_TMP.TupleSelect(
              11))-(hv_Empty_Main_InterFace.TupleSelect(8))))-hv_Col_N;
          Cartridge_Edge_Insp_LR(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, hv_Row, 
              hv_Column, "negative", "first", out hv_Row_Result, out hv_Column_Result);
          hv_Dis_Col_L = hv_Column_Result.Clone();

          hv_Row = ((hv_Empty_Main_InterFace.TupleSelect(4))+((hv_InterFace_COPY_INP_TMP.TupleSelect(
              10))-(hv_Empty_Main_InterFace.TupleSelect(7))))+hv_Row_N;
          if ((int)(new HTuple((((hv_InterFace_COPY_INP_TMP.TupleSelect(9))/2)).TupleEqual(
              hv_M))) != 0)
          {
            hv_Column = hv_Dis_Col_L-(hv_InterFace_Offset.TupleSelect(2));
            Cartridge_Edge_Insp_UD(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, 
                hv_Row, hv_Column, "negative", "last", 10, out hv_Row_Result, out hv_Column_Result);
          }
          else
          {
            hv_Column = hv_Dis_Col_R+(hv_InterFace_Offset.TupleSelect(2));
            Cartridge_Edge_Insp_UD(ho_Image_COPY_INP_TMP, hv_WindowHandle, hv_t, 
                hv_Row, hv_Column, "negative", "last", 10, out hv_Row_Result, out hv_Column_Result);
          }
          hv_Dis_Row_Protrusion_R = hv_Row_Result.Clone();



        }
        else
        {
          hv_Row = ((hv_Empty_Main_InterFace.TupleSelect(4))+((hv_InterFace_COPY_INP_TMP.TupleSelect(
              10))-(hv_Empty_Main_InterFace.TupleSelect(7))))+hv_Row_N;
          if ((int)((new HTuple((((hv_InterFace_COPY_INP_TMP.TupleSelect(9))/2)).TupleEqual(
              hv_M))).TupleAnd(new HTuple(hv_N.TupleEqual(1)))) != 0)
          {
            hv_Column = (((hv_Empty_Main_InterFace.TupleSelect(1))+((hv_InterFace_COPY_INP_TMP.TupleSelect(
                11))-(hv_Empty_Main_InterFace.TupleSelect(8))))-(hv_InterFace_Offset.TupleSelect(
                2)))-hv_Col_N;
            Cartridge_Edge_Insp_Protrusion(ho_Image_COPY_INP_TMP, hv_WindowHandle, 
                20, hv_Row, hv_Column, "negative", "last", 10, out hv_Row_Result, 
                out hv_Column_Result);
            hv_Dis_Row_Protrusion_R = hv_Row_Result.Clone();
          }
          else if ((int)(new HTuple(hv_N.TupleEqual(1))) != 0)
          {
            hv_Column = (((hv_Empty_Main_InterFace.TupleSelect(0))+((hv_InterFace_COPY_INP_TMP.TupleSelect(
                11))-(hv_Empty_Main_InterFace.TupleSelect(8))))+(hv_InterFace_Offset.TupleSelect(
                2)))-hv_Col_N;
            Cartridge_Edge_Insp_Protrusion(ho_Image_COPY_INP_TMP, hv_WindowHandle, 
                20, hv_Row, hv_Column, "negative", "last", 10, out hv_Row_Result, 
                out hv_Column_Result);
            hv_Dis_Row_Protrusion_R = hv_Row_Result.Clone();
          }
          else
          {
          }



        }



        //****料盒顶部边界Col***
        if (hv_InterFace_Top_New == null)
          hv_InterFace_Top_New = new HTuple();
        hv_InterFace_Top_New[0] = (hv_InterFace_Top.TupleSelect(0))+((hv_M-1)*((hv_Empty_Main_InterFace.TupleSelect(
            0))-(hv_Empty_Main_InterFace.TupleSelect(2))));
        if (hv_InterFace_Top_New == null)
          hv_InterFace_Top_New = new HTuple();
        hv_InterFace_Top_New[1] = (hv_InterFace_Top.TupleSelect(1))+((hv_M-1)*((hv_Empty_Main_InterFace.TupleSelect(
            0))-(hv_Empty_Main_InterFace.TupleSelect(2))));
        if (hv_InterFace_Top_New == null)
          hv_InterFace_Top_New = new HTuple();
        hv_InterFace_Top_New[2] = hv_InterFace_Top.TupleSelect(2);


        if ((int)(new HTuple(((hv_Tuple.TupleSelect(2))).TupleEqual(0))) != 0)
        {
          hv_Main_InterFace = new HTuple();
          hv_Main_InterFace = hv_Main_InterFace.TupleConcat(hv_Dis_Col_R);
          hv_Main_InterFace = hv_Main_InterFace.TupleConcat(hv_Dis_Col_L);
          hv_Main_InterFace = hv_Main_InterFace.TupleConcat(hv_Dis_Row_Protrusion_R);
          hv_Main_InterFace = hv_Main_InterFace.TupleConcat(hv_Dis_Row_D);
          hv_Main_InterFace = hv_Main_InterFace.TupleConcat(hv_InterFace_Edge_Param);
        }
        else if ((int)(new HTuple(hv_N.TupleEqual(1))) != 0)
        {

          hv_Main_InterFace = new HTuple();
          hv_Main_InterFace = hv_Main_InterFace.TupleConcat(hv_InterFace_Edge_Param);
          hv_Main_InterFace = hv_Main_InterFace.TupleConcat(hv_Col_N);
          hv_Main_InterFace = hv_Main_InterFace.TupleConcat(hv_Row_N);
          hv_Main_InterFace = hv_Main_InterFace.TupleConcat(hv_Dis_Row_Protrusion_R);
        }
        else
        {
          hv_Main_InterFace = new HTuple();
          hv_Main_InterFace = hv_Main_InterFace.TupleConcat(hv_InterFace_Edge_Param);
          hv_Main_InterFace = hv_Main_InterFace.TupleConcat(hv_Col_N);
          hv_Main_InterFace = hv_Main_InterFace.TupleConcat(hv_Row_N);
        }



      }
      // catch (Exception) 
      catch (HalconException HDevExpDefaultException1)
      {
        HDevExpDefaultException1.ToHTuple(out hv_Exception);

        //************************如果上面的任意某个参数找不到，应该是电池越界**************************

      }
      ho_Image_COPY_INP_TMP.Dispose();

      return;
    }
    catch (HalconException HDevExpDefaultException)
    {
      ho_Image_COPY_INP_TMP.Dispose();

      throw HDevExpDefaultException;
    }
  }

  public void Battery_Edge_Insp (HObject ho_Image, HTuple hv_InterFace_Tray, HTuple hv_InterFace_Threshold, 
      HTuple hv_i, HTuple hv_Tuple, out HTuple hv_bFinalEdge, out HTuple hv_InterFace_Edge_Param)
  {




    // Stack for temporary objects 
    HObject[] OTemp = new HObject[20];

    // Local iconic variables 

    HObject ho_Rectangle=null, ho_ImageReduced=null;
    HObject ho_Region=null, ho_ConnectedRegions=null, ho_SelectedRegions=null;
    HObject ho_RegionUnion=null, ho_RegionLinesFitTopCol=null;
    HObject ho_Rectangle_V=null, ho_RegionUnion1=null, ho_RegionTrans=null;
    HObject ho_Rectangle_H=null;

    // Local copy input parameter variables 
    HObject ho_Image_COPY_INP_TMP;
    ho_Image_COPY_INP_TMP = ho_Image.CopyObj(1,-1);



    // Local control variables 

    HTuple hv_Number = new HTuple(), hv_Row11 = new HTuple();
    HTuple hv_Column11 = new HTuple(), hv_Row21 = new HTuple();
    HTuple hv_Column21 = new HTuple(), hv_Phi = new HTuple();
    HTuple hv_Row1 = new HTuple(), hv_Column1 = new HTuple();
    HTuple hv_Row2 = new HTuple(), hv_Column2 = new HTuple();
    HTuple hv_PI = new HTuple(), hv_Phi1 = new HTuple(), hv_Number1 = new HTuple();
    HTuple hv_Row12 = new HTuple(), hv_Column12 = new HTuple();
    HTuple hv_Row22 = new HTuple(), hv_Column22 = new HTuple();
    HTuple hv_Area1 = new HTuple(), hv_Row4 = new HTuple();
    HTuple hv_Column4 = new HTuple(), hv_Area_All_R = new HTuple();
    HTuple hv_Area_Ratio_R = new HTuple(), hv_Row13 = new HTuple();
    HTuple hv_Column13 = new HTuple(), hv_Row23 = new HTuple();
    HTuple hv_Column23 = new HTuple(), hv_InterFace = new HTuple();
    HTuple hv_Number2 = new HTuple(), hv_Area = new HTuple();
    HTuple hv_Row3 = new HTuple(), hv_Column3 = new HTuple();
    HTuple hv_Area_All_U = new HTuple(), hv_Area_Ratio_U = new HTuple();
    HTuple hv_Exception = null;
    // Initialize local and output iconic variables 
    HOperatorSet.GenEmptyObj(out ho_Rectangle);
    HOperatorSet.GenEmptyObj(out ho_ImageReduced);
    HOperatorSet.GenEmptyObj(out ho_Region);
    HOperatorSet.GenEmptyObj(out ho_ConnectedRegions);
    HOperatorSet.GenEmptyObj(out ho_SelectedRegions);
    HOperatorSet.GenEmptyObj(out ho_RegionUnion);
    HOperatorSet.GenEmptyObj(out ho_RegionLinesFitTopCol);
    HOperatorSet.GenEmptyObj(out ho_Rectangle_V);
    HOperatorSet.GenEmptyObj(out ho_RegionUnion1);
    HOperatorSet.GenEmptyObj(out ho_RegionTrans);
    HOperatorSet.GenEmptyObj(out ho_Rectangle_H);
    hv_bFinalEdge = new HTuple();
    hv_InterFace_Edge_Param = new HTuple();
    try
    {
      try
      {
        if ((int)(new HTuple(hv_i.TupleNotEqual(0))) != 0)
        {
          ho_Image_COPY_INP_TMP.Dispose();
          ho_Rectangle.Dispose();
          ho_ImageReduced.Dispose();
          ho_Region.Dispose();
          ho_ConnectedRegions.Dispose();
          ho_SelectedRegions.Dispose();
          ho_RegionUnion.Dispose();
          ho_RegionLinesFitTopCol.Dispose();
          ho_Rectangle_V.Dispose();
          ho_RegionUnion1.Dispose();
          ho_RegionTrans.Dispose();
          ho_Rectangle_H.Dispose();

          return;
        }
        //*****************初始化输出参数*******************
        //***********bFinalEdge：表示电池边界未找到,料盒被弹出***********
        hv_bFinalEdge = 0;

        ho_Rectangle.Dispose();
        HOperatorSet.GenRectangle1(out ho_Rectangle, hv_InterFace_Tray.TupleSelect(
            0), hv_InterFace_Tray.TupleSelect(1), hv_InterFace_Tray.TupleSelect(2), 
            hv_InterFace_Tray.TupleSelect(3));
        ho_ImageReduced.Dispose();
        HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle, out ho_ImageReduced
            );
        //if (Tuple[2]=0 or (Tuple[1]=2  and Tuple[2]=1))
          //threshold (ImageReduced, Region, InterFace_Threshold[0]+70, 255)
        //else
          ho_Region.Dispose();
          HOperatorSet.Threshold(ho_ImageReduced, out ho_Region, hv_InterFace_Threshold.TupleSelect(
              0), 255);
        //endif

        ho_ConnectedRegions.Dispose();
        HOperatorSet.Connection(ho_Region, out ho_ConnectedRegions);

        ho_SelectedRegions.Dispose();
        HOperatorSet.SelectShape(ho_ConnectedRegions, out ho_SelectedRegions, (new HTuple("area")).TupleConcat(
            "width"), "and", ((((hv_InterFace_Tray.TupleSelect(3))-(hv_InterFace_Tray.TupleSelect(
            1)))*4)).TupleConcat(((hv_InterFace_Tray.TupleSelect(3))-(hv_InterFace_Tray.TupleSelect(
            1)))-20), (new HTuple(999999)).TupleConcat(((hv_InterFace_Tray.TupleSelect(
            3))-(hv_InterFace_Tray.TupleSelect(1)))+20));
        ho_RegionUnion.Dispose();
        HOperatorSet.Union1(ho_SelectedRegions, out ho_RegionUnion);
        HOperatorSet.CountObj(ho_SelectedRegions, out hv_Number);
        if ((int)(new HTuple(hv_Number.TupleEqual(0))) != 0)
        {
          hv_bFinalEdge = 1;
          ho_Image_COPY_INP_TMP.Dispose();
          ho_Rectangle.Dispose();
          ho_ImageReduced.Dispose();
          ho_Region.Dispose();
          ho_ConnectedRegions.Dispose();
          ho_SelectedRegions.Dispose();
          ho_RegionUnion.Dispose();
          ho_RegionLinesFitTopCol.Dispose();
          ho_Rectangle_V.Dispose();
          ho_RegionUnion1.Dispose();
          ho_RegionTrans.Dispose();
          ho_Rectangle_H.Dispose();

          return;
        }
        HOperatorSet.SmallestRectangle1(ho_RegionUnion, out hv_Row11, out hv_Column11, 
            out hv_Row21, out hv_Column21);
        ho_RegionLinesFitTopCol.Dispose();
        fitTopSideLine(ho_Image_COPY_INP_TMP, ho_SelectedRegions, out ho_RegionLinesFitTopCol, 
            out hv_Phi);
        //gen_rectangle1 (Rectangle, InterFace_Tray[4], InterFace_Tray[5], InterFace_Tray[6], InterFace_Tray[7])
        //reduce_domain (Image, Rectangle, ImageReduced)
        //threshold (ImageReduced, Region, 60, 255)
        //connection (Region, ConnectedRegions)

        //select_shape (ConnectedRegions, SelectedRegions, ['area','height'], 'and', [(InterFace_Tray[6]-InterFace_Tray[4])*5,InterFace_Tray[6]-InterFace_Tray[4]-20], [999999,InterFace_Tray[6]-InterFace_Tray[4]+20])
        //union1 (SelectedRegions, RegionUnion)
        //smallest_rectangle1 (RegionUnion, Row1, Column1, Row2, Column2)
        //fitRightSideLine (Image, SelectedRegions, RegionLinesFitRightCol, Phi)

        //*由于料盒的旋转角度很小，默认长宽分别用Row2-Row1和Column2-Column1
        hv_PI = 1.5708*2;
        if ((int)(new HTuple(hv_Phi.TupleGreater(1))) != 0)
        {
          hv_Phi1 = hv_Phi-(hv_PI/2);
        }
        else if ((int)(new HTuple(hv_Phi.TupleLess(-1))) != 0)
        {
          hv_Phi1 = hv_Phi+(hv_PI/2);
        }
        else
        {
          hv_Phi1 = hv_Phi.Clone();
        }

        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.RotateImage(ho_Image_COPY_INP_TMP, out ExpTmpOutVar_0, hv_Phi1*57.3, 
            "constant");
        ho_Image_COPY_INP_TMP.Dispose();
        ho_Image_COPY_INP_TMP = ExpTmpOutVar_0;
        }

        //*****************获取料盘边界参数********************
        ho_Rectangle_V.Dispose();
        HOperatorSet.GenRectangle1(out ho_Rectangle_V, hv_InterFace_Tray.TupleSelect(
            4), hv_InterFace_Tray.TupleSelect(5), hv_InterFace_Tray.TupleSelect(6), 
            hv_InterFace_Tray.TupleSelect(7));
        ho_ImageReduced.Dispose();
        HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle_V, out ho_ImageReduced
            );
        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.ScaleImageMax(ho_ImageReduced, out ExpTmpOutVar_0);
        ho_ImageReduced.Dispose();
        ho_ImageReduced = ExpTmpOutVar_0;
        }
        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.Emphasize(ho_ImageReduced, out ExpTmpOutVar_0, 10, 10, 2);
        ho_ImageReduced.Dispose();
        ho_ImageReduced = ExpTmpOutVar_0;
        }
        //derivate_gauss (ImageReduced, DerivGauss, 1, 'x')
        //invert_image (DerivGauss, ImageInvert)
        ho_Region.Dispose();
        HOperatorSet.Threshold(ho_ImageReduced, out ho_Region, (hv_InterFace_Threshold.TupleSelect(
            0))+30, 255);
        ho_ConnectedRegions.Dispose();
        HOperatorSet.Connection(ho_Region, out ho_ConnectedRegions);
        ho_SelectedRegions.Dispose();
        HOperatorSet.SelectShape(ho_ConnectedRegions, out ho_SelectedRegions, (new HTuple("area")).TupleConcat(
            "height"), "and", ((((hv_InterFace_Tray.TupleSelect(6))-(hv_InterFace_Tray.TupleSelect(
            4)))*5)).TupleConcat(((hv_InterFace_Tray.TupleSelect(6))-(hv_InterFace_Tray.TupleSelect(
            4)))-20), (new HTuple(999999)).TupleConcat(((hv_InterFace_Tray.TupleSelect(
            6))-(hv_InterFace_Tray.TupleSelect(4)))+20));
        HOperatorSet.CountObj(ho_SelectedRegions, out hv_Number1);
        ho_RegionUnion1.Dispose();
        HOperatorSet.Union1(ho_SelectedRegions, out ho_RegionUnion1);
        HOperatorSet.SmallestRectangle1(ho_RegionUnion1, out hv_Row12, out hv_Column12, 
            out hv_Row22, out hv_Column22);
        HOperatorSet.AreaCenter(ho_SelectedRegions, out hv_Area1, out hv_Row4, out hv_Column4);
        hv_Area_All_R = ((hv_InterFace_Tray.TupleSelect(7))-(hv_InterFace_Tray.TupleSelect(
            5)))*((hv_InterFace_Tray.TupleSelect(6))-(hv_InterFace_Tray.TupleSelect(
            4)));

        if ((int)(new HTuple(hv_Number1.TupleEqual(0))) != 0)
        {
          hv_bFinalEdge = 1;
          ho_Image_COPY_INP_TMP.Dispose();
          ho_Rectangle.Dispose();
          ho_ImageReduced.Dispose();
          ho_Region.Dispose();
          ho_ConnectedRegions.Dispose();
          ho_SelectedRegions.Dispose();
          ho_RegionUnion.Dispose();
          ho_RegionLinesFitTopCol.Dispose();
          ho_Rectangle_V.Dispose();
          ho_RegionUnion1.Dispose();
          ho_RegionTrans.Dispose();
          ho_Rectangle_H.Dispose();

          return;
        }
        else
        {

          hv_Area_Ratio_R = (hv_Area1*1.0)/hv_Area_All_R;
          if ((int)((new HTuple(hv_Area_Ratio_R.TupleGreater(0.9))).TupleOr(new HTuple(hv_Column22.TupleEqual(
              hv_InterFace_Tray.TupleSelect(7))))) != 0)
          {
            hv_bFinalEdge = 1;
            ho_Image_COPY_INP_TMP.Dispose();
            ho_Rectangle.Dispose();
            ho_ImageReduced.Dispose();
            ho_Region.Dispose();
            ho_ConnectedRegions.Dispose();
            ho_SelectedRegions.Dispose();
            ho_RegionUnion.Dispose();
            ho_RegionLinesFitTopCol.Dispose();
            ho_Rectangle_V.Dispose();
            ho_RegionUnion1.Dispose();
            ho_RegionTrans.Dispose();
            ho_Rectangle_H.Dispose();

            return;
          }
          else
          {
          }

        }
        ho_RegionUnion.Dispose();
        HOperatorSet.Union1(ho_SelectedRegions, out ho_RegionUnion);
        HOperatorSet.SmallestRectangle1(ho_RegionUnion, out hv_Row1, out hv_Column1, 
            out hv_Row2, out hv_Column2);
        ho_RegionTrans.Dispose();
        HOperatorSet.ShapeTrans(ho_RegionUnion, out ho_RegionTrans, "inner_rectangle1");
        HOperatorSet.SmallestRectangle1(ho_RegionTrans, out hv_Row13, out hv_Column13, 
            out hv_Row23, out hv_Column23);
        if ((int)(new HTuple(((((hv_Column2-hv_Column23)).TupleAbs())).TupleLess(
            10))) != 0)
        {
          hv_Column2 = (hv_Column2+hv_Column23)/2;
        }
        else
        {

          if ((int)(new HTuple(((hv_Column2-(hv_InterFace.TupleSelect(11)))).TupleLess(
              10))) != 0)
          {
            hv_Column2 = hv_Column2+3;
          }
          else
          {
            hv_Column2 = hv_InterFace.TupleSelect(11);
          }
        }
        if (hv_InterFace == null)
          hv_InterFace = new HTuple();
        hv_InterFace[11] = hv_Column2;



        ho_Rectangle_H.Dispose();
        HOperatorSet.GenRectangle1(out ho_Rectangle_H, hv_InterFace_Tray.TupleSelect(
            0), hv_InterFace_Tray.TupleSelect(1), hv_InterFace_Tray.TupleSelect(2), 
            hv_InterFace_Tray.TupleSelect(3));
        ho_ImageReduced.Dispose();
        HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle_H, out ho_ImageReduced
            );
        //if (Tuple[2]=0 or (Tuple[1]=2  and Tuple[2]=1))
          //threshold (ImageReduced, Region, InterFace_Threshold[0]+70, 255)
        //else
          ho_Region.Dispose();
          HOperatorSet.Threshold(ho_ImageReduced, out ho_Region, hv_InterFace_Threshold.TupleSelect(
              0), 255);
        //endif
        ho_ConnectedRegions.Dispose();
        HOperatorSet.Connection(ho_Region, out ho_ConnectedRegions);
        ho_SelectedRegions.Dispose();
        HOperatorSet.SelectShape(ho_ConnectedRegions, out ho_SelectedRegions, (new HTuple("area")).TupleConcat(
            "width"), "and", ((((hv_InterFace_Tray.TupleSelect(3))-(hv_InterFace_Tray.TupleSelect(
            1)))*4)).TupleConcat(((hv_InterFace_Tray.TupleSelect(3))-(hv_InterFace_Tray.TupleSelect(
            1)))-20), (new HTuple(999999)).TupleConcat(((hv_InterFace_Tray.TupleSelect(
            3))-(hv_InterFace_Tray.TupleSelect(1)))+20));
        HOperatorSet.CountObj(ho_SelectedRegions, out hv_Number2);
        ho_RegionUnion1.Dispose();
        HOperatorSet.Union1(ho_SelectedRegions, out ho_RegionUnion1);
        HOperatorSet.SmallestRectangle1(ho_RegionUnion1, out hv_Row12, out hv_Column12, 
            out hv_Row22, out hv_Column22);
        HOperatorSet.AreaCenter(ho_SelectedRegions, out hv_Area, out hv_Row3, out hv_Column3);
        hv_Area_All_U = ((hv_InterFace_Tray.TupleSelect(2))-(hv_InterFace_Tray.TupleSelect(
            0)))*((hv_InterFace_Tray.TupleSelect(3))-(hv_InterFace_Tray.TupleSelect(
            1)));
        if ((int)(new HTuple(hv_Number2.TupleEqual(0))) != 0)
        {
          hv_bFinalEdge = 1;
          ho_Image_COPY_INP_TMP.Dispose();
          ho_Rectangle.Dispose();
          ho_ImageReduced.Dispose();
          ho_Region.Dispose();
          ho_ConnectedRegions.Dispose();
          ho_SelectedRegions.Dispose();
          ho_RegionUnion.Dispose();
          ho_RegionLinesFitTopCol.Dispose();
          ho_Rectangle_V.Dispose();
          ho_RegionUnion1.Dispose();
          ho_RegionTrans.Dispose();
          ho_Rectangle_H.Dispose();

          return;
        }
        else
        {
          hv_Area_Ratio_U = (hv_Area*1.0)/hv_Area_All_U;
          if ((int)((new HTuple(hv_Area_Ratio_U.TupleGreater(0.9))).TupleOr(new HTuple(((hv_Row12.TupleSelect(
              0))).TupleEqual(hv_InterFace_Tray.TupleSelect(0))))) != 0)
          {
            hv_bFinalEdge = 1;
            ho_Image_COPY_INP_TMP.Dispose();
            ho_Rectangle.Dispose();
            ho_ImageReduced.Dispose();
            ho_Region.Dispose();
            ho_ConnectedRegions.Dispose();
            ho_SelectedRegions.Dispose();
            ho_RegionUnion.Dispose();
            ho_RegionLinesFitTopCol.Dispose();
            ho_Rectangle_V.Dispose();
            ho_RegionUnion1.Dispose();
            ho_RegionTrans.Dispose();
            ho_Rectangle_H.Dispose();

            return;
          }
          else
          {
          }

        }
        ho_RegionUnion.Dispose();
        HOperatorSet.Union1(ho_SelectedRegions, out ho_RegionUnion);
        HOperatorSet.SmallestRectangle1(ho_RegionUnion, out hv_Row11, out hv_Column11, 
            out hv_Row21, out hv_Column21);

        if (hv_InterFace == null)
          hv_InterFace = new HTuple();
        hv_InterFace[10] = hv_Row11.TupleSelect(0);

        hv_InterFace_Edge_Param = new HTuple();
        hv_InterFace_Edge_Param = hv_InterFace_Edge_Param.TupleConcat(hv_InterFace.TupleSelect(
            10));
        hv_InterFace_Edge_Param = hv_InterFace_Edge_Param.TupleConcat(hv_InterFace.TupleSelect(
            11));
        hv_InterFace_Edge_Param = hv_InterFace_Edge_Param.TupleConcat(hv_Phi1);
      }
      // catch (Exception) 
      catch (HalconException HDevExpDefaultException1)
      {
        HDevExpDefaultException1.ToHTuple(out hv_Exception);
        hv_bFinalEdge = 1;
      }
      ho_Image_COPY_INP_TMP.Dispose();
      ho_Rectangle.Dispose();
      ho_ImageReduced.Dispose();
      ho_Region.Dispose();
      ho_ConnectedRegions.Dispose();
      ho_SelectedRegions.Dispose();
      ho_RegionUnion.Dispose();
      ho_RegionLinesFitTopCol.Dispose();
      ho_Rectangle_V.Dispose();
      ho_RegionUnion1.Dispose();
      ho_RegionTrans.Dispose();
      ho_Rectangle_H.Dispose();

      return;
    }
    catch (HalconException HDevExpDefaultException)
    {
      ho_Image_COPY_INP_TMP.Dispose();
      ho_Rectangle.Dispose();
      ho_ImageReduced.Dispose();
      ho_Region.Dispose();
      ho_ConnectedRegions.Dispose();
      ho_SelectedRegions.Dispose();
      ho_RegionUnion.Dispose();
      ho_RegionLinesFitTopCol.Dispose();
      ho_Rectangle_V.Dispose();
      ho_RegionUnion1.Dispose();
      ho_RegionTrans.Dispose();
      ho_Rectangle_H.Dispose();

      throw HDevExpDefaultException;
    }
  }

  public void fitTopSideLine (HObject ho_ImageRotateS, HObject ho_BatteryNoTabRegions, 
      out HObject ho_RegionLinesFitSide, out HTuple hv_Phi)
  {



    // Stack for temporary objects 
    HObject[] OTemp = new HObject[20];

    // Local iconic variables 

    HObject ho_SelectedRegionsS, ho_BatteryNoTabRegionsOut;
    HObject ho_BatteryNoTabRegionsRect, ho_sliceRectRegions;
    HObject ho_sliceRectRegionsROI, ho_sliceRectRegionsROIRaw;
    HObject ho_sliceobjRectsssssssRemoved, ho_objNoTabRegionRect=null;
    HObject ho_sliceRectobjNoTabRegions=null, ho_sliceobjRectRemoved=null;
    HObject ho_RegionLinesFit, ho_sliceRectRegionsROISide, ho_ContoursliceRectRegionsROI;

    // Local control variables 

    HTuple hv_Row1RectOut = null, hv_Col1RectOut = null;
    HTuple hv_Row2RectOut = null, hv_Col2RectOut = null, hv_Row1BatteryNoTab = null;
    HTuple hv_Col1BatteryNoTab = null, hv_Row2BatteryNoTab = null;
    HTuple hv_Col2BatteryNoTab = null, hv_lengthOfNoTabRegion = null;
    HTuple hv_numberOfNoTabRegion = null, hv_subindex = null;
    HTuple hv_totalLen = null, hv_stepOflen = null, hv_sliceRectRow1 = null;
    HTuple hv_sliceRectRow2 = null, hv_sliceRectCol1 = null;
    HTuple hv_sliceRectCol2 = null, hv_sliceIndexGap = null;
    HTuple hv_countOfleftTop = new HTuple(), hv_sliceIndex = new HTuple();
    HTuple hv_Row1sliceRect = null, hv_Col1sliceRect = null;
    HTuple hv_Row2sliceRect = null, hv_Col2sliceRect = null;
    HTuple hv_Row1SLobjNoTab = new HTuple(), hv_Col1SLobjNoTab = new HTuple();
    HTuple hv_Row2SLobjNoTab = new HTuple(), hv_Col2SLobjNoTab = new HTuple();
    HTuple hv_lenofRow1SLobjNoTab = new HTuple(), hv_Row1SLobjNoTabPLine = new HTuple();
    HTuple hv_Row1SLobjNoTabPLIndex = new HTuple(), hv_Values = null;
    HTuple hv_isideTab = null, hv_len = null, hv_y = null;
    HTuple hv_x = null, hv_xxxx = null, hv_idxxxx = null, hv_xtx = null;
    HTuple hv_xty = null, hv_invxtx = null, hv_beta = null;
    HTuple hv_Valueside = null, hv_towPointsCol = null, hv_Newy = null;
    HTuple hv_RowBegin = null, hv_ColBegin = null, hv_RowEnd = null;
    HTuple hv_ColEnd = null, hv_Nr = null, hv_Nc = null, hv_Dist = null;
    // Initialize local and output iconic variables 
    HOperatorSet.GenEmptyObj(out ho_RegionLinesFitSide);
    HOperatorSet.GenEmptyObj(out ho_SelectedRegionsS);
    HOperatorSet.GenEmptyObj(out ho_BatteryNoTabRegionsOut);
    HOperatorSet.GenEmptyObj(out ho_BatteryNoTabRegionsRect);
    HOperatorSet.GenEmptyObj(out ho_sliceRectRegions);
    HOperatorSet.GenEmptyObj(out ho_sliceRectRegionsROI);
    HOperatorSet.GenEmptyObj(out ho_sliceRectRegionsROIRaw);
    HOperatorSet.GenEmptyObj(out ho_sliceobjRectsssssssRemoved);
    HOperatorSet.GenEmptyObj(out ho_objNoTabRegionRect);
    HOperatorSet.GenEmptyObj(out ho_sliceRectobjNoTabRegions);
    HOperatorSet.GenEmptyObj(out ho_sliceobjRectRemoved);
    HOperatorSet.GenEmptyObj(out ho_RegionLinesFit);
    HOperatorSet.GenEmptyObj(out ho_sliceRectRegionsROISide);
    HOperatorSet.GenEmptyObj(out ho_ContoursliceRectRegionsROI);
    try
    {
      ho_SelectedRegionsS.Dispose();
      HOperatorSet.CopyObj(ho_BatteryNoTabRegions, out ho_SelectedRegionsS, 1, -1);
      //10.拟合底部直线进行拟合直线前的准备
      //剔除左边侧封区域
      //剔除每个区域的边缘
      //剔除区域内的最高点14%（当采样数量大于15时）
      ho_RegionLinesFitSide.Dispose();
      HOperatorSet.GenEmptyObj(out ho_RegionLinesFitSide);
      //shape_trans (BatteryNoTabRegionsOut, BatteryNoTabRegionsOut, 'convex')
      HOperatorSet.SmallestRectangle1(ho_SelectedRegionsS, out hv_Row1RectOut, out hv_Col1RectOut, 
          out hv_Row2RectOut, out hv_Col2RectOut);
      ho_BatteryNoTabRegionsOut.Dispose();
      HOperatorSet.SortRegion(ho_SelectedRegionsS, out ho_BatteryNoTabRegionsOut, 
          "upper_left", "true", "column");
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.Union1(ho_BatteryNoTabRegionsOut, out ExpTmpOutVar_0);
      ho_BatteryNoTabRegionsOut.Dispose();
      ho_BatteryNoTabRegionsOut = ExpTmpOutVar_0;
      }
      HOperatorSet.SmallestRectangle1(ho_BatteryNoTabRegionsOut, out hv_Row1BatteryNoTab, 
          out hv_Col1BatteryNoTab, out hv_Row2BatteryNoTab, out hv_Col2BatteryNoTab);
      ho_BatteryNoTabRegionsRect.Dispose();
      HOperatorSet.GenRectangle1(out ho_BatteryNoTabRegionsRect, hv_Row1BatteryNoTab, 
          hv_Col1BatteryNoTab, hv_Row2BatteryNoTab, hv_Col2BatteryNoTab);
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.Connection(ho_BatteryNoTabRegionsRect, out ExpTmpOutVar_0);
      ho_BatteryNoTabRegionsRect.Dispose();
      ho_BatteryNoTabRegionsRect = ExpTmpOutVar_0;
      }
      hv_lengthOfNoTabRegion = hv_Col2BatteryNoTab-hv_Col1BatteryNoTab;
      hv_numberOfNoTabRegion = new HTuple(hv_Row1BatteryNoTab.TupleLength());
      //剔除最左边的区域侧边封印区域
      if ((int)(new HTuple(((hv_lengthOfNoTabRegion.TupleSelect(0))).TupleGreater(
          160))) != 0)
      {
        if (hv_Col1BatteryNoTab == null)
          hv_Col1BatteryNoTab = new HTuple();
        hv_Col1BatteryNoTab[0] = (hv_Col1BatteryNoTab.TupleSelect(0))+10;
        if (hv_Col2BatteryNoTab == null)
          hv_Col2BatteryNoTab = new HTuple();
        hv_Col2BatteryNoTab[0] = (hv_Col2BatteryNoTab.TupleSelect(0))-10;
      }
      HTuple end_val20 = hv_numberOfNoTabRegion-1;
      HTuple step_val20 = 1;
      for (hv_subindex=1; hv_subindex.Continue(end_val20, step_val20); hv_subindex = hv_subindex.TupleAdd(step_val20))
      {
        if ((int)(new HTuple(((hv_lengthOfNoTabRegion.TupleSelect(hv_subindex))).TupleGreater(
            10))) != 0)
        {
          if (hv_Col1BatteryNoTab == null)
            hv_Col1BatteryNoTab = new HTuple();
          hv_Col1BatteryNoTab[hv_subindex] = (hv_Col1BatteryNoTab.TupleSelect(hv_subindex))+5;
          if (hv_Col2BatteryNoTab == null)
            hv_Col2BatteryNoTab = new HTuple();
          hv_Col2BatteryNoTab[hv_subindex] = (hv_Col2BatteryNoTab.TupleSelect(hv_subindex))-5;
        }
      }
      hv_lengthOfNoTabRegion = hv_Col2BatteryNoTab-hv_Col1BatteryNoTab;
      HOperatorSet.TupleSum(hv_lengthOfNoTabRegion, out hv_totalLen);
      hv_stepOflen = (hv_totalLen-200)/50;
      if ((int)(new HTuple(hv_stepOflen.TupleLess(2))) != 0)
      {
        hv_stepOflen = 2;
      }
      hv_sliceRectRow1 = new HTuple();
      hv_sliceRectRow2 = new HTuple();
      hv_sliceRectCol1 = new HTuple();
      hv_sliceRectCol2 = new HTuple();
      hv_sliceIndexGap = 0;
      HTuple end_val37 = hv_numberOfNoTabRegion-1;
      HTuple step_val37 = 1;
      for (hv_subindex=0; hv_subindex.Continue(end_val37, step_val37); hv_subindex = hv_subindex.TupleAdd(step_val37))
      {
        hv_countOfleftTop = (hv_lengthOfNoTabRegion.TupleSelect(hv_subindex))/hv_stepOflen;

        HTuple end_val40 = hv_sliceIndexGap+hv_countOfleftTop;
        HTuple step_val40 = 1;
        for (hv_sliceIndex=hv_sliceIndexGap; hv_sliceIndex.Continue(end_val40, step_val40); hv_sliceIndex = hv_sliceIndex.TupleAdd(step_val40))
        {
          if (hv_sliceRectRow1 == null)
            hv_sliceRectRow1 = new HTuple();
          hv_sliceRectRow1[hv_sliceIndex] = (hv_Row1BatteryNoTab.TupleSelect(hv_subindex))-30;
          if (hv_sliceRectRow2 == null)
            hv_sliceRectRow2 = new HTuple();
          hv_sliceRectRow2[hv_sliceIndex] = (hv_Row1BatteryNoTab.TupleSelect(hv_subindex))+30;
          if (hv_sliceRectCol1 == null)
            hv_sliceRectCol1 = new HTuple();
          hv_sliceRectCol1[hv_sliceIndex] = (hv_Col1BatteryNoTab.TupleSelect(hv_subindex))+((hv_sliceIndex-hv_sliceIndexGap)*hv_stepOflen);
          if (hv_sliceRectCol2 == null)
            hv_sliceRectCol2 = new HTuple();
          hv_sliceRectCol2[hv_sliceIndex] = (hv_Col1BatteryNoTab.TupleSelect(hv_subindex))+((hv_sliceIndex-hv_sliceIndexGap)*hv_stepOflen);
        }

        hv_sliceIndexGap = hv_sliceIndexGap+hv_countOfleftTop;

      }


      ho_sliceRectRegions.Dispose();
      HOperatorSet.GenRectangle1(out ho_sliceRectRegions, hv_sliceRectRow1, hv_sliceRectCol1, 
          hv_sliceRectRow2, hv_sliceRectCol2);
      ho_sliceRectRegionsROI.Dispose();
      HOperatorSet.Intersection(ho_sliceRectRegions, ho_BatteryNoTabRegionsOut, out ho_sliceRectRegionsROI
          );
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.ClosingRectangle1(ho_sliceRectRegionsROI, out ExpTmpOutVar_0, 
          1, 60);
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.Union1(ho_sliceRectRegionsROI, out ExpTmpOutVar_0);
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.FillUp(ho_sliceRectRegionsROI, out ExpTmpOutVar_0);
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.Connection(ho_sliceRectRegionsROI, out ExpTmpOutVar_0);
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.SortRegion(ho_sliceRectRegionsROI, out ExpTmpOutVar_0, "upper_left", 
          "true", "column");
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }
      HOperatorSet.SmallestRectangle1(ho_sliceRectRegionsROI, out hv_Row1sliceRect, 
          out hv_Col1sliceRect, out hv_Row2sliceRect, out hv_Col2sliceRect);
      ho_sliceRectRegionsROI.Dispose();
      HOperatorSet.GenRectangle1(out ho_sliceRectRegionsROI, hv_Row1sliceRect, hv_Col1sliceRect, 
          hv_Row1sliceRect, hv_Col2sliceRect);
      ho_sliceRectRegionsROIRaw.Dispose();
      HOperatorSet.Connection(ho_sliceRectRegionsROI, out ho_sliceRectRegionsROIRaw
          );


      //如果同一区域超出15个点,剔除最靠近上方的5个点
      ho_sliceobjRectsssssssRemoved.Dispose();
      HOperatorSet.GenEmptyObj(out ho_sliceobjRectsssssssRemoved);
      HTuple end_val66 = hv_numberOfNoTabRegion;
      HTuple step_val66 = 1;
      for (hv_subindex=1; hv_subindex.Continue(end_val66, step_val66); hv_subindex = hv_subindex.TupleAdd(step_val66))
      {
        ho_objNoTabRegionRect.Dispose();
        HOperatorSet.SelectObj(ho_BatteryNoTabRegionsRect, out ho_objNoTabRegionRect, 
            hv_subindex);
        ho_sliceRectobjNoTabRegions.Dispose();
        HOperatorSet.Intersection(ho_objNoTabRegionRect, ho_sliceRectRegionsROIRaw, 
            out ho_sliceRectobjNoTabRegions);
        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.Connection(ho_sliceRectobjNoTabRegions, out ExpTmpOutVar_0);
        ho_sliceRectobjNoTabRegions.Dispose();
        ho_sliceRectobjNoTabRegions = ExpTmpOutVar_0;
        }
        HOperatorSet.SmallestRectangle1(ho_sliceRectobjNoTabRegions, out hv_Row1SLobjNoTab, 
            out hv_Col1SLobjNoTab, out hv_Row2SLobjNoTab, out hv_Col2SLobjNoTab);
        hv_lenofRow1SLobjNoTab = new HTuple(hv_Row1SLobjNoTab.TupleLength());
        if ((int)(new HTuple(hv_lenofRow1SLobjNoTab.TupleGreater(15))) != 0)
        {
          HOperatorSet.TupleSortIndex(hv_Row1SLobjNoTab, out hv_Row1SLobjNoTabPLine);
          HOperatorSet.TupleSelectRange(hv_Row1SLobjNoTabPLine, 0, (hv_lenofRow1SLobjNoTab/7)-1, 
              out hv_Row1SLobjNoTabPLine);
          hv_Row1SLobjNoTabPLIndex = hv_Row1SLobjNoTabPLine+1;
          ho_sliceobjRectRemoved.Dispose();
          HOperatorSet.SelectObj(ho_sliceRectobjNoTabRegions, out ho_sliceobjRectRemoved, 
              hv_Row1SLobjNoTabPLIndex);
          {
          HObject ExpTmpOutVar_0;
          HOperatorSet.ConcatObj(ho_sliceobjRectsssssssRemoved, ho_sliceobjRectRemoved, 
              out ExpTmpOutVar_0);
          ho_sliceobjRectsssssssRemoved.Dispose();
          ho_sliceobjRectsssssssRemoved = ExpTmpOutVar_0;
          }
        }
      }
      {
      HObject ExpTmpOutVar_0;
      HOperatorSet.Difference(ho_sliceRectRegionsROI, ho_sliceobjRectsssssssRemoved, 
          out ExpTmpOutVar_0);
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROI = ExpTmpOutVar_0;
      }



      //11.以tab为界限,分别拟合直线?不行，如果相差比较远会得到很奇怪的拟合线
      ho_RegionLinesFit.Dispose();
      HOperatorSet.GenEmptyObj(out ho_RegionLinesFit);
      hv_Values = new HTuple();
      hv_Values[0] = 0;
      hv_Values[1] = 0;
      hv_Values[2] = 0;
      hv_Values[3] = 0;
      hv_isideTab = 2;
      //* for isideTab := 0 to 1 by 1
      //gen_empty_obj (sliceRectRegionsROISide)
      //if (isideTab=0)
        //concat_obj (sliceRectRegionsROISide, defineInnerRectsLeft, sliceRectRegionsROISide)
      //elseif (isideTab=1)
        //concat_obj (sliceRectRegionsROISide, defineInnerRectsRight, sliceRectRegionsROISide)
      //else
        //concat_obj (sliceRectRegionsROISide, defineInnerRects, sliceRectRegionsROISide)
      //endif
      //intersection (sliceRectRegionsROI, sliceRectRegionsROISide, sliceRectRegionsROISide)
      ho_sliceRectRegionsROISide.Dispose();
      HOperatorSet.SortRegion(ho_sliceRectRegionsROI, out ho_sliceRectRegionsROISide, 
          "upper_left", "true", "column");
      HOperatorSet.SmallestRectangle1(ho_sliceRectRegionsROISide, out hv_Row1sliceRect, 
          out hv_Col1sliceRect, out hv_Row2sliceRect, out hv_Col2sliceRect);

      hv_len = new HTuple(hv_Row2sliceRect.TupleLength());
      HOperatorSet.CreateMatrix(hv_len, 1, hv_Row2sliceRect, out hv_y);
      HOperatorSet.CreateMatrix(hv_len, 2, 1, out hv_x);
      hv_xxxx = new HTuple();
      HTuple end_val105 = hv_len-1;
      HTuple step_val105 = 1;
      for (hv_idxxxx=0; hv_idxxxx.Continue(end_val105, step_val105); hv_idxxxx = hv_idxxxx.TupleAdd(step_val105))
      {
        if (hv_xxxx == null)
          hv_xxxx = new HTuple();
        hv_xxxx[hv_idxxxx] = hv_idxxxx;
      }
      HOperatorSet.SetValueMatrix(hv_x, hv_xxxx, HTuple.TupleGenConst(hv_len,0), 
          hv_Col2sliceRect);

      HOperatorSet.MultMatrix(hv_x, hv_x, "ATB", out hv_xtx);
      HOperatorSet.MultMatrix(hv_x, hv_y, "ATB", out hv_xty);

      HOperatorSet.InvertMatrix(hv_xtx, "general", 0, out hv_invxtx);
      HOperatorSet.MultMatrix(hv_invxtx, hv_xty, "AB", out hv_beta);
      HOperatorSet.GetFullMatrix(hv_beta, out hv_Valueside);

      if (hv_Values == null)
        hv_Values = new HTuple();
      hv_Values[(hv_isideTab*2)+0] = hv_Valueside.TupleSelect(0);
      if (hv_Values == null)
        hv_Values = new HTuple();
      hv_Values[(hv_isideTab*2)+1] = hv_Valueside.TupleSelect(1);
      hv_towPointsCol = new HTuple();
      hv_towPointsCol = hv_towPointsCol.TupleConcat(hv_Col1RectOut);
      hv_towPointsCol = hv_towPointsCol.TupleConcat(hv_Col2RectOut);
      //if (isideTab=0)
        //towPointsCol := [300,Col1Tab[1]]
      //elseif (isideTab=1)
        //towPointsCol := [Col2Tab[0],Col2Tab[1]+700]
      //else
        //isideTab := 0
        //Values[isideTab*2+0] := Valueside[0]
        //Values[isideTab*2+1] := Valueside[1]
        //towPointsCol := [300,Col2Tab[1]+700]
      //endif

      hv_Newy = ((hv_Values.TupleSelect((hv_isideTab*2)+0))*hv_towPointsCol)+(hv_Values.TupleSelect(
          (hv_isideTab*2)+1));

      ho_ContoursliceRectRegionsROI.Dispose();
      HOperatorSet.GenContourPolygonXld(out ho_ContoursliceRectRegionsROI, hv_Newy, 
          hv_towPointsCol);
      HOperatorSet.FitLineContourXld(ho_ContoursliceRectRegionsROI, "gauss", -1, 
          0, 5, 1, out hv_RowBegin, out hv_ColBegin, out hv_RowEnd, out hv_ColEnd, 
          out hv_Nr, out hv_Nc, out hv_Dist);
      ho_RegionLinesFitSide.Dispose();
      HOperatorSet.GenRegionLine(out ho_RegionLinesFitSide, hv_RowBegin, hv_ColBegin, 
          hv_RowEnd, hv_ColEnd);
      hv_Phi = (((hv_RowEnd-hv_RowBegin)/(hv_ColEnd-hv_ColBegin))).TupleAtan();
      ho_SelectedRegionsS.Dispose();
      ho_BatteryNoTabRegionsOut.Dispose();
      ho_BatteryNoTabRegionsRect.Dispose();
      ho_sliceRectRegions.Dispose();
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROIRaw.Dispose();
      ho_sliceobjRectsssssssRemoved.Dispose();
      ho_objNoTabRegionRect.Dispose();
      ho_sliceRectobjNoTabRegions.Dispose();
      ho_sliceobjRectRemoved.Dispose();
      ho_RegionLinesFit.Dispose();
      ho_sliceRectRegionsROISide.Dispose();
      ho_ContoursliceRectRegionsROI.Dispose();

      return;
    }
    catch (HalconException HDevExpDefaultException)
    {
      ho_SelectedRegionsS.Dispose();
      ho_BatteryNoTabRegionsOut.Dispose();
      ho_BatteryNoTabRegionsRect.Dispose();
      ho_sliceRectRegions.Dispose();
      ho_sliceRectRegionsROI.Dispose();
      ho_sliceRectRegionsROIRaw.Dispose();
      ho_sliceobjRectsssssssRemoved.Dispose();
      ho_objNoTabRegionRect.Dispose();
      ho_sliceRectobjNoTabRegions.Dispose();
      ho_sliceobjRectRemoved.Dispose();
      ho_RegionLinesFit.Dispose();
      ho_sliceRectRegionsROISide.Dispose();
      ho_ContoursliceRectRegionsROI.Dispose();

      throw HDevExpDefaultException;
    }
  }

  public void Cartridge_Edge_Insp_Protrusion (HObject ho_Image, HTuple hv_WindowHandle, 
      HTuple hv_t, HTuple hv_Row, HTuple hv_Column, HTuple hv_Transition, HTuple hv_Select, 
      HTuple hv_RoiWidthLen2, out HTuple hv_Row_Result, out HTuple hv_Column_Result)
  {




    // Local iconic variables 

    // Local control variables 

    HTuple hv_tuple = null, hv_i = null, hv_LineRowStart = new HTuple();
    HTuple hv_LineColumnStart = new HTuple(), hv_LineRowEnd = new HTuple();
    HTuple hv_LineColumnEnd = new HTuple(), hv_AmpThreshold = new HTuple();
    HTuple hv_Sigma = new HTuple(), hv_Distance_Measure_01_0 = new HTuple();
    // Initialize local and output iconic variables 
    hv_Row_Result = new HTuple();
    hv_Column_Result = new HTuple();
    hv_tuple = new HTuple();
    for (hv_i=30; (int)hv_i>=30; hv_i = (int)hv_i + -5)
    {


      //**************************注意这个地方的修改***************************************
      hv_LineRowStart = hv_Row-hv_t;
      hv_LineColumnStart = hv_Column.Clone();
      hv_LineRowEnd = hv_Row+hv_t;
      hv_LineColumnEnd = hv_Column.Clone();
      //**********************************************************************************

      if (HDevWindowStack.IsOpen())
      {
        HOperatorSet.DispObj(ho_Image, HDevWindowStack.GetActive());
      }
      HOperatorSet.DispLine(hv_WindowHandle, hv_LineRowStart, hv_LineColumnStart, 
          hv_LineRowEnd, hv_LineColumnEnd);


      //参数
      //measure pos threshold
      hv_AmpThreshold = hv_i.Clone();
      //measure pos ROiLen2
      //RoiWidthLen2 := 25
      //measure pos sigma
      hv_Sigma = 1;
      //**********Transition有三种模式： 'all', 'negative', 'positive'  ***************
      //Transition := 'all'
      //**********Select有三种模式： 'all', 'first', 'last'  ****************
      //Select := 'all'
      LineFindPoints_Protrusion(ho_Image, hv_LineRowStart, hv_LineRowEnd, hv_LineColumnStart, 
          hv_LineColumnEnd, hv_RoiWidthLen2, hv_Sigma, hv_AmpThreshold, hv_Select, 
          hv_Transition, hv_WindowHandle, out hv_Row_Result, out hv_Column_Result, 
          out hv_Distance_Measure_01_0);

      if ((int)(new HTuple((new HTuple(hv_Row_Result.TupleLength())).TupleGreater(
          0))) != 0)
      {

        hv_tuple = hv_tuple.TupleConcat(hv_Row_Result);
        if ((int)(new HTuple(hv_Select.TupleEqual("first"))) != 0)
        {
          HOperatorSet.TupleMin(hv_tuple, out hv_Row_Result);
        }
        else
        {
          HOperatorSet.TupleMax(hv_tuple, out hv_Row_Result);
        }


      }



    }

    return;
  }

  public void LineFindPoints_Protrusion (HObject ho_Image, HTuple hv_LineRowStart, 
      HTuple hv_LineRowEnd, HTuple hv_LineColumnStart, HTuple hv_LineColumnEnd, HTuple hv_RoiWidthLen2, 
      HTuple hv_Sigma, HTuple hv_AmpThreshold, HTuple hv_Select, HTuple hv_Transition, 
      HTuple hv_WindowHandle, out HTuple hv_Row_Result, out HTuple hv_Column_Result, 
      out HTuple hv_Distance_Measure_01_0)
  {




    // Local iconic variables 

    HObject ho_Rectangle2, ho_ImageReduced, ho_Image5;

    // Local control variables 

    HTuple hv_TmpCtrl_Row = null, hv_TmpCtrl_Column = null;
    HTuple hv_TmpCtrl_Dr = null, hv_TmpCtrl_Dc = null, hv_TmpCtrl_Phi = null;
    HTuple hv_TmpCtrl_Len1 = null, hv_TmpCtrl_Len2 = null;
    HTuple hv_Width = null, hv_Height = null, hv_MsrHandle_Measure_01_0 = null;
    HTuple hv_Amplitude_Measure_01_0 = null;
    // Initialize local and output iconic variables 
    HOperatorSet.GenEmptyObj(out ho_Rectangle2);
    HOperatorSet.GenEmptyObj(out ho_ImageReduced);
    HOperatorSet.GenEmptyObj(out ho_Image5);
    try
    {
      hv_TmpCtrl_Row = 0.5*(hv_LineRowStart+hv_LineRowEnd);
      hv_TmpCtrl_Column = 0.5*(hv_LineColumnStart+hv_LineColumnEnd);
      hv_TmpCtrl_Dr = hv_LineRowStart-hv_LineRowEnd;
      hv_TmpCtrl_Dc = hv_LineColumnEnd-hv_LineColumnStart;
      hv_TmpCtrl_Phi = hv_TmpCtrl_Dr.TupleAtan2(hv_TmpCtrl_Dc);
      hv_TmpCtrl_Len1 = 0.5*((((hv_TmpCtrl_Dr*hv_TmpCtrl_Dr)+(hv_TmpCtrl_Dc*hv_TmpCtrl_Dc))).TupleSqrt()
          );
      hv_TmpCtrl_Len2 = hv_RoiWidthLen2.Clone();
      ho_Rectangle2.Dispose();
      HOperatorSet.GenRectangle2(out ho_Rectangle2, hv_TmpCtrl_Row, hv_TmpCtrl_Column, 
          hv_TmpCtrl_Phi, hv_TmpCtrl_Len1, hv_TmpCtrl_Len2);
      ho_ImageReduced.Dispose();
      HOperatorSet.ReduceDomain(ho_Image, ho_Rectangle2, out ho_ImageReduced);
      //emphasize (ImageReduced, Image, 15, 15, 1)
      HOperatorSet.GetImageSize(ho_Image, out hv_Width, out hv_Height);
      HOperatorSet.GenMeasureRectangle2(hv_TmpCtrl_Row, hv_TmpCtrl_Column, hv_TmpCtrl_Phi, 
          hv_TmpCtrl_Len1, hv_TmpCtrl_Len2, hv_Width, hv_Height, "nearest_neighbor", 
          out hv_MsrHandle_Measure_01_0);
      ho_Image5.Dispose();
      HOperatorSet.CopyObj(ho_Image, out ho_Image5, 1, 1);
      //1, 8, 'all', 'all',
      HOperatorSet.MeasurePos(ho_Image5, hv_MsrHandle_Measure_01_0, hv_Sigma, hv_AmpThreshold, 
          hv_Transition, hv_Select, out hv_Row_Result, out hv_Column_Result, out hv_Amplitude_Measure_01_0, 
          out hv_Distance_Measure_01_0);
      HOperatorSet.DispCross(hv_WindowHandle, hv_Row_Result, hv_Column_Result, 30, 
          hv_TmpCtrl_Phi);
      HOperatorSet.CloseMeasure(hv_MsrHandle_Measure_01_0);
      ho_Rectangle2.Dispose();
      ho_ImageReduced.Dispose();
      ho_Image5.Dispose();

      return;
    }
    catch (HalconException HDevExpDefaultException)
    {
      ho_Rectangle2.Dispose();
      ho_ImageReduced.Dispose();
      ho_Image5.Dispose();

      throw HDevExpDefaultException;
    }
  }

  public void Battery_In_or_Out_Tray_White_Insp_Special (HObject ho_Image, HTuple hv_WindowHandle, 
      HTuple hv_Main_InterFace, HTuple hv_Tuple, HTuple hv_Empty_Main_InterFace, HTuple hv_InterFace, 
      out HTuple hv_bBatteryFinalResultRet)
  {




    // Stack for temporary objects 
    HObject[] OTemp = new HObject[20];

    // Local iconic variables 

    HObject ho_Rectangle=null, ho_ImageReduced=null;

    // Local copy input parameter variables 
    HObject ho_Image_COPY_INP_TMP;
    ho_Image_COPY_INP_TMP = ho_Image.CopyObj(1,-1);



    // Local control variables 

    HTuple hv_Row1 = new HTuple(), hv_Col1 = new HTuple();
    HTuple hv_Col2 = new HTuple(), hv_Mean = new HTuple();
    HTuple hv_Deviation = new HTuple(), hv_Exception = null;
    // Initialize local and output iconic variables 
    HOperatorSet.GenEmptyObj(out ho_Rectangle);
    HOperatorSet.GenEmptyObj(out ho_ImageReduced);
    hv_bBatteryFinalResultRet = new HTuple();
    try
    {

      try
      {
        if ((int)(new HTuple(((hv_Tuple.TupleSelect(2))).TupleNotEqual(2))) != 0)
        {
          ho_Image_COPY_INP_TMP.Dispose();
          ho_Rectangle.Dispose();
          ho_ImageReduced.Dispose();

          return;
        }
        else
        {
        }
        //******************初始化输出变量**********************
        //***是否有电池（1表示有，否则无）
        hv_bBatteryFinalResultRet = 0;



        {
        HObject ExpTmpOutVar_0;
        HOperatorSet.RotateImage(ho_Image_COPY_INP_TMP, out ExpTmpOutVar_0, (hv_Main_InterFace.TupleSelect(
            2))*57.3, "constant");
        ho_Image_COPY_INP_TMP.Dispose();
        ho_Image_COPY_INP_TMP = ExpTmpOutVar_0;
        }




        //**********************************************（一）检测有无电芯存在*******************************
        hv_Row1 = (((((hv_Main_InterFace.TupleSelect(0))-(hv_Empty_Main_InterFace.TupleSelect(
            11)))+(hv_Empty_Main_InterFace.TupleSelect(4)))-((hv_InterFace.TupleSelect(
            13))/(hv_InterFace.TupleSelect(14))))+(hv_Main_InterFace.TupleSelect(
            4)))+50;
        hv_Col1 = (((hv_Main_InterFace.TupleSelect(1))-(hv_Empty_Main_InterFace.TupleSelect(
            12)))+(hv_Empty_Main_InterFace.TupleSelect(2)))-((hv_Empty_Main_InterFace.TupleSelect(
            0))-(hv_Empty_Main_InterFace.TupleSelect(1)));
        hv_Col2 = ((hv_Main_InterFace.TupleSelect(1))-(hv_Empty_Main_InterFace.TupleSelect(
            12)))+(hv_Empty_Main_InterFace.TupleSelect(2));
        ho_Rectangle.Dispose();
        HOperatorSet.GenRectangle1(out ho_Rectangle, hv_Row1, hv_Col1, hv_Row1+50, 
            hv_Col2);
        ho_ImageReduced.Dispose();
        HOperatorSet.ReduceDomain(ho_Image_COPY_INP_TMP, ho_Rectangle, out ho_ImageReduced
            );
        HOperatorSet.Intensity(ho_ImageReduced, ho_ImageReduced, out hv_Mean, out hv_Deviation);
        if ((int)(new HTuple(hv_Mean.TupleLess(100))) != 0)
        {
          hv_bBatteryFinalResultRet = 1;
        }
        else
        {
          hv_bBatteryFinalResultRet = 0;
        }
      }
      // catch (Exception) 
      catch (HalconException HDevExpDefaultException1)
      {
        HDevExpDefaultException1.ToHTuple(out hv_Exception);
        hv_bBatteryFinalResultRet = 0;
      }

      ho_Image_COPY_INP_TMP.Dispose();
      ho_Rectangle.Dispose();
      ho_ImageReduced.Dispose();

      return;
    }
    catch (HalconException HDevExpDefaultException)
    {
      ho_Image_COPY_INP_TMP.Dispose();
      ho_Rectangle.Dispose();
      ho_ImageReduced.Dispose();

      throw HDevExpDefaultException;
    }
  }

    private bool inited = false;

    private HTuple hv_Empty_Main_InterFace = new HTuple();
    private HTuple hv_bMasterFinalResultRet = new HTuple();

    // Main procedure 
    public int actionTray(string product, Byte[] bmp, long width, long height, int index, out double x, out double y, out double a, string name)
    {
        x = 0;
        y = 0;
        a = 0;
        // Stack for temporary objects 
        HObject[] OTemp = new HObject[20];

    // Local iconic variables 

    HObject ho_Image=null;

        // Local control variables 
        IntPtr p_bmp = IntPtr.Zero;

    HTuple hv_WindowHandle = new HTuple(), hv_Tray_length = new HTuple();
    HTuple hv_Tray_width = new HTuple(), hv_Cartridge_Height = new HTuple();
    HTuple hv_Distance_Cartridge_Protrusion_to_Left_Edge = new HTuple();
    HTuple hv_Distance_Cartridge_Protrusion_to_Right_Edge = new HTuple();
    HTuple hv_Distance_Cartridge_to_Tray_Left = new HTuple();
    HTuple hv_Distance_Each_of_Cartridge_H = new HTuple();
    HTuple hv_Distance_Each_of_Cartridge_V = new HTuple();
    HTuple hv_Width_Connected_area = new HTuple(), hv_Distance_Connected_area_Bottom_to_Protrusion = new HTuple();
    HTuple hv_Cartridge_Number = new HTuple(), hv_Tray_Row_U = new HTuple();
    HTuple hv_Tray_Row_L = new HTuple(), hv_Tray_Row_D = new HTuple();
    HTuple hv_Tray_Col_R = new HTuple(), hv_Tray_Row_Up = new HTuple();
    HTuple hv_Tray_Row_Left = new HTuple(), hv_Tray_Row_Down = new HTuple();
    HTuple hv_Tray_Col_Right = new HTuple(), hv_Dis_Col_Offset_D = new HTuple();
    HTuple hv_Dis_Row_Edge_Offset = new HTuple(), hv_Dis_Row_Protrusion_Offset = new HTuple();
    HTuple hv_Dis_Row_Edge_L_Offset = new HTuple(), hv_Dis_Row_Edge_R_Offset = new HTuple();
    HTuple hv_Dis_Row_Edge_U_Offset = new HTuple(), hv_Col_Top_L = new HTuple();
    HTuple hv_Col_Top_R = new HTuple(), hv_Dis_Col_Edge_Top = new HTuple();
    HTuple hv_Threshold_Tray_Edge = new HTuple(), hv_Threshold_Cartridge_Edge_LR_Min = new HTuple();
    HTuple hv_Threshold_Cartridge_Edge_LR_Max = new HTuple();
    HTuple hv_width_Battery_body = new HTuple(), hv_height_Battery_body = new HTuple();
    HTuple hv_Pixel_scale = new HTuple(), hv_InterFace = new HTuple();
    HTuple hv_InterFace_Tray = new HTuple(), hv_InterFace_Offset = new HTuple();
    HTuple hv_InterFace_Top = new HTuple(), hv_InterFace_Threshold = new HTuple();
    HTuple hv_Empty_Main_InterFace = new HTuple(), hv_bMasterFinalResultRet = new HTuple();
    HTuple hv_MsgL = new HTuple();
    HTuple hv_M = new HTuple();
    HTuple hv_N = new HTuple(), hv_P = new HTuple(), hv_i = new HTuple();
    HTuple hv_Tuple = new HTuple(), hv_bFinalEdge = new HTuple();
    HTuple hv_InterFace_Edge_Param = new HTuple(), hv_Main_InterFace = new HTuple();
    HTuple hv_InterFace_Top_New = new HTuple(), hv_bBatteryFinalResultRet = new HTuple();
    HTuple hv_bMisalignmentFinalResultRet = new HTuple(), hv_bB = new HTuple();
    HTuple hv_bM = new HTuple();
    // Initialize local and output iconic variables 
    HOperatorSet.GenEmptyObj(out ho_Image);
    try
    {
            //***********************************************（零）全局变量*************************************************************************
            //*************************料盘(Tray)本体参数(实际长度【mm】)*************************
            //********Tray_width指沿着极耳的宽度（即和极耳方向平行）
            hv_Tray_length = 278.0;
        hv_Tray_width = 298.0;

        //**料盒(Cartridge)的高度mm
        hv_Cartridge_Height = 136;

        //**料盒突出部分（Cartridge protrusion）分别距料盒左右侧边缘的距离mm
        hv_Distance_Cartridge_Protrusion_to_Left_Edge = 19;
        hv_Distance_Cartridge_Protrusion_to_Right_Edge = 19;

        //**料盒右侧到料盘边缘的距离(Cartridge_to_Tray_Left)mm
        hv_Distance_Cartridge_to_Tray_Left = 22;

        //***料盒之间的距离(Each_of_Cartridge)(水平方向Horizontal和竖直方向Vertical)【mm】
        hv_Distance_Each_of_Cartridge_H = 15;
        hv_Distance_Each_of_Cartridge_V = 8;
        //**连通区域宽度mm
        hv_Width_Connected_area = 18.5;
        //**连通区域底部到料盒突出部分的距离mm
        hv_Distance_Connected_area_Bottom_to_Protrusion = 51;

        //******料盒（Cartridge）的数量
        hv_Cartridge_Number = 4;


        //****料盘边界矩形位置的选择（获取转正图像的所需的合适的矩形）pixel
        //***上侧矩形
        hv_Tray_Row_U = 850;
        hv_Tray_Row_L = 900;
        hv_Tray_Row_D = 925;
        hv_Tray_Col_R = 1080;

        //**右侧矩形
        hv_Tray_Row_Up = 1150;
        hv_Tray_Row_Left = 1480;
        hv_Tray_Row_Down = 1240;
        hv_Tray_Col_Right = 1550;

        //*******料盒下边界的列补偿（pixel）（目的为了避免不平的地方造成误差）中心为0，左负（-）右正（+）
        hv_Dis_Col_Offset_D = 125;
        //*********寻找料盒左右边界（pixel）补偿(>=20)(竖直方向移动)
        hv_Dis_Row_Edge_Offset = 30;
        //*********寻找料盒Protrusion边界（pixel）补偿 (>=10)
        hv_Dis_Row_Protrusion_Offset = 25;





        //**************左右边界以检测补偿（pixel）(一般不超过10)  左负（-）右正（+） *****************
        hv_Dis_Row_Edge_L_Offset = -25;
        hv_Dis_Row_Edge_R_Offset = 15;
        //**************上边界检测补偿（pixel）(一般大于25)   上负（-）下正（+）*****
        hv_Dis_Row_Edge_U_Offset = -35;



        //**********************顶部矩形选择的补偿（pixel）列坐标
        hv_Col_Top_L = 290;
        hv_Col_Top_R = 675;
        //******Dis_Col_Edge_U_Offset取电池宽度的1/5~1/4
        hv_Dis_Col_Edge_Top = 75;


        //**********阈值选择处理处理*******************
        hv_Threshold_Tray_Edge = 90;
        hv_Threshold_Cartridge_Edge_LR_Min = 140;
        hv_Threshold_Cartridge_Edge_LR_Max = 255;


        //******电池型号相关信息mm************
        hv_width_Battery_body = 98;
        hv_height_Battery_body = 117;


        //******单像素实际大小【mm】****************
        hv_Pixel_scale = 0.18819;


        hv_InterFace = new HTuple();
        hv_InterFace = hv_InterFace.TupleConcat(hv_Tray_length);
        hv_InterFace = hv_InterFace.TupleConcat(hv_Tray_width);
        hv_InterFace = hv_InterFace.TupleConcat(hv_Cartridge_Height);
        hv_InterFace = hv_InterFace.TupleConcat(hv_Distance_Cartridge_Protrusion_to_Left_Edge);
        hv_InterFace = hv_InterFace.TupleConcat(hv_Distance_Cartridge_Protrusion_to_Right_Edge);
        hv_InterFace = hv_InterFace.TupleConcat(hv_Distance_Cartridge_to_Tray_Left);
        hv_InterFace = hv_InterFace.TupleConcat(hv_Distance_Each_of_Cartridge_H);
        hv_InterFace = hv_InterFace.TupleConcat(hv_Distance_Each_of_Cartridge_V);
        hv_InterFace = hv_InterFace.TupleConcat(hv_Width_Connected_area);
        hv_InterFace = hv_InterFace.TupleConcat(hv_Cartridge_Number);
        hv_InterFace = hv_InterFace.TupleConcat(hv_Tray_Row_U);
        hv_InterFace = hv_InterFace.TupleConcat(hv_Tray_Col_Right);
        hv_InterFace = hv_InterFace.TupleConcat(hv_width_Battery_body);
        hv_InterFace = hv_InterFace.TupleConcat(hv_height_Battery_body);
        hv_InterFace = hv_InterFace.TupleConcat(hv_Pixel_scale);
        hv_InterFace = hv_InterFace.TupleConcat(hv_Distance_Connected_area_Bottom_to_Protrusion);



        hv_InterFace_Tray = new HTuple();
        hv_InterFace_Tray = hv_InterFace_Tray.TupleConcat(hv_Tray_Row_U);
        hv_InterFace_Tray = hv_InterFace_Tray.TupleConcat(hv_Tray_Row_L);
        hv_InterFace_Tray = hv_InterFace_Tray.TupleConcat(hv_Tray_Row_D);
        hv_InterFace_Tray = hv_InterFace_Tray.TupleConcat(hv_Tray_Col_R);
        hv_InterFace_Tray = hv_InterFace_Tray.TupleConcat(hv_Tray_Row_Up);
        hv_InterFace_Tray = hv_InterFace_Tray.TupleConcat(hv_Tray_Row_Left);
        hv_InterFace_Tray = hv_InterFace_Tray.TupleConcat(hv_Tray_Row_Down);
        hv_InterFace_Tray = hv_InterFace_Tray.TupleConcat(hv_Tray_Col_Right);

        hv_InterFace_Offset = new HTuple();
        hv_InterFace_Offset = hv_InterFace_Offset.TupleConcat(hv_Dis_Col_Offset_D);
        hv_InterFace_Offset = hv_InterFace_Offset.TupleConcat(hv_Dis_Row_Edge_Offset);
        hv_InterFace_Offset = hv_InterFace_Offset.TupleConcat(hv_Dis_Row_Protrusion_Offset);
        hv_InterFace_Offset = hv_InterFace_Offset.TupleConcat(hv_Dis_Row_Edge_L_Offset);
        hv_InterFace_Offset = hv_InterFace_Offset.TupleConcat(hv_Dis_Row_Edge_R_Offset);
        hv_InterFace_Offset = hv_InterFace_Offset.TupleConcat(hv_Dis_Row_Edge_U_Offset);

        hv_InterFace_Top = new HTuple();
        hv_InterFace_Top = hv_InterFace_Top.TupleConcat(hv_Col_Top_L);
        hv_InterFace_Top = hv_InterFace_Top.TupleConcat(hv_Col_Top_R);
        hv_InterFace_Top = hv_InterFace_Top.TupleConcat(hv_Dis_Col_Edge_Top);

        hv_InterFace_Threshold = new HTuple();
        hv_InterFace_Threshold = hv_InterFace_Threshold.TupleConcat(hv_Threshold_Tray_Edge);
        hv_InterFace_Threshold = hv_InterFace_Threshold.TupleConcat(hv_Threshold_Cartridge_Edge_LR_Min);
        hv_InterFace_Threshold = hv_InterFace_Threshold.TupleConcat(hv_Threshold_Cartridge_Edge_LR_Max);

            //*********************************************（一）通过空料盒获取料盘边界所需坐标以及关系（不同型号料盘只需要检测一次）***************************

            if (!inited)
            {
                string templatefilename = "D:/Picture/template/" + product + ".bmp";
                ho_Image.Dispose();
                HOperatorSet.ReadImage(out ho_Image, templatefilename);
                {
                    HObject ExpTmpOutVar_0;
                    HOperatorSet.RotateImage(ho_Image, out ExpTmpOutVar_0, -90, "constant");
                    ho_Image.Dispose();
                    ho_Image = ExpTmpOutVar_0;
                }

                if (HDevWindowStack.IsOpen())
                {
                    HOperatorSet.CloseWindow(HDevWindowStack.Pop());
                }

                dev_open_window_fit_image(ho_Image, 0, 0, -1, -1, out hv_WindowHandle);
                if (HDevWindowStack.IsOpen())
                {
                    HOperatorSet.DispObj(ho_Image, HDevWindowStack.GetActive());
                }

                if (HDevWindowStack.IsOpen())
                {
                    HOperatorSet.SetDraw(HDevWindowStack.GetActive(), "margin");
                }

                Empty_Tray_Segmentation_White_for_All(ho_Image, hv_WindowHandle, hv_InterFace,
                hv_InterFace_Tray, hv_InterFace_Offset, hv_InterFace_Threshold, out hv_Empty_Main_InterFace, out hv_bMasterFinalResultRet);
                inited = true;
                if (null != ho_Image)
                {
                    ho_Image.Dispose();
                }
            }
  




  

      //**********************************************（二）检测**************************************************************************************


      if ((int)(new HTuple(hv_bMasterFinalResultRet.TupleEqual(1))) != 0)
      {
        if (HDevWindowStack.IsOpen())
        {
          HOperatorSet.DispObj(ho_Image, HDevWindowStack.GetActive());
        }
        if (hv_MsgL == null)
          hv_MsgL = new HTuple();
        hv_MsgL[13] = "母版中未找到所需的参数";
        if ((int)(new HTuple(hv_bMasterFinalResultRet.TupleEqual(0))) != 0)
        {
        }
        else
        {
          disp_message(hv_WindowHandle, hv_MsgL.TupleSelect(13), "window", 100, 120, 
              "red", "true");
        }
      }
      else
      {
          //*****************M：表示料盘每行对应的列位置(即列数);N：表示对应的行数; *******************
          //************eg:[M,N]=[3,2]表示第2行第3个料盒***
          //*****Q:表示读取照片的顺序
          //***********初始化拍照次数***********
  
          if (index == 0)
          {
            hv_M = 1;
            hv_N = 2;
            hv_P = 2;
          }
          else if (index == 1)
                {
            hv_M = new HTuple();
            hv_M[0] = 1;
            hv_M[1] = 2;
            hv_M[2] = 2;
            hv_N = new HTuple();
            hv_N[0] = 1;
            hv_N[1] = 1;
            hv_N[2] = 2;
            hv_P = new HTuple();
            hv_P[0] = 0;
            hv_P[1] = 0;
            hv_P[2] = 0;
          }
          else if (index == 2)
                {

            hv_M = 1;
            hv_N = 2;
            hv_P = 1;
          }
          else if (index == 3)
                {
            hv_M = 1;
            hv_N = 1;
            hv_P = 1;
          }
          else if (index == 4)
                {
            hv_M = new HTuple();
            hv_M[0] = 2;
            hv_M[1] = 2;
            hv_N = new HTuple();
            hv_N[0] = 1;
            hv_N[1] = 2;
            hv_P = new HTuple();
            hv_P[0] = 1;
            hv_P[1] = 1;
          }
          else
          {
            hv_M = 0;
            hv_N = 0;
            hv_P = 0;
          }

          //Q := ['1','2','3','4']
          ho_Image.Dispose();

                int size = bmp.Length;
                p_bmp = Marshal.AllocHGlobal(size);
                Marshal.Copy(bmp, 0, p_bmp, size);
                HTuple aaa = new HTuple(p_bmp);
                HOperatorSet.GenImage1Extern(out ho_Image, "byte", width, height, aaa, 0);
                //HOperatorSet.GenImage1(out ho_Image, "byte", width, height, aaa);
                {
          HObject ExpTmpOutVar_0;
          HOperatorSet.RotateImage(ho_Image, out ExpTmpOutVar_0, -90, "constant");
          ho_Image.Dispose();
          ho_Image = ExpTmpOutVar_0;
          }
          //ImageRoot := Files_AR+Q
          //t := 0
          for (hv_i=0; (int)hv_i<=(int)((new HTuple(hv_M.TupleLength()))-1); hv_i = (int)hv_i + 1)
          {
            hv_Tuple = new HTuple();
            hv_Tuple = hv_Tuple.TupleConcat(hv_M.TupleSelect(
                hv_i));
            hv_Tuple = hv_Tuple.TupleConcat(hv_N.TupleSelect(
                hv_i));
            hv_Tuple = hv_Tuple.TupleConcat(hv_P.TupleSelect(
                hv_i));
            //read_image (Image, ImageRoot[i])
            if ((int)(new HTuple(((hv_Tuple.TupleSelect(0))).TupleEqual(0))) != 0)
            {
              break;
            }
            //count_seconds (Seconds)
            //*************（1）检测前的准备工作*****************************************************
            //*************获取料盘的参数*******
            Battery_Edge_Insp(ho_Image, hv_InterFace_Tray, hv_InterFace_Threshold, 
                hv_i, hv_Tuple, out hv_bFinalEdge, out hv_InterFace_Edge_Param);
            //count_seconds (Seconds1)
            //t := t+Seconds1-Seconds
            //********P=0 进入Battery_In_or_Out_Tray_White_Insp*******
            //********P=2 进入Battery_In_or_Out_Tray_White_Insp_Special*******
            //********P=1 进入Tray_Positioning_Wht_and_Wht_Insp*******
            if ((int)(new HTuple(hv_bFinalEdge.TupleEqual(1))) != 0)
            {
              if (hv_MsgL == null)
                hv_MsgL = new HTuple();
              hv_MsgL[12] = new HTuple("电池边界未找到,料盒被弹出或无效拍照");
              break;
            }
            Battery_and_Tray_Insp_Preparation(ho_Image, hv_WindowHandle, hv_Empty_Main_InterFace, 
                hv_InterFace_Tray, hv_InterFace, hv_Tuple, hv_InterFace_Offset, hv_InterFace_Edge_Param, 
                hv_InterFace_Top, out hv_Main_InterFace, out hv_InterFace_Top_New);
            //*************（2）一般情况下，检测空料盘内是否有电池存在（下面这两个函数一般不会同时存在）********
            Battery_In_or_Out_Tray_White_Insp(ho_Image, hv_WindowHandle, hv_Main_InterFace, 
                hv_Tuple, out hv_bBatteryFinalResultRet);
            //******************特殊情况下，检测空料盘内是否有电池存在***********
            Battery_In_or_Out_Tray_White_Insp_Special(ho_Image, hv_WindowHandle, 
                hv_Main_InterFace, hv_Tuple, hv_Empty_Main_InterFace, hv_InterFace, 
                out hv_bBatteryFinalResultRet);
            //*************（3）检测放料后电池是否错位********
            Tray_Positioning_Wht_and_Wht_Insp(ho_Image, hv_WindowHandle, hv_Main_InterFace, 
                hv_Tuple, hv_InterFace_Offset, hv_InterFace_Top_New, hv_InterFace, 
                hv_InterFace_Threshold, hv_Empty_Main_InterFace, out hv_bMisalignmentFinalResultRet);

            //count_seconds (Seconds1)
            //t := t+Seconds1-Seconds


            //****************************************（三）异常处理**************************************************************************************
            if (HDevWindowStack.IsOpen())
            {
              HOperatorSet.DispObj(ho_Image, HDevWindowStack.GetActive());
            }
            if (hv_MsgL == null)
              hv_MsgL = new HTuple();
            hv_MsgL[00] = "料盒中无电池";
            if (hv_MsgL == null)
              hv_MsgL = new HTuple();
            hv_MsgL[01] = "料盒中有电池";
            if (hv_MsgL == null)
              hv_MsgL = new HTuple();
            hv_MsgL[10] = "电池完全放入料盒";
            if (hv_MsgL == null)
              hv_MsgL = new HTuple();
            hv_MsgL[11] = "电池未完全放入料盒";
            if (hv_MsgL == null)
              hv_MsgL = new HTuple();
            hv_MsgL[12] = new HTuple("电池边界未找到,料盒被弹出或无效拍照");
            if ((int)((new HTuple(((hv_P.TupleSelect(hv_i))).TupleEqual(0))).TupleOr(
                new HTuple(((hv_P.TupleSelect(hv_i))).TupleEqual(2)))) != 0)
            {
              if ((int)(new HTuple(hv_bBatteryFinalResultRet.TupleEqual(1))) != 0)
              {
                if (hv_bB == null)
                  hv_bB = new HTuple();
                hv_bB[hv_i] = 1;
              }
              else
              {
                if (hv_bB == null)
                  hv_bB = new HTuple();
                hv_bB[hv_i] = 0;
              }
            }
            else
            {
              if ((int)(new HTuple(hv_bMisalignmentFinalResultRet.TupleEqual(1))) != 0)
              {
                if (hv_bM == null)
                  hv_bM = new HTuple();
                hv_bM[hv_i] = 1;
              }
              else
              {
                if (hv_bM == null)
                  hv_bM = new HTuple();
                hv_bM[hv_i] = 0;
              }
            }

          }
          if ((int)(new HTuple(((hv_Tuple.TupleSelect(0))).TupleNotEqual(0))) != 0)
          {
            if ((int)(new HTuple(hv_bFinalEdge.TupleEqual(1))) != 0)
            {
              disp_message(hv_WindowHandle, hv_MsgL.TupleSelect(12), "window", 70, 
                  120, "red", "true");
            }
            else
            {
              for (hv_i=0; (int)hv_i<=(int)((new HTuple(hv_M.TupleLength()))-1); hv_i = (int)hv_i + 1)
              {
                if ((int)((new HTuple(((hv_P.TupleSelect(hv_i))).TupleEqual(0))).TupleOr(
                    new HTuple(((hv_P.TupleSelect(hv_i))).TupleEqual(2)))) != 0)
                {
                  if ((int)(new HTuple(((hv_bB.TupleSelect(hv_i))).TupleEqual(0))) != 0)
                  {
                    disp_message(hv_WindowHandle, ((((("第"+(hv_N.TupleSelect(hv_i)))+"排")+"第")+(hv_M.TupleSelect(
                        hv_i)))+"列")+(hv_MsgL.TupleSelect(00)), "window", 100+(30*hv_i), 
                        120, "blue", "true");
                  }
                  else
                  {
                    disp_message(hv_WindowHandle, ((((("第"+(hv_N.TupleSelect(hv_i)))+"排")+"第")+(hv_M.TupleSelect(
                        hv_i)))+"列")+(hv_MsgL.TupleSelect(01)), "window", 100+(30*hv_i), 
                        120, "red", "true");
                  }
                }
                else
                {
                  if ((int)(new HTuple(((hv_bM.TupleSelect(hv_i))).TupleEqual(0))) != 0)
                  {
                    disp_message(hv_WindowHandle, ((((("第"+(hv_N.TupleSelect(hv_i)))+"排")+"第")+(hv_M.TupleSelect(
                        hv_i)))+"列")+(hv_MsgL.TupleSelect(10)), "window", 100+(30*hv_i), 
                        120, "blue", "true");
                  }
                  else
                  {
                    disp_message(hv_WindowHandle, ((((("第"+(hv_N.TupleSelect(hv_i)))+"排")+"第")+(hv_M.TupleSelect(
                        hv_i)))+"列")+(hv_MsgL.TupleSelect(11)), "window", 100+(30*hv_i), 
                        120, "red", "true");
                  }
                }
                //disp_message (WindowHandle, t, 'window', 190, 120, 'red', 'true')
              }
            }
          }
          else
          {
          }

                

                //dump_window_image (ImageN, WindowHandle)
                //get_system_time (MSecond, Second, Minute, Hour, Day, YDay, Month, Year)

                //t := Hour+'_'+Minute+'_'+Second+'_'+MSecond
                //ImageResult := 'E:/自动上下料机/料盒/Result/'
                //ImageResult := ImageResult+t
                //write_image (ImageN, 'bmp', 0, ImageResult)

                //stop ()


            }
    }
    catch (HalconException)
    {
            if (0 < name.Length)
            {
                HOperatorSet.DumpWindow(hv_WindowHandle, "jpg", name);
            }

            ho_Image.Dispose();
            Marshal.FreeHGlobal(p_bmp);
            return 1;
    }

        if (0 < name.Length)
        {
            HOperatorSet.DumpWindow(hv_WindowHandle, "jpg", name);
        }

        ho_Image.Dispose();
        Marshal.FreeHGlobal(p_bmp);
        return 0;

  }
}